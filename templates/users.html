<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AZone — အသုံးပြုသူ စီမံခန့်ခွဲမှု</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        body {
            background: #0f1724;
            color: #e6eef8;
        }

        .card {
            background: rgba(255, 255, 255, 0.03);
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="mb-0"><i class="fas fa-users-cog"></i> အသုံးပြုသူ စီမံခန့်ခွဲမှု</h3>
                <small class="text-muted">အသုံးပြုသူများနှင့် အခန်းကဏ္ဍများ စီမံခန့်ခွဲရန်</small>
            </div>
            <div>
                <a href="{{ url_for('register') }}" class="btn btn-success btn-sm"><i class="fas fa-user-plus"></i>
                    အသုံးပြုသူအသစ် ဖန်တီးရန်</a>
            </div>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover" id="usersTable">
                        <thead>
                            <tr>
                                <th>အသုံးပြုသူအမည်</th>
                                <th>အီးမေးလ်</th>
                                <th>အခန်းကဏ္ဍ</th>
                                <th>ဖန်တီးသည့်ရက်စွဲ</th>
                                <th>လုပ်ဆောင်ချက်များ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr id="user-row-{{ user.id }}">
                                <td>{{ user.username }}</td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <select class="form-select form-select-sm user-role-select"
                                        data-user-id="{{ user.id }}" onchange="updateUserRole(this)">
                                        <option value="viewer" {% if user.role=='viewer' %}selected{% endif %}>ကြည့်ရှုသူ
                                        </option>
                                        <option value="editor" {% if user.role=='editor' %}selected{% endif %}>တည်းဖြတ်သူ
                                        </option>
                                        <option value="owner" {% if user.role=='owner' %}selected{% endif %}>ပိုင်ရှင်
                                        </option>
                                    </select>
                                </td>
                                <td>{{ user.created_at }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-primary" onclick="editUser('{{ user.id }}')"><i
                                                class="fas fa-edit"></i> ပြင်ဆင်ရန်</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user.id }}')"><i
                                                class="fas fa-trash"></i> ဖျက်ရန်</button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Edit modal (simple) -->
        <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content bg-dark text-light">
                    <div class="modal-header">
                        <h5 class="modal-title">အသုံးပြုသူ ပြင်ဆင်ရန်</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editUserForm" onsubmit="saveUserEdit(event)">
                            <input type="hidden" id="editUserId">
                            <div class="mb-3"><label class="form-label">အသုံးပြုသူအမည်</label><input id="editUsername"
                                    class="form-control"></div>
                            <div class="mb-3"><label class="form-label">အီးမေးလ်</label><input id="editEmail"
                                    class="form-control"></div>
                            <div class="mb-3"><label class="form-label">အခန်းကဏ္ဍ</label>
                                <select id="editRole" class="form-select">
                                    <option value="viewer">ကြည့်ရှုသူ</option>
                                    <option value="editor">တည်းဖြတ်သူ</option>
                                    <option value="owner">ပိုင်ရှင်</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ပယ်ဖျက်ရန်</button>
                                <button type="submit" class="btn btn-primary">သိမ်းဆည်းရန်</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Safe fetch wrapper
        async function safeFetch(url, opts) {
            try { const res = await fetch(url, opts); if (!res.ok) throw await res.text(); return await res.json(); }
            catch (err) { console.error('Fetch error', url, err); alert('Server error: ' + (err && err.toString ? err.toString() : err)); return null; }
        }

        // Update role when select changes
        async function updateUserRole(selectEl) {
            const userId = selectEl.dataset.userId;
            const role = selectEl.value;
            const data = await safeFetch('/users/' + encodeURIComponent(userId) + '/role', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ role }) });
            if (data && data.success) { console.log('Role updated', userId, role); }
        }

        function editUser(userId) {
            // find row values
            const row = document.getElementById('user-row-' + userId);
            if (!row) return;
            const username = row.children[0].textContent.trim();
            const email = row.children[1].textContent.trim();
            const roleSelect = row.querySelector('.user-role-select');
            const role = roleSelect ? roleSelect.value : 'viewer';
            document.getElementById('editUserId').value = userId;
            document.getElementById('editUsername').value = username;
            document.getElementById('editEmail').value = email;
            document.getElementById('editRole').value = role;
            const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
            modal.show();
        }

        async function saveUserEdit(e) {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('editUsername').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const role = document.getElementById('editRole').value;
            const data = await safeFetch('/users/' + encodeURIComponent(id) + '/update', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username, email, role }) });
            if (data && data.success) {
                // update row visually
                const row = document.getElementById('user-row-' + id);
                if (row) { row.children[0].textContent = username; row.children[1].textContent = email; const roleSel = row.querySelector('.user-role-select'); if (roleSel) roleSel.value = role; }
                bootstrap.Modal.getInstance(document.getElementById('editUserModal'))?.hide();
            }
        }

        async function deleteUser(userId) {
            if (!confirm('အသုံးပြုသူကို ဖျက်ရန် သေချာပါသလား? ဤလုပ်ဆောင်ချက်ကို ပြန်လည်ပြုပြင်နိုင်မည် မဟုတ်ပါ။')) return;
            const data = await safeFetch('/users/' + encodeURIComponent(userId) + '/delete', { method: 'POST' });
            if (data && data.success) { const row = document.getElementById('user-row-' + userId); if (row) row.remove(); }
        }
    </script>
</body>

</html>