<!doctype html>
<html lang="my">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AZone Bot Builder Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/form-validation.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/loading-feedback.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-responsive.css') }}">
    <script>
        // Prevent flash of light mode - apply dark mode immediately
        (function() {
            const savedTheme = localStorage.getItem('azone-theme');
            if (savedTheme !== 'light') {
                document.documentElement.classList.add('dark-mode-pref');
                if (document.body) {
                    document.body.classList.remove('light-mode');
                }
            }
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #0E121F;
            background-attachment: fixed;
            min-height: 100vh;
            color: #F0F4F8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: rgba(14, 18, 31, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 20px 0;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.5), inset -1px 0 0 rgba(99, 199, 255, 0.1);
            border-right: 1px solid rgba(99, 199, 255, 0.2);
            pointer-events: auto;
            transition: transform 0.3s ease, width 0.3s ease;
        }
        
        .sidebar.collapsed {
            width: 80px;
        }
        
        .sidebar-brand {
            padding: 25px 20px;
            color: #63C7FF;
            font-size: 1.4rem;
            font-weight: 700;
            text-align: center;
            border-bottom: 2px solid rgba(99, 199, 255, 0.3);
            margin-bottom: 25px;
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            transition: all 0.3s ease;
        }
        
        .sidebar-brand i {
            color: #63C7FF;
            margin-right: 8px;
            -webkit-text-fill-color: #63C7FF;
            filter: drop-shadow(0 0 8px rgba(99, 199, 255, 0.5));
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            margin: 5px 10px;
        }
        
        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: #B0B0B0;
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            border-radius: 8px;
            margin-bottom: 5px;
            position: relative;
            z-index: 1001;
            pointer-events: auto;
            cursor: pointer;
            overflow: hidden;
        }
        
        .sidebar-nav a::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: linear-gradient(180deg, #63C7FF 0%, #A855F7 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .sidebar-nav a:focus {
            outline: 2px solid rgba(99, 199, 255, 0.5);
            outline-offset: 2px;
        }
        
        .sidebar-nav a:hover {
            background: rgba(99, 199, 255, 0.1);
            color: #63C7FF;
            border-left-color: #63C7FF;
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.2);
        }
        
        .sidebar-nav a:hover::before {
            transform: scaleY(1);
        }
        
        .sidebar-nav a.active {
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            color: #63C7FF;
            border-left-color: #63C7FF;
            box-shadow: 0 4px 20px rgba(99, 199, 255, 0.3), inset 0 0 20px rgba(99, 199, 255, 0.1);
        }
        
        .sidebar-nav a.active::before {
            transform: scaleY(1);
        }
        
        .sidebar-nav a i {
            width: 22px;
            margin-right: 12px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .sidebar-nav a:hover i,
        .sidebar-nav a.active i {
            filter: drop-shadow(0 0 6px rgba(99, 199, 255, 0.6));
            transform: scale(1.1);
        }
        
        /* Templates menu item special styling - wider and more detailed */
        .sidebar-nav .nav-item-templates {
            min-width: 100%;
            padding: 15px 20px 15px 20px !important;
            font-weight: 500;
            position: relative;
            width: 100%;
        }
        
        .sidebar-nav .nav-item-templates:hover {
            padding-left: 25px !important;
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%) !important;
        }
        
        .sidebar-nav .nav-item-templates:hover .nav-arrow {
            right: 10px !important;
            opacity: 1 !important;
            transform: translateX(3px);
        }
        
        .sidebar-nav .nav-item-templates.active {
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.2) 0%, rgba(168, 85, 247, 0.2) 100%) !important;
            font-weight: 600;
        }
        
        .sidebar-nav .nav-item-templates.active .nav-arrow {
            opacity: 1 !important;
            color: #63C7FF !important;
        }
        
        .sidebar-nav .nav-item-templates .fa-layer-group {
            margin-right: 15px;
            font-size: 1.2rem;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 40px;
            min-height: 100vh;
        }
        
        /* AZone Logo styling */
        .azone-logo-header {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .azone-logo-img {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.35);
        }
        
        .azone-logo-text {
            display: flex;
            flex-direction: column;
        }
        
        .bot-builder-card {
            background: rgba(14, 18, 31, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(99, 199, 255, 0.1);
            padding: 40px;
            border: 1px solid rgba(99, 199, 255, 0.2);
        }
        
        .bot-builder-card h2 {
            color: #63C7FF;
            margin-bottom: 15px;
            font-weight: 700;
            text-shadow: 0 0 20px rgba(99, 199, 255, 0.3);
        }
        
        .bot-builder-card h2 i {
            color: #A855F7;
            margin-right: 10px;
            filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.5));
        }
        
        .bot-builder-card .text-muted {
            color: #a0a0a0 !important;
        }
        
        .form-label {
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }
        
        .form-label i {
            color: #A855F7;
            margin-right: 8px;
            filter: drop-shadow(0 0 6px rgba(168, 85, 247, 0.5));
        }
        
        .form-control, .form-select {
            background: rgba(14, 18, 31, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 199, 255, 0.3);
            color: #F0F4F8;
            padding: 12px 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            background: rgba(14, 18, 31, 0.9);
            border-color: #63C7FF;
            color: #FFFFFF;
            box-shadow: 0 0 0 3px rgba(99, 199, 255, 0.2), 0 0 20px rgba(99, 199, 255, 0.3);
            outline: none;
        }
        
        .form-control::placeholder {
            color: #888;
        }
        
        .form-text {
            color: #888 !important;
        }
        
        .btn-add-step {
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            border: none;
            color: white;
            padding: 14px 35px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4), 0 0 20px rgba(99, 199, 255, 0.2);
        }
        
        .btn-add-step:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
            background: linear-gradient(135deg, #A855F7 0%, #63C7FF 100%);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4), 0 0 20px rgba(99, 199, 255, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #A855F7 0%, #63C7FF 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
        }
        
        .btn-outline-secondary {
            border-color: rgba(99, 199, 255, 0.4);
            color: #63C7FF;
            background: transparent;
        }
        
        .btn-outline-secondary:hover {
            background: rgba(99, 199, 255, 0.1);
            border-color: #63C7FF;
            color: #FFFFFF;
            box-shadow: 0 0 20px rgba(99, 199, 255, 0.3);
        }
        
        .card {
            background: rgba(14, 18, 31, 0.6) !important;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(99, 199, 255, 0.2) !important;
            border-radius: 16px !important;
            color: #F0F4F8;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(99, 199, 255, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            border-color: rgba(99, 199, 255, 0.4) !important;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(99, 199, 255, 0.2), 0 0 30px rgba(99, 199, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .card-header {
            background: rgba(99, 199, 255, 0.1) !important;
            border-bottom: 1px solid rgba(99, 199, 255, 0.2) !important;
            color: #63C7FF !important;
            font-weight: 600;
        }
        
        .alert {
            border-radius: 12px;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border-left: 4px solid #10b981;
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-left: 4px solid #ef4444;
        }
        
        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border-left: 4px solid #f59e0b;
        }
        
        .btn-outline-danger {
            border-color: rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        
        .btn-outline-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #fff;
        }
        
        /* Table Styling for My Bots */
        .table-dark {
            background: rgba(14, 18, 31, 0.6) !important;
            backdrop-filter: blur(10px);
            border-color: rgba(99, 199, 255, 0.2) !important;
        }
        
        .table-dark thead th {
            background: rgba(99, 199, 255, 0.15) !important;
            border-color: rgba(99, 199, 255, 0.3) !important;
            color: #63C7FF !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }
        
        .table-dark tbody tr {
            border-color: rgba(99, 199, 255, 0.1) !important;
            transition: all 0.3s ease;
        }
        
        .table-dark tbody tr:hover {
            background: rgba(99, 199, 255, 0.1) !important;
            transform: translateX(5px);
            box-shadow: inset 4px 0 0 rgba(99, 199, 255, 0.5);
        }
        
        .table-dark td {
            color: #F0F4F8 !important;
            vertical-align: middle;
        }
        
        .table-dark .badge {
            font-size: 0.85rem;
            padding: 0.4rem 0.8rem;
        }
        
        .table-dark .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }
        
        /* Scrollbar Styling */
        .sidebar::-webkit-scrollbar {
            width: 10px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: rgba(14, 18, 31, 0.5);
            border-radius: 10px;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(99, 199, 255, 0.4) 0%, rgba(168, 85, 247, 0.4) 100%);
            border-radius: 10px;
            border: 2px solid rgba(14, 18, 31, 0.5);
            box-shadow: 0 0 10px rgba(99, 199, 255, 0.3);
        }
        
        .sidebar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(99, 199, 255, 0.6) 0%, rgba(168, 85, 247, 0.6) 100%);
            box-shadow: 0 0 15px rgba(99, 199, 255, 0.5);
        }
        
        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 380px;
            height: 500px;
            background: rgba(14, 18, 31, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(99, 199, 255, 0.3);
            border: 1px solid rgba(99, 199, 255, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 999;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .chat-widget.minimized {
            height: 60px;
        }
        
        .chat-widget-header {
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(99, 199, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .chat-widget-header h6 {
            color: #63C7FF;
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 0 10px rgba(99, 199, 255, 0.3);
        }
        
        .chat-widget-header h6 i {
            color: #A855F7;
            filter: drop-shadow(0 0 8px rgba(168, 85, 247, 0.5));
        }
        
        .chat-widget-toggle {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
            padding: 5px;
        }
        
        .chat-widget-toggle:hover {
            color: #fff;
        }
        
        .chat-widget-close {
            background: none;
            border: none;
            color: #b0b0b0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
            padding: 5px;
            z-index: 1000;
            position: relative;
        }
        
        .chat-widget-close:hover {
            color: #ff4444;
            transform: scale(1.1);
        }
        
        .chat-widget-close:active {
            transform: scale(0.95);
        }
        
        .chat-widget.hidden {
            display: none !important;
        }
        
        .chat-widget-show-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            border: none;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4), 0 0 20px rgba(99, 199, 255, 0.2);
            z-index: 998;
            font-size: 1.5rem;
        }
        
        .chat-widget-show-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
            background: linear-gradient(135deg, #A855F7 0%, #63C7FF 100%);
        }
        
        .chat-widget-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .chat-message {
            display: flex;
            flex-direction: column;
            gap: 5px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-message.user {
            align-items: flex-end;
        }
        
        .chat-message.bot {
            align-items: flex-start;
        }
        
        .chat-message-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .chat-message.user .chat-message-bubble {
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            color: #fff;
            border-bottom-right-radius: 4px;
            box-shadow: 0 2px 10px rgba(99, 199, 255, 0.3);
        }
        
        .chat-message.bot .chat-message-bubble {
            background: rgba(14, 18, 31, 0.8);
            backdrop-filter: blur(10px);
            color: #F0F4F8;
            border: 1px solid rgba(99, 199, 255, 0.2);
            border-bottom-left-radius: 4px;
        }
        
        .chat-message-time {
            font-size: 0.75rem;
            color: #888;
            padding: 0 5px;
        }
        
        .chat-widget-input-container {
            padding: 15px 20px;
            border-top: 1px solid rgba(99, 199, 255, 0.2);
            background: rgba(14, 18, 31, 0.5);
        }
        
        .chat-widget-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .chat-widget-input {
            flex: 1;
            background: rgba(14, 18, 31, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(99, 199, 255, 0.3);
            color: #F0F4F8;
            padding: 12px 15px;
            border-radius: 25px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .chat-widget-input:focus {
            outline: none;
            border-color: #63C7FF;
            box-shadow: 0 0 0 3px rgba(99, 199, 255, 0.2), 0 0 20px rgba(99, 199, 255, 0.3);
        }
        
        .chat-widget-input::placeholder {
            color: rgba(176, 176, 176, 0.6);
        }
        
        .chat-widget-send-btn {
            background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);
            border: none;
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4), 0 0 20px rgba(99, 199, 255, 0.2);
        }
        
        .chat-widget-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
            background: linear-gradient(135deg, #A855F7 0%, #63C7FF 100%);
        }
        
        .chat-widget-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .chat-widget-body::-webkit-scrollbar {
            width: 10px;
        }
        
        .chat-widget-body::-webkit-scrollbar-track {
            background: rgba(14, 18, 31, 0.5);
            border-radius: 10px;
        }
        
        .chat-widget-body::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(99, 199, 255, 0.4) 0%, rgba(168, 85, 247, 0.4) 100%);
            border-radius: 10px;
            border: 2px solid rgba(14, 18, 31, 0.5);
            box-shadow: 0 0 10px rgba(99, 199, 255, 0.3);
        }
        
        .chat-widget-body::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(99, 199, 255, 0.6) 0%, rgba(168, 85, 247, 0.6) 100%);
            box-shadow: 0 0 15px rgba(99, 199, 255, 0.5);
        }
        
        .chat-empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #888;
            text-align: center;
            padding: 20px;
        }
        
        .chat-empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }
        
        /* Visual Flow Builder Styles */
        .flow-node {
            position: absolute;
            min-width: 150px;
            cursor: move;
            z-index: 10;
        }
        
        .flow-node-content {
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.9) 0%, rgba(168, 85, 247, 0.9) 100%);
            border: 2px solid rgba(99, 199, 255, 0.5);
            border-radius: 12px;
            padding: 15px 20px;
            text-align: center;
            color: white;
            box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4), 0 0 20px rgba(99, 199, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .flow-node-content:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6), 0 0 30px rgba(168, 85, 247, 0.4);
        }
        
        .flow-node.selected .flow-node-content {
            border-color: #ffd700;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
        }
        
        .flow-node-start .flow-node-content {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.9) 0%, rgba(22, 163, 74, 0.9) 100%);
        }
        
        .flow-node-message .flow-node-content {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
        }
        
        .flow-node-question .flow-node-content {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.9) 0%, rgba(245, 158, 11, 0.9) 100%);
        }
        
        .flow-node-api_call .flow-node-content {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(124, 58, 237, 0.9) 100%);
        }
        
        .flow-node-webhook .flow-node-content {
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.9) 0%, rgba(219, 39, 119, 0.9) 100%);
        }
        
        .flow-node-label {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .flow-node-actions {
            position: absolute;
            top: -10px;
            right: -10px;
            display: flex;
            gap: 5px;
        }
        
        .flow-node-action-btn {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }
        
        .flow-node-action-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }
        
        .flow-node-edit-btn {
            background: rgba(59, 130, 246, 0.9);
        }
        
        .flow-node-edit-btn:hover {
            background: rgba(59, 130, 246, 1);
        }
        
        .flow-connection-line {
            stroke: rgba(99, 199, 255, 0.6);
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }
        
        .flow-node-connector {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(99, 199, 255, 0.8);
            border: 2px solid white;
            cursor: crosshair;
            z-index: 20;
            box-shadow: 0 0 10px rgba(99, 199, 255, 0.5);
        }
        
        .flow-node-connector.input {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        /* Template Card Modern Styles */
        .template-card-modern {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .template-card-modern:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 199, 255, 0.3), 0 0 40px rgba(99, 199, 255, 0.1);
            border-color: rgba(99, 199, 255, 0.4) !important;
        }
        
        .template-platform-accent {
            transition: height 0.3s ease;
        }
        
        .template-card-modern:hover .template-platform-accent {
            height: 5px;
        }
        
        /* Light Mode Styles */
        body.light-mode {
            background: #F5F7FA !important;
            color: #1a1a1a !important;
        }
        
        /* Light Mode - Softer Background Colors */
        body.light-mode .card,
        body.light-mode .bot-builder-card,
        body.light-mode .jumbotron {
            background: rgba(255, 255, 255, 0.85) !important;
            border-color: rgba(99, 199, 255, 0.2) !important;
        }
        
        body.light-mode .card-header {
            background: rgba(99, 199, 255, 0.08) !important;
            border-bottom-color: rgba(99, 199, 255, 0.15) !important;
        }
        
        body.light-mode .btn-outline-light {
            border-color: rgba(99, 199, 255, 0.3) !important;
            color: #63C7FF !important;
            background: rgba(255, 255, 255, 0.9) !important;
        }
        
        body.light-mode .btn-outline-light:hover {
            background: rgba(99, 199, 255, 0.1) !important;
            border-color: #63C7FF !important;
            color: #1E40AF !important;
        }
        
        body.light-mode .alert {
            background: rgba(255, 255, 255, 0.9) !important;
        }
        
        body.light-mode .modal-content {
            background: rgba(255, 255, 255, 0.98) !important;
            border-color: rgba(99, 199, 255, 0.2) !important;
        }
        
        body.light-mode .modal-header {
            background: rgba(99, 199, 255, 0.08) !important;
            border-bottom-color: rgba(99, 199, 255, 0.15) !important;
        }
        
        body.light-mode .dropdown-menu {
            background: rgba(255, 255, 255, 0.98) !important;
            border-color: rgba(99, 199, 255, 0.2) !important;
        }
        
        body.light-mode .list-group-item {
            background: rgba(255, 255, 255, 0.85) !important;
            border-color: rgba(99, 199, 255, 0.15) !important;
        }
        
        body.light-mode .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 4px 0 30px rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .sidebar-brand {
            color: #63C7FF;
            border-bottom-color: rgba(99, 199, 255, 0.3);
        }
        
        body.light-mode .sidebar-nav a {
            color: #4a5568;
        }
        
        body.light-mode .sidebar-nav a:hover {
            background: rgba(99, 199, 255, 0.1);
            color: #63C7FF;
        }
        
        body.light-mode .sidebar-nav a.active {
            background: linear-gradient(135deg, rgba(99, 199, 255, 0.15) 0%, rgba(168, 85, 247, 0.15) 100%);
            color: #63C7FF;
        }
        
        body.light-mode .bot-builder-card,
        body.light-mode .card {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a1a;
        }
        
        body.light-mode .form-control,
        body.light-mode .form-select {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.2);
            color: #1a1a1a;
        }
        
        body.light-mode .form-control:focus,
        body.light-mode .form-select:focus {
            background: rgba(255, 255, 255, 1);
            border-color: #63C7FF;
            color: #1a1a1a;
        }
        
        body.light-mode .text-muted {
            color: #6b7280 !important;
        }
        
        body.light-mode .text-white {
            color: #1a1a1a !important;
        }
        
        body.light-mode .table-dark {
            background-color: #ffffff;
            color: #1a1a1a;
        }
        
        body.light-mode .table-dark th {
            background-color: #f3f4f6;
            color: #1a1a1a;
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .table-dark td {
            border-color: rgba(0, 0, 0, 0.05);
        }
        
        body.light-mode .template-card-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(249, 250, 251, 0.95) 100%);
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        body.light-mode .template-card-modern:hover {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 40px rgba(99, 199, 255, 0.2);
        }
        
        body.light-mode .main-content {
            background: transparent;
        }
        
        body.light-mode .azone-logo-text h4 {
            color: #1a1a1a !important;
        }
        
        body.light-mode .azone-logo-text small {
            color: #6b7280 !important;
        }
        
        /* Theme Toggle Button */
        #themeToggleBtn {
            transition: all 0.3s ease;
        }
        
        #themeToggleBtn:hover {
            transform: rotate(15deg);
        }
        
        body.light-mode #themeIcon::before {
            content: "\f185"; /* fa-sun */
        }
        
        body:not(.light-mode) #themeIcon::before {
            content: "\f186"; /* fa-moon */
        }
        
        .flow-node-connector.output {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            .main-content {
                margin-left: 0;
                padding: 20px;
            }
            .chat-widget {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
                bottom: 20px;
            }
        }
    </style>
    <script>
        /**
         * Theme Toggle Function
         */
        window.toggleTheme = function() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            if (body.classList.contains('light-mode')) {
                // Switch to dark mode
                body.classList.remove('light-mode');
                localStorage.setItem('azone-theme', 'dark');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-moon';
                }
            } else {
                // Switch to light mode
                body.classList.add('light-mode');
                localStorage.setItem('azone-theme', 'light');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        };
        
        /**
         * Load saved theme on page load - Default to dark mode
         */
        function loadTheme() {
            const savedTheme = localStorage.getItem('azone-theme');
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            
            // Default to dark mode if no preference is saved or if preference is 'dark'
            if (savedTheme === 'light') {
                body.classList.add('light-mode');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            } else {
                // Default to dark mode
                body.classList.remove('light-mode');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-moon';
                }
                // Ensure dark mode is set in localStorage if not already set
                if (!savedTheme) {
                    localStorage.setItem('azone-theme', 'dark');
                }
            }
        }
        
        // Load theme immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadTheme);
        } else {
            loadTheme();
        }
        
        // Define chat widget functions early (before HTML) to avoid reference errors
        window.toggleChatWidget = function() {
            const widget = document.getElementById('chatWidget');
            if (!widget || widget.classList.contains('hidden')) {
                return;
            }
            const icon = document.getElementById('chatToggleIcon');
            const body = document.getElementById('chatWidgetBody');
            const inputContainer = document.querySelector('.chat-widget-input-container');
            
            if (widget.classList.contains('minimized')) {
                widget.classList.remove('minimized');
                if (icon) icon.className = 'fas fa-minus';
                if (body) body.style.display = 'flex';
                if (inputContainer) inputContainer.style.display = 'block';
            } else {
                widget.classList.add('minimized');
                if (icon) icon.className = 'fas fa-plus';
                if (body) body.style.display = 'none';
                if (inputContainer) inputContainer.style.display = 'none';
            }
        };
        
        window.closeChatWidget = function() {
            const widget = document.getElementById('chatWidget');
            const showBtn = document.getElementById('chatWidgetShowBtn');
            if (widget) {
                widget.classList.add('hidden');
                widget.style.display = 'none';
            }
            if (showBtn) {
                showBtn.style.display = 'flex';
            }
        };
        
        window.showChatWidget = function() {
            const widget = document.getElementById('chatWidget');
            const showBtn = document.getElementById('chatWidgetShowBtn');
            if (widget) {
                widget.classList.remove('hidden');
                widget.style.display = 'flex';
                widget.classList.remove('minimized');
                const icon = document.getElementById('chatToggleIcon');
                const body = document.getElementById('chatWidgetBody');
                const inputContainer = document.querySelector('.chat-widget-input-container');
                if (icon) icon.className = 'fas fa-minus';
                if (body) body.style.display = 'flex';
                if (inputContainer) inputContainer.style.display = 'block';
            }
            if (showBtn) {
                showBtn.style.display = 'none';
            }
        };
        
        // Define template and view functions early (before HTML) to avoid reference errors
        // Sync bot name between form view and flow view
        window.syncBotNameToForm = function() {
            const botNameForm = document.getElementById('botName');
            const botNameFlowView = document.getElementById('botNameFlowView');
            if (botNameForm && botNameFlowView && botNameFlowView.value.trim()) {
                botNameForm.value = botNameFlowView.value.trim();
            }
        };
        
        window.syncBotNameToFlowView = function() {
            const botNameForm = document.getElementById('botName');
            const botNameFlowView = document.getElementById('botNameFlowView');
            if (botNameForm && botNameFlowView && botNameForm.value.trim()) {
                botNameFlowView.value = botNameForm.value.trim();
            }
        };
        
        window.switchToFormView = function() {
            const formContainer = document.getElementById('formViewContainer');
            const flowContainer = document.getElementById('flowViewContainer');
            const formBtn = document.getElementById('formViewBtn');
            const flowBtn = document.getElementById('flowViewBtn');
            if (formContainer) formContainer.style.display = 'block';
            if (flowContainer) flowContainer.style.display = 'none';
            if (formBtn) formBtn.classList.add('active');
            if (flowBtn) flowBtn.classList.remove('active');
            // Sync bot name from flow view to form view
            if (typeof window.syncBotNameToForm === 'function') {
                window.syncBotNameToForm();
            }
        };
        
        window.switchToFlowView = function() {
            const formContainer = document.getElementById('formViewContainer');
            const flowContainer = document.getElementById('flowViewContainer');
            const formBtn = document.getElementById('formViewBtn');
            const flowBtn = document.getElementById('flowViewBtn');
            if (formContainer) formContainer.style.display = 'none';
            if (flowContainer) flowContainer.style.display = 'block';
            if (formBtn) formBtn.classList.remove('active');
            if (flowBtn) flowBtn.classList.add('active');
            
            // Sync bot name from form view to flow view
            if (typeof window.syncBotNameToFlowView === 'function') {
                window.syncBotNameToFlowView();
            }
            
            // Sync form steps to flow if flow is empty (will be defined later)
            if (typeof syncFormToFlow === 'function' && typeof flowNodes !== 'undefined' && flowNodes.length === 0) {
                syncFormToFlow();
            }
            
            // Draw connections (will be defined later)
            if (typeof drawFlowConnections === 'function') {
                drawFlowConnections();
            }
        };
        
        window.useTemplate = async function(templateId) {
            try {
                // Fetch template details first
                const templateResponse = await fetch(`/api/templates/${templateId}/load`);
                const templateData = await templateResponse.json();
                
                if (!templateData.success || !templateData.template) {
                    throw new Error('Template not found');
                }
                
                const template = templateData.template;
                template.id = templateId; // Add template ID for bot creation
                const platform = template.platform || 'general';
                
                // Show integration flow modal (this will create the bot and connect)
                const result = await window.showIntegrationFlowModal(template, platform, templateId);
                
                if (!result || !result.botName || !result.botName.trim()) {
                    return;
                }
                
                // Bot is already created in the modal, show success and redirect
                const successMsg = `Bot "${result.botName}" ကို template မှ အောင်မြင်စွာ ဖန်တီးလိုက်ပါပြီ!${result.connected ? ' Platform connection successful!' : ''}`;
                if (window.showSuccess) {
                    window.showSuccess(successMsg);
                } else if (window.showToast) {
                    window.showToast(successMsg, 'success');
                } else if (typeof window.showAlertMessage === 'function') {
                    window.showAlertMessage(successMsg, 'success');
                } else {
                    alert(successMsg);
                }
                
                // Redirect to bot builder
                setTimeout(() => {
                    window.location.href = `/bot-builder?bot_name=${encodeURIComponent(result.botName)}`;
                }, 1500);
            } catch (error) {
                console.error('Error creating bot from template:', error);
                const errorMsg = 'Template မှ Bot ဖန်တီးရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else if (typeof window.showAlertMessage === 'function') {
                    window.showAlertMessage(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        };
        
        /**
         * Show integration flow modal with platform-specific steps
         */
        window.showIntegrationFlowModal = function(template, platform, templateId) {
            return new Promise((resolve) => {
                // Platform configuration
                const platformConfig = {
                    'facebook': {
                        name: 'Facebook',
                        icon: 'fab fa-facebook',
                        color: '#0078FF',
                        steps: [
                            { id: 'connect', name: 'Connect Facebook', icon: 'fab fa-facebook' },
                            { id: 'select_page', name: 'Select Page', icon: 'fas fa-file-alt' },
                            { id: 'webhook', name: 'Webhook Setup', icon: 'fas fa-link' },
                            { id: 'config', name: 'Configuration', icon: 'fas fa-cog' },
                            { id: 'test', name: 'Test & Activate', icon: 'fas fa-check-circle' }
                        ],
                        permissions: [
                            'Access to your Facebook Pages',
                            'Read and respond to messages',
                            'Manage Page conversations'
                        ]
                    },
                    'telegram': {
                        name: 'Telegram',
                        icon: 'fab fa-telegram',
                        color: '#0088cc',
                        steps: [
                            { id: 'connect', name: 'Connect Telegram', icon: 'fab fa-telegram' },
                            { id: 'token', name: 'Bot Token', icon: 'fas fa-key' },
                            { id: 'config', name: 'Configuration', icon: 'fas fa-cog' },
                            { id: 'test', name: 'Test & Activate', icon: 'fas fa-check-circle' }
                        ],
                        permissions: [
                            'Access to your Telegram Bot',
                            'Send and receive messages',
                            'Manage bot commands'
                        ]
                    },
                    'youtube': {
                        name: 'YouTube',
                        icon: 'fab fa-youtube',
                        color: '#FF0000',
                        steps: [
                            { id: 'connect', name: 'Connect YouTube', icon: 'fab fa-youtube' },
                            { id: 'api_key', name: 'API Key Setup', icon: 'fas fa-key' },
                            { id: 'config', name: 'Configuration', icon: 'fas fa-cog' },
                            { id: 'test', name: 'Test & Activate', icon: 'fas fa-check-circle' }
                        ],
                        permissions: [
                            'Access to YouTube Data API',
                            'Read comments and analytics',
                            'Manage channel interactions'
                        ]
                    },
                    'tiktok': {
                        name: 'TikTok',
                        icon: 'fab fa-tiktok',
                        color: '#000000',
                        steps: [
                            { id: 'connect', name: 'Connect TikTok', icon: 'fab fa-tiktok' },
                            { id: 'api_key', name: 'API Key Setup', icon: 'fas fa-key' },
                            { id: 'config', name: 'Configuration', icon: 'fas fa-cog' },
                            { id: 'test', name: 'Test & Activate', icon: 'fas fa-check-circle' }
                        ],
                        permissions: [
                            'Access to TikTok API',
                            'Read comments and analytics',
                            'Manage content interactions'
                        ]
                    },
                    'general': {
                        name: 'General',
                        icon: 'fas fa-robot',
                        color: '#63C7FF',
                        steps: [
                            { id: 'config', name: 'Configuration', icon: 'fas fa-cog' },
                            { id: 'test', name: 'Test & Activate', icon: 'fas fa-check-circle' }
                        ],
                        permissions: []
                    }
                };
                
                const config = platformConfig[platform] || platformConfig['general'];
                let currentStep = 0;
                let botName = '';
                let connected = false;
                let telegramToken = '';
                let facebookToken = '';
                
                // Create modal
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
                modal.style.zIndex = '9999';
                modal.innerHTML = `
                    <div class="modal-dialog modal-dialog-centered modal-lg" style="max-width: 700px;">
                        <div class="modal-content" style="background: linear-gradient(135deg, #0E121F 0%, #1a1f35 100%); border: 2px solid ${config.color}; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
                            <div class="modal-header" style="border-bottom: 1px solid ${config.color}; background: rgba(14, 18, 31, 0.8);">
                                <div class="d-flex align-items-center gap-3">
                                    <div style="width: 50px; height: 50px; background: ${config.color}; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                        <i class="${config.icon}" style="font-size: 24px; color: white;"></i>
                                    </div>
                                    <div>
                                        <h5 class="modal-title text-white mb-0" style="font-weight: 600;">${escapeHtml(template.name)}</h5>
                                        <span class="badge" style="background: ${config.color}; color: white; margin-top: 5px;">${config.name}</span>
                                    </div>
                                </div>
                                <button type="button" class="btn-close btn-close-white" id="closeIntegrationModal" style="filter: brightness(0) invert(1);"></button>
                            </div>
                            <div class="modal-body" style="padding: 30px;">
                                <p class="text-muted mb-4" style="font-size: 0.95rem;">${escapeHtml(template.description || '')}</p>
                                
                                <!-- Progress Steps -->
                                <div class="mb-4" id="progressSteps">
                                    ${config.steps.map((step, index) => `
                                        <div class="d-flex align-items-center mb-3" style="opacity: ${index <= currentStep ? '1' : '0.4'};">
                                            <div class="step-indicator" style="width: 40px; height: 40px; border-radius: 50%; background: ${index < currentStep ? config.color : index === currentStep ? config.color : 'rgba(255,255,255,0.1)'}; display: flex; align-items: center; justify-content: center; margin-right: 15px; border: 2px solid ${index <= currentStep ? config.color : 'rgba(255,255,255,0.2)'};">
                                                ${index < currentStep ? '<i class="fas fa-check" style="color: white;"></i>' : `<i class="${step.icon}" style="color: ${index === currentStep ? 'white' : 'rgba(255,255,255,0.5)'};"></i>`}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="color: ${index <= currentStep ? 'white' : 'rgba(255,255,255,0.5)'}; font-weight: ${index === currentStep ? '600' : '400'};">
                                                    ${step.name}
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Step Content -->
                                <div id="stepContent" style="min-height: 300px;">
                                    <!-- Content will be dynamically loaded -->
                                </div>
                            </div>
                            <div class="modal-footer" style="border-top: 1px solid ${config.color}; background: rgba(14, 18, 31, 0.8);">
                                <button type="button" class="btn btn-secondary" id="cancelIntegrationModal">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn" id="backIntegrationBtn" style="display: none; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);">
                                    <i class="fas fa-arrow-left"></i> Back
                                </button>
                                <button type="button" class="btn" id="nextIntegrationBtn" style="background: ${config.color}; color: white; border: none;">
                                    Continue <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Render step content
                function renderStep(stepIndex) {
                    const stepContent = document.getElementById('stepContent');
                    const step = config.steps[stepIndex];
                    
                    // Update progress indicators
                    document.querySelectorAll('#progressSteps .step-indicator').forEach((indicator, idx) => {
                        const stepConfig = config.steps[idx];
                        if (idx < stepIndex) {
                            indicator.style.background = config.color;
                            indicator.innerHTML = '<i class="fas fa-check" style="color: white;"></i>';
                        } else if (idx === stepIndex) {
                            indicator.style.background = config.color;
                            indicator.innerHTML = `<i class="${stepConfig.icon}" style="color: white;"></i>`;
                        } else {
                            indicator.style.background = 'rgba(255,255,255,0.1)';
                            indicator.innerHTML = `<i class="${stepConfig.icon}" style="color: rgba(255,255,255,0.5);"></i>`;
                        }
                    });
                    
                    // Update step content based on step type
                    if (step.id === 'connect') {
                        stepContent.innerHTML = `
                            <div class="text-center mb-4">
                                <div style="width: 120px; height: 120px; background: ${config.color}; border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                    <i class="${config.icon}" style="font-size: 60px; color: white;"></i>
                                </div>
                                <h4 class="text-white mb-3" style="font-weight: 600;">Connect Your ${config.name} Account</h4>
                                <p class="text-muted">Link your ${config.name} to start building your bot</p>
                            </div>
                            ${config.permissions.length > 0 ? `
                                <div class="mb-4" style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 20px;">
                                    <div class="d-flex align-items-center mb-3">
                                        <i class="fas fa-shield-alt" style="color: ${config.color}; font-size: 20px; margin-right: 10px;"></i>
                                        <h6 class="text-white mb-0" style="font-weight: 600;">Permissions We Need</h6>
                                    </div>
                                    <ul class="list-unstyled mb-0">
                                        ${config.permissions.map(perm => `
                                            <li class="mb-2" style="color: rgba(255,255,255,0.8);">
                                                <i class="fas fa-check-circle" style="color: #10b981; margin-right: 10px;"></i>
                                                ${perm}
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <div class="text-center">
                                <button type="button" class="btn btn-lg" id="connectPlatformBtn" style="background: ${config.color}; color: white; border: none; padding: 12px 40px; border-radius: 10px; font-weight: 600;">
                                    <i class="${config.icon}"></i> Connect with ${config.name}
                                </button>
                            </div>
                            <div class="text-center mt-3">
                                <small class="text-muted">By connecting, you agree to our <a href="#" style="color: ${config.color};">Terms of Service</a> and <a href="#" style="color: ${config.color};">Privacy Policy</a></small>
                            </div>
                        `;
                        
                        // Connect button handler
                        const connectBtn = document.getElementById('connectPlatformBtn');
                        if (connectBtn) {
                            connectBtn.addEventListener('click', function() {
                                // Simulate connection (in real implementation, this would call the actual API)
                                connected = true;
                                if (window.showToast) {
                                    window.showToast(`${config.name} connected successfully!`, 'success');
                                }
                                // Move to next step
                                if (currentStep < config.steps.length - 1) {
                                    currentStep++;
                                    renderStep(currentStep);
                                }
                            });
                        }
                    } else if (step.id === 'token' && platform === 'telegram') {
                        // Telegram Bot Token step
                        stepContent.innerHTML = `
                            <div class="mb-4">
                                <h5 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="${step.icon}" style="color: ${config.color};"></i> ${step.name}
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label text-white">
                                        <i class="fab fa-telegram"></i> Telegram Bot Token
                                    </label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="telegramTokenInput" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz" autofocus>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Get token from <a href="https://t.me/BotFather" target="_blank" style="color: ${config.color};">@BotFather</a> on Telegram. Send <code>/newbot</code> command.
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-white">
                                        <i class="fas fa-robot"></i> Bot Name
                                    </label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="botNameInput" placeholder="Enter bot name (မြန်မာ/English)">
                                    <small class="form-text text-muted">မြန်မာစာ သို့မဟုတ် English နှစ်မျိုးလုံး သုံးနိုင်ပါသည်</small>
                                </div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            const tokenInput = document.getElementById('telegramTokenInput');
                            const nameInput = document.getElementById('botNameInput');
                            if (tokenInput) tokenInput.focus();
                            if (nameInput && !botName) {
                                botName = template.name || '';
                                nameInput.value = botName;
                            }
                        }, 100);
                    } else if (step.id === 'select_page' && platform === 'facebook') {
                        // Facebook Page Selection step
                        stepContent.innerHTML = `
                            <div class="mb-4">
                                <h5 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="${step.icon}" style="color: ${config.color};"></i> ${step.name}
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label text-white">
                                        <i class="fab fa-facebook"></i> Facebook Page Access Token
                                    </label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="facebookTokenInput" placeholder="EAAG..." autofocus>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> Get Page Access Token from <a href="https://developers.facebook.com" target="_blank" style="color: ${config.color};">Facebook Developer Console</a>.
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-white">
                                        <i class="fas fa-robot"></i> Bot Name
                                    </label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="botNameInput" placeholder="Enter bot name (မြန်မာ/English)">
                                    <small class="form-text text-muted">မြန်မာစာ သို့မဟုတ် English နှစ်မျိုးလုံး သုံးနိုင်ပါသည်</small>
                                </div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            const tokenInput = document.getElementById('facebookTokenInput');
                            const nameInput = document.getElementById('botNameInput');
                            if (tokenInput) tokenInput.focus();
                            if (nameInput && !botName) {
                                botName = template.name || '';
                                nameInput.value = botName;
                            }
                        }, 100);
                    } else if (step.id === 'webhook' && platform === 'facebook') {
                        // Facebook Webhook Setup step
                        stepContent.innerHTML = `
                            <div class="mb-4">
                                <h5 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="${step.icon}" style="color: ${config.color};"></i> ${step.name}
                                </h5>
                                <div class="alert alert-info" style="background: rgba(13, 110, 253, 0.1); border-color: rgba(13, 110, 253, 0.3);">
                                    <i class="fas fa-info-circle"></i> <strong>Webhook URL:</strong><br>
                                    <code id="templateWebhookUrl" style="color: ${config.color};">Loading...</code>
                                    <button class="btn btn-sm btn-outline-light ms-2" onclick="copyTemplateWebhookUrl()" title="Copy Webhook URL">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <br><br>
                                    <strong>Verify Token:</strong><br>
                                    <code id="templateVerifyToken" style="color: ${config.color};">azone_bot_verify_token</code>
                                    <br><br>
                                    <small>Copy these values to your Facebook App's Webhook settings.</small>
                                </div>
                            </div>
                        `;
                        
                        // Load webhook URL for template (executed after innerHTML is set)
                        (async function() {
                            try {
                                const response = await fetch('/api/facebook/webhook-url');
                                const data = await response.json();
                                if (data.success) {
                                    const webhookUrlElement = document.getElementById('templateWebhookUrl');
                                    const verifyTokenElement = document.getElementById('templateVerifyToken');
                                    if (webhookUrlElement) {
                                        webhookUrlElement.textContent = data.webhook_url;
                                    }
                                    if (verifyTokenElement) {
                                        verifyTokenElement.textContent = data.verify_token;
                                    }
                                }
                            } catch (error) {
                                console.error('Error loading webhook URL:', error);
                                const webhookUrlElement = document.getElementById('templateWebhookUrl');
                                if (webhookUrlElement) {
                                    webhookUrlElement.textContent = window.location.origin + '/webhook/facebook';
                                }
                            }
                        })();
                    } else if (step.id === 'config') {
                        // Configuration step
                        stepContent.innerHTML = `
                            <div class="mb-4">
                                <h5 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="${step.icon}" style="color: ${config.color};"></i> ${step.name}
                                </h5>
                                <div class="mb-3">
                                    <label class="form-label text-white">
                                        <i class="fas fa-robot"></i> Bot Name
                                    </label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="botNameInput" placeholder="Enter bot name (မြန်မာ/English)" autofocus>
                                    <small class="form-text text-muted">မြန်မာစာ သို့မဟုတ် English နှစ်မျိုးလုံး သုံးနိုင်ပါသည်</small>
                                </div>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            const input = document.getElementById('botNameInput');
                            if (input) {
                                input.focus();
                                if (!botName) {
                                    botName = template.name || '';
                                    input.value = botName;
                                }
                            }
                        }, 100);
                    } else if (step.id === 'test') {
                        // Final step
                        stepContent.innerHTML = `
                            <div class="text-center mb-4">
                                <div style="width: 100px; height: 100px; background: ${config.color}; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                    <i class="fas fa-check" style="font-size: 50px; color: white;"></i>
                                </div>
                                <h4 class="text-white mb-3" style="font-weight: 600;">Ready to Activate!</h4>
                                <p class="text-muted">Your bot is configured and ready to use.</p>
                            </div>
                            <div class="mb-4" style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; padding: 20px;">
                                <h6 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="fas fa-check-circle" style="color: #10b981;"></i> What This Bot Does
                                </h6>
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2" style="color: rgba(255,255,255,0.8);">
                                        <i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>
                                        Auto-reply to common questions
                                    </li>
                                    <li class="mb-2" style="color: rgba(255,255,255,0.8);">
                                        <i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>
                                        24/7 availability
                                    </li>
                                    <li class="mb-2" style="color: rgba(255,255,255,0.8);">
                                        <i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>
                                        Smart conversation flow
                                    </li>
                                </ul>
                            </div>
                        `;
                    } else {
                        stepContent.innerHTML = `
                            <div class="text-center mb-4">
                                <h5 class="text-white mb-3" style="font-weight: 600;">
                                    <i class="${step.icon}" style="color: ${config.color};"></i> ${step.name}
                                </h5>
                                <p class="text-muted">Configure ${step.name.toLowerCase()} settings</p>
                            </div>
                        `;
                    }
                    
                    // Update navigation buttons
                    const backBtn = document.getElementById('backIntegrationBtn');
                    const nextBtn = document.getElementById('nextIntegrationBtn');
                    
                    if (backBtn) {
                        backBtn.style.display = stepIndex > 0 ? 'inline-block' : 'none';
                    }
                    
                    if (nextBtn) {
                        if (stepIndex === config.steps.length - 1) {
                            nextBtn.innerHTML = '<i class="fas fa-check"></i> Create Bot';
                            nextBtn.style.background = '#10b981';
                        } else {
                            nextBtn.innerHTML = 'Continue <i class="fas fa-arrow-right"></i>';
                            nextBtn.style.background = config.color;
                        }
                    }
                }
                
                // Navigation handlers
                const nextBtn = document.getElementById('nextIntegrationBtn');
                const backBtn = document.getElementById('backIntegrationBtn');
                const closeBtn = document.getElementById('closeIntegrationModal');
                const cancelBtn = document.getElementById('cancelIntegrationModal');
                
                nextBtn.addEventListener('click', async function() {
                    const currentStepData = config.steps[currentStep];
                    
                    if (currentStep === config.steps.length - 1) {
                        // Final step - create bot and connect
                        const nameInput = document.getElementById('botNameInput');
                        if (nameInput) {
                            botName = nameInput.value.trim();
                        }
                        if (!botName) {
                            botName = template.name || 'My Bot';
                        }
                        
                        // Create bot first
                        try {
                            const templateIdToUse = templateId || template.id;
                            const createResponse = await fetch(`/api/templates/${templateIdToUse}/create`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ bot_name: botName.trim() })
                            });
                            
                            const createData = await createResponse.json();
                            
                            if (!createData.success) {
                                throw new Error(createData.error || 'Failed to create bot');
                            }
                            
                            // Connect to platform if tokens are available
                            if (platform === 'telegram' && telegramToken) {
                                try {
                                    const connectResponse = await fetch(`/api/telegram/connect/${encodeURIComponent(botName)}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ bot_token: telegramToken })
                                    });
                                    const connectData = await connectResponse.json();
                                    if (connectData.success) {
                                        connected = true;
                                    }
                                } catch (err) {
                                    console.error('Telegram connection error:', err);
                                }
                            } else if (platform === 'facebook' && facebookToken) {
                                try {
                                    const connectResponse = await fetch(`/api/facebook/connect/${encodeURIComponent(botName)}`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ page_access_token: facebookToken })
                                    });
                                    const connectData = await connectResponse.json();
                                    if (connectData.success) {
                                        connected = true;
                                    }
                                } catch (err) {
                                    console.error('Facebook connection error:', err);
                                }
                            }
                            
                            modal.remove();
                            resolve({ botName, connected });
                        } catch (error) {
                            console.error('Error creating bot:', error);
                            if (window.showToast) {
                                window.showToast('Error creating bot: ' + error.message, 'error');
                            } else {
                                alert('Error creating bot: ' + error.message);
                            }
                        }
                    } else {
                        // Get values from current step
                        const nameInput = document.getElementById('botNameInput');
                        if (nameInput) {
                            botName = nameInput.value.trim();
                        }
                        
                        // Get tokens if in token steps
                        if (currentStepData && currentStepData.id === 'token' && platform === 'telegram') {
                            const tokenInput = document.getElementById('telegramTokenInput');
                            if (tokenInput) {
                                telegramToken = tokenInput.value.trim();
                                if (!telegramToken) {
                                    if (window.showToast) {
                                        window.showToast('Telegram bot token ထည့်သွင်းရန် လိုအပ်ပါသည်။', 'error');
                                    } else {
                                        alert('Telegram bot token ထည့်သွင်းရန် လိုအပ်ပါသည်။');
                                    }
                                    return;
                                }
                            }
                        } else if (currentStepData && currentStepData.id === 'select_page' && platform === 'facebook') {
                            const tokenInput = document.getElementById('facebookTokenInput');
                            if (tokenInput) {
                                facebookToken = tokenInput.value.trim();
                                if (!facebookToken) {
                                    if (window.showToast) {
                                        window.showToast('Facebook Page Access Token ထည့်သွင်းရန် လိုအပ်ပါသည်။', 'error');
                                    } else {
                                        alert('Facebook Page Access Token ထည့်သွင်းရန် လိုအပ်ပါသည်။');
                                    }
                                    return;
                                }
                            }
                        }
                        
                        // Move to next step
                        currentStep++;
                        renderStep(currentStep);
                    }
                });
                
                if (backBtn) {
                    backBtn.addEventListener('click', function() {
                        if (currentStep > 0) {
                            currentStep--;
                            renderStep(currentStep);
                        }
                    });
                }
                
                closeBtn.addEventListener('click', function() {
                    modal.remove();
                    resolve(null);
                });
                
                cancelBtn.addEventListener('click', function() {
                    modal.remove();
                    resolve(null);
                });
                
                // Initialize first step
                renderStep(0);
            });
        };
        
        // Load template into current form (without creating new bot)
        window.loadTemplate = async function(templateId) {
            try {
                if (window.showToast) {
                    window.showToast('Template ကို load လုပ်နေသည်...', 'info');
                }
                
                const response = await fetch(`/api/templates/${templateId}/load`);
                const data = await response.json();
                
                if (data.success && data.template) {
                    const template = data.template;
                    
                    // Load into form fields
                    const botNameInput = document.getElementById('botName') || document.getElementById('botNameFlowView');
                    const initialGreetingInput = document.getElementById('initialGreeting');
                    
                    if (botNameInput && template.name) {
                        botNameInput.value = template.name;
                        // Trigger validation
                        if (window.botFormValidator) {
                            window.botFormValidator.validateField(botNameInput.name || botNameInput.id);
                        }
                    }
                    
                    if (initialGreetingInput && template.initial_greeting) {
                        initialGreetingInput.value = template.initial_greeting;
                        // Trigger validation
                        if (window.botFormValidator) {
                            window.botFormValidator.validateField(initialGreetingInput.name || initialGreetingInput.id);
                        }
                    }
                    
                    // Load steps
                    if (template.steps && template.steps.length > 0) {
                        // Clear existing steps
                        const stepsContainer = document.querySelector('.steps-container') || document.getElementById('stepsContainer');
                        if (stepsContainer) {
                            // Remove all existing step elements
                            const existingSteps = stepsContainer.querySelectorAll('.step-item, .step-card');
                            existingSteps.forEach(step => step.remove());
                            
                            // Add steps from template
                            template.steps.forEach((step, index) => {
                                if (typeof addNewStep === 'function') {
                                    // Add step and then update its content
                                    addNewStep();
                                    // Wait a bit for step to be added, then update
                                    setTimeout(() => {
                                        const stepElements = stepsContainer.querySelectorAll('.step-item, .step-card');
                                        if (stepElements.length > index) {
                                            const stepElement = stepElements[stepElements.length - 1];
                                            // Update step content based on type
                                            const contentInput = stepElement.querySelector('textarea, input[type="text"]');
                                            if (contentInput && step.content) {
                                                contentInput.value = step.content;
                                            }
                                            // Update step type if needed
                                            const typeSelect = stepElement.querySelector('select');
                                            if (typeSelect && step.type) {
                                                typeSelect.value = step.type;
                                                // Trigger change event
                                                typeSelect.dispatchEvent(new Event('change'));
                                            }
                                        }
                                    }, 100);
                                }
                            });
                        }
                    }
                    
                    const successMsg = `Template "${template.name}" ကို form ထဲသို့ load လုပ်ပြီးပါပြီ!`;
                    if (window.showSuccess) {
                        window.showSuccess(successMsg);
                    } else if (window.showToast) {
                        window.showToast(successMsg, 'success');
                    } else {
                        alert(successMsg);
                    }
                } else {
                    throw new Error(data.error || 'Template load လုပ်ရာတွင် အမှားအယွင်း');
                }
            } catch (error) {
                console.error('Error loading template:', error);
                const errorMsg = 'Template load လုပ်ရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        };
    </script>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="sidebar-brand">
            <i class="fas fa-robot"></i> AZone Bot Builder
        </div>
        <ul class="sidebar-nav">
            <li>
                <a href="{{ url_for('bot_builder') }}" class="{% if active_menu == 'bot-builder' %}active{% endif %}">
                    <i class="fas fa-tools"></i> Bot Builder
                </a>
            </li>
            <li>
                <a href="{{ url_for('templates_page') }}" class="nav-item-templates {% if active_menu == 'templates' %}active{% endif %}" style="position: relative; padding-right: 40px;">
                    <i class="fas fa-layer-group"></i> Templates
                    <i class="fas fa-chevron-right nav-arrow" style="position: absolute; right: 15px; font-size: 0.85rem; opacity: 0.7; transition: all 0.3s ease;"></i>
                </a>
            </li>
            <li>
                <a href="{{ url_for('my_bots') }}" class="{% if active_menu == 'my-bots' %}active{% endif %}">
                    <i class="fas fa-robot"></i> My Bots
                </a>
            </li>
            <li>
                <a href="{{ url_for('analytics') }}" class="{% if active_menu == 'analytics' %}active{% endif %}">
                    <i class="fas fa-chart-bar"></i> Analytics
                </a>
            </li>
            {# Gemini Chat menu hidden - using mobile app instead #}
            {# <li>
                <a href="{{ url_for('gemini_chat_page') }}" class="{% if active_menu == 'gemini-chat' %}active{% endif %}">
                    <i class="fas fa-comments"></i> Gemini Chat
                </a>
            </li> #}
            {% if current_user and current_user.role == 'owner' %}
            <li>
                <a href="{{ url_for('user_management') }}" class="{% if active_menu == 'users' %}active{% endif %}">
                    <i class="fas fa-users-cog"></i> User Management
                </a>
            </li>
            {% endif %}
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="azone-logo-header">
                <!-- Inline SVG logo to avoid 404 -->
                <svg width="40" height="40" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" 
                     aria-hidden="true" focusable="false" 
                     style="border-radius:8px;background:#24304a;padding:6px" class="azone-logo-img">
                    <rect width="64" height="64" rx="12" fill="#172034" />
                    <path d="M16 40 L24 24 L32 40 Z" fill="#63C7FF" />
                    <circle cx="44" cy="26" r="8" fill="#A855F7" />
                </svg>
                <div class="azone-logo-text">
                    <h4 class="text-white mb-1">Welcome back, {{ current_user.username if current_user else 'Guest' }}!</h4>
                    <small class="text-muted">Role: {{ current_user.role if current_user else 'N/A' }}</small>
                </div>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <!-- Theme Toggle Button -->
                <button type="button" class="btn btn-outline-light btn-sm" id="themeToggleBtn" onclick="window.toggleTheme()" title="Dark/Light Mode Toggle">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
                <a href="{{ url_for('bot_builder') }}" class="btn btn-outline-light btn-sm">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        {% set can_edit = current_user and current_user.role in ['owner', 'editor'] %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' if category == 'success' else 'warning' }} alert-dismissible fade show" role="alert" style="margin-bottom: 20px; animation: slideDown 0.3s ease;">
                        <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i> 
                        <strong>{{ 'Success!' if category == 'success' else 'Error!' if category == 'error' else 'Warning!' }}</strong> 
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <style>
            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>

        {% if active_menu == 'bot-builder' %}
        <!-- Bot Builder View -->
        <div class="bot-builder-card">
            <h2 class="mb-4">
                <i class="fas fa-tools text-primary"></i> Bot Builder
            </h2>
            <p class="text-muted mb-4">Create and configure your chatbot with ease</p>

            {% if not can_edit %}
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-lock"></i> သင့်အကောင့်သည် Viewer အဖြစ် သတ်မှတ်ထားပါသည်။ Bot အသစ်များကို ဖန်တီးခြင်း သို့မဟုတ် ပြင်ဆင်ခြင်းများ မပြုလုပ်နိုင်ဘဲ ကြည့်ရှုခြင်းသာ လုပ်နိုင်ပါသည်။
            </div>
            {% endif %}

            <!-- Bot Template Library -->
            {% if not bot_data %}
            <div class="mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group text-info"></i> Start from Template
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Choose a pre-built template by platform:</p>
                        
                        <!-- Platform Filter Buttons -->
                        <div class="mb-3">
                            <div class="btn-group flex-wrap" role="group" id="platformFilter">
                                <button type="button" class="btn btn-sm btn-outline-primary active" data-platform="all" onclick="window.filterTemplatesByPlatform('all')">
                                    <i class="fas fa-th"></i> All Platforms
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" data-platform="telegram" onclick="window.filterTemplatesByPlatform('telegram')">
                                    <i class="fab fa-telegram"></i> Telegram
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-platform="facebook" onclick="window.filterTemplatesByPlatform('facebook')">
                                    <i class="fab fa-facebook"></i> Facebook
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-platform="youtube" onclick="window.filterTemplatesByPlatform('youtube')">
                                    <i class="fab fa-youtube"></i> YouTube
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-dark" data-platform="tiktok" onclick="window.filterTemplatesByPlatform('tiktok')">
                                    <i class="fab fa-tiktok"></i> TikTok
                                </button>
                            </div>
                        </div>
                        
                        <div class="row" id="templateCards">
                            {% if templates and templates|length > 0 %}
                                {% for t in templates %}
                                <div class="col-md-6 col-lg-4 mb-4 template-card" data-platform="{{ t.platform|default('general') }}">
                                    <div class="card template-card-modern h-100" style="background: linear-gradient(135deg, rgba(14, 18, 31, 0.95) 0%, rgba(26, 31, 53, 0.95) 100%); border: 1px solid rgba(99, 199, 255, 0.2); border-radius: 15px; transition: all 0.3s ease; overflow: hidden; position: relative;">
                                        <!-- Platform Color Accent -->
                                        <div class="template-platform-accent" style="position: absolute; top: 0; left: 0; right: 0; height: 4px; 
                                            {% if t.platform == 'telegram' %}background: linear-gradient(90deg, #0088cc 0%, #229ED9 100%);
                                            {% elif t.platform == 'facebook' %}background: linear-gradient(90deg, #0078FF 0%, #1877F2 100%);
                                            {% elif t.platform == 'youtube' %}background: linear-gradient(90deg, #FF0000 0%, #FF4444 100%);
                                            {% elif t.platform == 'tiktok' %}background: linear-gradient(90deg, #000000 0%, #333333 100%);
                                            {% else %}background: linear-gradient(90deg, #63C7FF 0%, #A855F7 100%);{% endif %}">
                                        </div>
                                        
                                        <!-- Template Image/Icon Section -->
                                        <div class="template-image-section" style="height: 180px; background: 
                                            {% if t.platform == 'telegram' %}linear-gradient(135deg, rgba(0, 136, 204, 0.2) 0%, rgba(34, 158, 217, 0.1) 100%);
                                            {% elif t.platform == 'facebook' %}linear-gradient(135deg, rgba(0, 120, 255, 0.2) 0%, rgba(24, 119, 242, 0.1) 100%);
                                            {% elif t.platform == 'youtube' %}linear-gradient(135deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 68, 68, 0.1) 100%);
                                            {% elif t.platform == 'tiktok' %}linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(51, 51, 51, 0.2) 100%);
                                            {% else %}linear-gradient(135deg, rgba(99, 199, 255, 0.2) 0%, rgba(168, 85, 247, 0.1) 100%);{% endif %}
                                            display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                            <!-- Platform Icon -->
                                            <div style="width: 100px; height: 100px; border-radius: 20px; background: 
                                                {% if t.platform == 'telegram' %}linear-gradient(135deg, #0088cc 0%, #229ED9 100%);
                                                {% elif t.platform == 'facebook' %}linear-gradient(135deg, #0078FF 0%, #1877F2 100%);
                                                {% elif t.platform == 'youtube' %}linear-gradient(135deg, #FF0000 0%, #FF4444 100%);
                                                {% elif t.platform == 'tiktok' %}linear-gradient(135deg, #000000 0%, #333333 100%);
                                                {% else %}linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);{% endif %}
                                                display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                                {% if t.platform == 'telegram' %}
                                                    <i class="fab fa-telegram" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'facebook' %}
                                                    <i class="fab fa-facebook" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'youtube' %}
                                                    <i class="fab fa-youtube" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'tiktok' %}
                                                    <i class="fab fa-tiktok" style="font-size: 50px; color: white;"></i>
                                                {% else %}
                                                    <i class="fas fa-robot" style="font-size: 50px; color: white;"></i>
                                                {% endif %}
                                            </div>
                                            <!-- Platform Badge Overlay -->
                                            <span class="badge" style="position: absolute; top: 10px; right: 10px;
                                                {% if t.platform == 'telegram' %}background: rgba(0, 136, 204, 0.9); color: white; border: 1px solid rgba(0, 136, 204, 1);
                                                {% elif t.platform == 'facebook' %}background: rgba(0, 120, 255, 0.9); color: white; border: 1px solid rgba(0, 120, 255, 1);
                                                {% elif t.platform == 'youtube' %}background: rgba(255, 0, 0, 0.9); color: white; border: 1px solid rgba(255, 0, 0, 1);
                                                {% elif t.platform == 'tiktok' %}background: rgba(0, 0, 0, 0.9); color: white; border: 1px solid rgba(255, 255, 255, 0.3);
                                                {% else %}background: rgba(99, 199, 255, 0.9); color: white; border: 1px solid rgba(99, 199, 255, 1);{% endif %}
                                                font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; backdrop-filter: blur(10px);">
                                                {% if t.platform == 'telegram' %}
                                                    <i class="fab fa-telegram"></i> Telegram
                                                {% elif t.platform == 'facebook' %}
                                                    <i class="fab fa-facebook"></i> Facebook
                                                {% elif t.platform == 'youtube' %}
                                                    <i class="fab fa-youtube"></i> YouTube
                                                {% elif t.platform == 'tiktok' %}
                                                    <i class="fab fa-tiktok"></i> TikTok
                                                {% else %}
                                                    <i class="fas fa-robot"></i> General
                                                {% endif %}
                                            </span>
                                        </div>
                                        
                                        <div class="card-body" style="padding: 20px;">
                                            <!-- Header with Title -->
                                            <div class="mb-3">
                                                <h6 class="card-title mb-1" style="color: #F0F4F8; font-weight: 600; font-size: 1.1rem; line-height: 1.3;">
                                                    {{ t.name }}
                                                </h6>
                                            </div>
                                            
                                            <!-- Description -->
                                            <p class="card-text mb-3" style="color: rgba(240, 244, 248, 0.7); font-size: 0.875rem; line-height: 1.5; min-height: 50px;">{{ t.description }}</p>
                                            
                                            <!-- Integration Guide -->
                                            {% if t.integration_guide %}
                                            <div class="mb-3">
                                                <button type="button" class="btn btn-sm" data-bs-toggle="collapse" data-bs-target="#integrationGuide{{ loop.index }}" aria-expanded="false" style="background: rgba(99, 199, 255, 0.1); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.3); border-radius: 8px; padding: 6px 12px; font-size: 0.8rem; transition: all 0.3s ease;">
                                                    <i class="fas fa-info-circle"></i> Integration Guide
                                                </button>
                                                <div class="collapse mt-2" id="integrationGuide{{ loop.index }}">
                                                    <div class="card card-body" style="background: rgba(99, 199, 255, 0.05); border: 1px solid rgba(99, 199, 255, 0.2); border-radius: 8px; color: rgba(240, 244, 248, 0.9); font-size: 0.8rem; white-space: pre-line;">{{ t.integration_guide }}</div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Action Buttons -->
                                            <div class="d-flex gap-2 mt-auto">
                                                <button type="button" class="btn btn-sm flex-fill" onclick="window.loadTemplate('{{ t.id }}')" {% if not can_edit %}disabled title="Viewer role များအတွက် Template load လုပ်ခွင့်မရှိပါ"{% endif %} style="background: rgba(99, 199, 255, 0.1); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.3); border-radius: 8px; padding: 8px 12px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(99, 199, 255, 0.2)'; this.style.borderColor='rgba(99, 199, 255, 0.5)';" onmouseout="this.style.background='rgba(99, 199, 255, 0.1)'; this.style.borderColor='rgba(99, 199, 255, 0.3)';">
                                                    <i class="fas fa-download"></i> Load
                                                </button>
                                                <button type="button" class="btn btn-sm flex-fill" onclick="window.useTemplate('{{ t.id }}')" {% if not can_edit %}disabled title="Viewer role များအတွက် Template သုံးခွင့်မရှိပါ"{% endif %} style="
                                                    {% if t.platform == 'telegram' %}background: linear-gradient(135deg, #0088cc 0%, #229ED9 100%);
                                                    {% elif t.platform == 'facebook' %}background: linear-gradient(135deg, #0078FF 0%, #1877F2 100%);
                                                    {% elif t.platform == 'youtube' %}background: linear-gradient(135deg, #FF0000 0%, #FF4444 100%);
                                                    {% elif t.platform == 'tiktok' %}background: linear-gradient(135deg, #000000 0%, #333333 100%);
                                                    {% else %}background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);{% endif %}
                                                    color: white; border: none; border-radius: 8px; padding: 8px 12px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" 
                                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';" 
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                                                    <i class="fas fa-magic"></i> Create
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center">No templates available. Click refresh to load templates.</p>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-info mt-3" onclick="window.loadTemplates()">
                            <i class="fas fa-sync"></i> Refresh Templates
                        </button>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- View Toggle Buttons -->
            <div class="mb-4">
                <div class="btn-group" role="group" aria-label="View Toggle">
                    <button type="button" class="btn btn-outline-primary active" id="formViewBtn" onclick="window.switchToFormView()">
                        <i class="fas fa-list"></i> Form View
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="flowViewBtn" onclick="window.switchToFlowView()">
                        <i class="fas fa-project-diagram"></i> Visual Flow View
                    </button>
                </div>
            </div>

            <!-- Form View Container -->
            <div id="formViewContainer">
            <!-- Bot Builder Form -->
            <form id="botBuilderForm">
                {% if bot_data %}
                <div class="alert alert-info mb-4" role="alert">
                    <i class="fas fa-info-circle"></i> Editing bot: <strong>{{ bot_data.bot_name }}</strong>
                    {% if bot_data.status %}
                        {% if bot_data.status == 'draft' %}
                            <span class="badge bg-warning text-dark ms-2">
                                <i class="fas fa-edit"></i> Draft Mode
                            </span>
                        {% elif bot_data.status == 'published' %}
                            <span class="badge bg-success ms-2">
                                <i class="fas fa-check-circle"></i> Live
                            </span>
                        {% endif %}
                    {% endif %}
                </div>
                {% endif %}
                
                <!-- Bot Name Input -->
                <div class="mb-4">
                    <label for="botName" class="form-label">
                        <i class="fas fa-tag"></i> Bot Name
                    </label>
                    <div class="d-flex align-items-center gap-2">
                        <input 
                            type="text" 
                            class="form-control form-control-lg" 
                            id="botName" 
                            name="botName" 
                            placeholder="Enter your bot name (e.g., Customer Support Bot)"
                            value="{% if bot_data %}{{ bot_data.bot_name }}{% endif %}"
                            required
                            data-validate="botName|minLength:2|maxLength:50"
                            minlength="2"
                            maxlength="50"
                        >
                        {% if bot_data and bot_data.status %}
                            {% if bot_data.status == 'draft' %}
                                <span class="badge bg-warning text-dark" style="font-size: 0.9rem; white-space: nowrap;">
                                    <i class="fas fa-edit"></i> Draft
                                </span>
                            {% elif bot_data.status == 'published' %}
                                <span class="badge bg-success" style="font-size: 0.9rem; white-space: nowrap;">
                                    <i class="fas fa-check-circle"></i> Live
                                </span>
                            {% endif %}
                        {% endif %}
                    </div>
                    <small class="form-text text-muted">Give your bot a unique and descriptive name</small>
                </div>

                <!-- Initial Greeting Textarea -->
                <div class="mb-4">
                    <label for="initialGreeting" class="form-label">
                        <i class="fas fa-comment-dots"></i> Initial Greeting
                    </label>
                    <textarea 
                        class="form-control" 
                        id="initialGreeting" 
                        name="initialGreeting" 
                        rows="4" 
                        placeholder="Enter the greeting message that your bot will send when users first interact (e.g., Hello! Welcome to our service. How can I help you today?)"
                        required
                        data-validate="minLength:10|maxLength:500"
                        minlength="10"
                        maxlength="500"
                    >{% if bot_data %}{{ bot_data.initial_greeting }}{% endif %}</textarea>
                    <small class="form-text text-muted">This message will be sent automatically when a user starts a conversation</small>
                </div>

                <!-- Add New Step Button -->
                <div class="mb-4">
                    <button type="button" class="btn btn-add-step" id="addStepBtn" {% if not can_edit %}disabled title="Viewer role များအတွက် Step ထည့်ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-plus-circle"></i> Add New Step
                    </button>
                    <small class="form-text text-muted d-block mt-2">Add conversation steps to build your bot's flow</small>
                </div>

                <!-- Steps Container (for dynamically added steps) -->
                <div id="stepsContainer" class="mt-4">
                    <!-- Steps will be added here dynamically -->
                </div>

                <!-- Submit Button -->
                <div class="mt-4 pt-4 border-top">
                    <button type="submit" class="btn btn-primary btn-lg" {% if not can_edit %}disabled title="Viewer role များအတွက် Save ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-save"></i> Save Bot Configuration
                    </button>
                    <button type="button" class="btn btn-success btn-lg ms-2" id="publishBotBtn" onclick="publishBot()" {% if not can_edit %}disabled title="Viewer role များအတွက် Publish ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-rocket"></i> Publish
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg ms-2">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
            
            <!-- Telegram Integration Section -->
            <div class="card mt-4" style="background: rgba(14, 18, 31, 0.6); border: 1px solid rgba(99, 199, 255, 0.2);">
                <div class="card-header" style="background: rgba(14, 18, 31, 0.8); border-bottom: 1px solid rgba(99, 199, 255, 0.2);">
                    <h5 class="mb-0"><i class="fab fa-telegram" style="color: #0088cc;"></i> Telegram Integration</h5>
                </div>
                <div class="card-body">
                    {% if bot_data %}
                    <div id="telegram-status-{{ bot_data.bot_name|replace(' ', '_') }}" class="mb-3">
                        <p class="text-muted mb-2">
                            Status: <span id="telegram-status-text-{{ bot_data.bot_name|replace(' ', '_') }}" class="badge bg-secondary">Checking...</span>
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">
                            <i class="fas fa-key"></i> Telegram Bot Token
                        </label>
                        <input 
                            type="text" 
                            class="form-control bg-dark text-white border-secondary" 
                            id="telegram-token-{{ bot_data.bot_name|replace(' ', '_') }}" 
                            placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
                        >
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Get token from <a href="https://t.me/BotFather" target="_blank" class="text-info">@BotFather</a> on Telegram. 
                            Send <code>/newbot</code> command to create a new bot.
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button 
                            class="btn btn-primary" 
                            onclick="connectTelegram('{{ bot_data.bot_name }}')"
                            {% if not can_edit %}disabled title="Viewer role များအတွက် Telegram connect ခွင့်မရှိပါ"{% endif %}
                        >
                            <i class="fab fa-telegram"></i> Connect to Telegram
                        </button>
                        <button 
                            class="btn btn-secondary" 
                            onclick="disconnectTelegram('{{ bot_data.bot_name }}')"
                            {% if not can_edit %}disabled title="Viewer role များအတွက် Telegram disconnect ခွင့်မရှိပါ"{% endif %}
                        >
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                        <button 
                            class="btn btn-outline-info" 
                            onclick="checkTelegramStatus('{{ bot_data.bot_name }}')"
                        >
                            <i class="fas fa-sync"></i> Refresh Status
                        </button>
                    </div>
                    <div class="alert alert-info mt-3 mb-0" role="alert" style="background: rgba(13, 110, 253, 0.1); border-color: rgba(13, 110, 253, 0.3);">
                        <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> After connecting, users can chat with your bot on Telegram by searching for your bot's username or using the /start command.
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0" role="alert" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Telegram integration is available after you create and save a bot. 
                        Please create a bot first, then come back to connect it to Telegram.
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Facebook Messenger Integration Section -->
            <div class="card mt-4" style="background: rgba(14, 18, 31, 0.6); border: 1px solid rgba(24, 119, 242, 0.2);">
                <div class="card-header" style="background: rgba(14, 18, 31, 0.8); border-bottom: 1px solid rgba(24, 119, 242, 0.2);">
                    <h5 class="mb-0"><i class="fab fa-facebook-messenger" style="color: #1877f2;"></i> Facebook Messenger Integration</h5>
                </div>
                <div class="card-body">
                    {% if bot_data %}
                    <div id="facebook-status-{{ bot_data.bot_name|replace(' ', '_') }}" class="mb-3">
                        <p class="text-muted mb-2">
                            Status: <span id="facebook-status-text-{{ bot_data.bot_name|replace(' ', '_') }}" class="badge bg-secondary">Checking...</span>
                        </p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-white">
                            <i class="fas fa-key"></i> Facebook Page Access Token
                        </label>
                        <input 
                            type="text" 
                            class="form-control bg-dark text-white border-secondary" 
                            id="facebook-token-{{ bot_data.bot_name|replace(' ', '_') }}" 
                            placeholder="EAAxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
                        >
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> Get Page Access Token from <a href="https://developers.facebook.com/apps" target="_blank" class="text-info">Facebook Developers</a>. 
                            See setup guide for detailed instructions.
                        </small>
                    </div>
                    <div class="d-flex gap-2">
                        <button 
                            class="btn btn-primary" 
                            onclick="connectFacebook('{{ bot_data.bot_name }}')"
                            {% if not can_edit %}disabled title="Viewer role များအတွက် Facebook connect ခွင့်မရှိပါ"{% endif %}
                        >
                            <i class="fab fa-facebook-messenger"></i> Connect to Facebook
                        </button>
                        <button 
                            class="btn btn-secondary" 
                            onclick="disconnectFacebook('{{ bot_data.bot_name }}')"
                            {% if not can_edit %}disabled title="Viewer role များအတွက် Facebook disconnect ခွင့်မရှိပါ"{% endif %}
                        >
                            <i class="fas fa-unlink"></i> Disconnect
                        </button>
                        <button 
                            class="btn btn-outline-info" 
                            onclick="checkFacebookStatus('{{ bot_data.bot_name }}')"
                        >
                            <i class="fas fa-sync"></i> Refresh Status
                        </button>
                    </div>
                    <div class="alert alert-info mt-3 mb-0" role="alert" style="background: rgba(24, 119, 242, 0.1); border-color: rgba(24, 119, 242, 0.3);">
                        <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> After connecting, configure webhook URL in Facebook Developer Console: 
                        <code id="facebookWebhookUrl">Loading...</code>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="copyWebhookUrl()" title="Copy Webhook URL">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                        <br><small class="mt-2 d-block">Verify Token: <code id="facebookVerifyToken">azone_bot_verify_token</code></small>
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-0" role="alert" style="background: rgba(255, 193, 7, 0.1); border-color: rgba(255, 193, 7, 0.3);">
                        <i class="fas fa-info-circle"></i> <strong>Note:</strong> Facebook Messenger integration is available after you create and save a bot. 
                        Please create a bot first, then come back to connect it to Facebook Messenger.
                    </div>
                    {% endif %}
                </div>
            </div>
            </div>
            <!-- End Form View Container -->

            <!-- Visual Flow View Container -->
            <div id="flowViewContainer" style="display: none;">
                <div class="mb-4">
                    <!-- Bot Name Input for Visual Flow View -->
                    <div class="mb-4">
                        <label for="botNameFlowView" class="form-label">
                            <i class="fas fa-tag"></i> Bot Name
                        </label>
                        <input 
                            type="text" 
                            class="form-control form-control-lg" 
                            id="botNameFlowView" 
                            name="botNameFlowView"
                            placeholder="Enter your bot name (e.g., Customer Support Bot)"
                            value="{% if bot_data %}{{ bot_data.bot_name }}{% endif %}"
                            onchange="syncBotNameToForm()"
                            data-validate="botName|minLength:2|maxLength:50"
                            minlength="2"
                            maxlength="50"
                        >
                        <small class="form-text text-muted">Give your bot a unique and descriptive name</small>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="fas fa-project-diagram text-info"></i> Visual Flow Builder</h5>
                        <div>
                            <button type="button" class="btn btn-sm btn-success me-2" onclick="addFlowNode('start')" {% if not can_edit %}disabled title="Viewer role များအတွက် Nodes မထည့်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-play"></i> Start
                            </button>
                            <button type="button" class="btn btn-sm btn-primary me-2" onclick="addFlowNode('message')" {% if not can_edit %}disabled title="Viewer role များအတွက် Nodes မထည့်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-comment"></i> Message
                            </button>
                            <button type="button" class="btn btn-sm btn-warning me-2" onclick="addFlowNode('question')" {% if not can_edit %}disabled title="Viewer role များအတွက် Nodes မထည့်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-question"></i> Question
                            </button>
                            <button type="button" class="btn btn-sm btn-info me-2" onclick="addFlowNode('api_call')" {% if not can_edit %}disabled title="Viewer role များအတွက် Nodes မထည့်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-plug"></i> API Call
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary me-2" onclick="addFlowNode('webhook')" {% if not can_edit %}disabled title="Viewer role များအတွက် Nodes မထည့်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-link"></i> Webhook
                            </button>
                            <button type="button" class="btn btn-sm btn-secondary" onclick="syncFlowToForm()" {% if not can_edit %}disabled title="Viewer role များအတွက် Sync မပြုလုပ်နိုင်ပါ"{% endif %}>
                                <i class="fas fa-sync"></i> Sync to Form
                            </button>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Drag nodes to reposition. Click connectors to create connections. Right-click nodes to edit or delete.
                    </div>
                </div>
                
                <!-- Flow Canvas -->
                <div id="flowCanvas" style="position: relative; width: 100%; height: 600px; background: linear-gradient(135deg, #0E121F 0%, #1a1a2e 100%); border: 2px solid rgba(99, 199, 255, 0.3); border-radius: 12px; overflow: hidden; cursor: grab;">
                    <svg id="flowConnections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                <polygon points="0 0, 10 3, 0 6" fill="rgba(99, 199, 255, 0.8)" />
                            </marker>
                        </defs>
                    </svg>
                    <div id="flowNodesContainer" style="position: relative; width: 100%; height: 100%; z-index: 2;">
                        <!-- Flow nodes will be rendered here -->
                    </div>
                </div>
            </div>
            <!-- End Visual Flow View Container -->
        </div>
        {% elif active_menu == 'analytics' %}
        <!-- Analytics View -->
        <div class="bot-builder-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-chart-bar text-primary"></i> Analytics Dashboard
                    </h2>
                    <p class="text-muted mb-0 mt-2">View analytics and insights for your bots</p>
                </div>
                <div class="btn-group" role="group">
                    <a href="/api/analytics/export?format=csv" class="btn btn-sm btn-success" target="_blank">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </a>
                    <a href="/api/analytics/export?format=json" class="btn btn-sm btn-info" target="_blank">
                        <i class="fas fa-file-code"></i> Export JSON
                    </a>
                </div>
            </div>
            
            {% if stats and stats|length > 0 %}
            <!-- Overall Statistics Cards -->
            <div class="row mb-4">
                <div class="col-md-4 mb-3">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title text-muted">
                                <i class="fas fa-comments text-info"></i> Total Messages
                            </h5>
                            <h2 class="text-primary">
                                {{ stats|sum(attribute='total_messages') }}
                            </h2>
                            <small class="text-muted">Last 30 days</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title text-muted">
                                <i class="fas fa-users text-success"></i> Unique Sessions
                            </h5>
                            <h2 class="text-success">
                                {{ stats|sum(attribute='unique_sessions') }}
                            </h2>
                            <small class="text-muted">Last 30 days</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-dark border-secondary">
                        <div class="card-body">
                            <h5 class="card-title text-muted">
                                <i class="fas fa-robot text-warning"></i> Active Bots
                            </h5>
                            <h2 class="text-warning">
                                {{ stats|length }}
                            </h2>
                            <small class="text-muted">With conversations</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot-Specific Statistics -->
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line"></i> Bot Performance
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-robot"></i> Bot Name</th>
                                    <th><i class="fas fa-comments"></i> Total Messages</th>
                                    <th><i class="fas fa-users"></i> Unique Sessions</th>
                                    <th><i class="fas fa-chart-bar"></i> Avg Messages/Session</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in stats %}
                                <tr>
                                    <td><strong>{{ stat.bot_name }}</strong></td>
                                    <td>{{ stat.total_messages }}</td>
                                    <td>{{ stat.unique_sessions }}</td>
                                    <td>
                                        {% if stat.unique_sessions > 0 %}
                                            {{ "%.1f"|format(stat.total_messages / stat.unique_sessions) }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Step-Level Analytics -->
            {% if step_analytics %}
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol"></i> Step-Level Analytics
                    </h5>
                </div>
                <div class="card-body">
                    {% for bot_name, step_data in step_analytics.items() %}
                        {% if step_data|length > 0 %}
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">{{ bot_name }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-dark">
                                    <thead>
                                        <tr>
                                            <th>Step Index</th>
                                            <th>Step Type</th>
                                            <th>Completions</th>
                                            <th>Unique Sessions</th>
                                            <th>Drop-off Rate</th>
                                            <th>Avg Latency (s)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for step in step_data %}
                                        <tr>
                                            <td>{{ step.step_index }}</td>
                                            <td><span class="badge bg-info">{{ step.step_type }}</span></td>
                                            <td>{{ step.completion_count }}</td>
                                            <td>{{ step.unique_sessions }}</td>
                                            <td>
                                                {% if step.drop_off_rate > 50 %}
                                                    <span class="text-danger">{{ "%.1f"|format(step.drop_off_rate) }}%</span>
                                                {% elif step.drop_off_rate > 25 %}
                                                    <span class="text-warning">{{ "%.1f"|format(step.drop_off_rate) }}%</span>
                                                {% else %}
                                                    <span class="text-success">{{ "%.1f"|format(step.drop_off_rate) }}%</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if step.avg_latency > 0 %}
                                                    {{ "%.3f"|format(step.avg_latency) }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Daily Analytics Chart (if available) -->
            {% if bot_analytics %}
            <div class="card bg-dark border-secondary">
                <div class="card-header bg-secondary">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-alt"></i> Daily Activity (Last 30 Days)
                    </h5>
                </div>
                <div class="card-body">
                    {% for bot_name, analytics in bot_analytics.items() %}
                        {% if analytics|length > 0 %}
                        <div class="mb-4">
                            <h6 class="text-primary mb-3">{{ bot_name }}</h6>
                            <div class="table-responsive">
                                <table class="table table-sm table-dark">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Messages</th>
                                            <th>Sessions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for day in analytics[:10] %}
                                        <tr>
                                            <td>{{ day.date }}</td>
                                            <td>{{ day.message_count }}</td>
                                            <td>{{ day.session_count }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% else %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle"></i> No analytics data available yet. Start using your bots to see statistics here.
            </div>
            {% endif %}
        </div>
        {% elif active_menu == 'gemini-chat' %}
        <!-- Gemini Chat View -->
        <div class="bot-builder-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-comments text-primary"></i> Gemini AI Chat
                    </h2>
                    <p class="text-muted mb-0 mt-2">Chat with Gemini AI for advice and discussions</p>
                </div>
            </div>
            
            {% if gemini_available %}
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-body">
                    <div id="geminiChatMessages" style="min-height: 400px; max-height: 500px; overflow-y: auto; padding: 20px; background: rgba(14, 18, 31, 0.5); border-radius: 10px; margin-bottom: 20px;">
                        <div class="text-center text-muted">
                            <i class="fas fa-robot" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                            <p>Start a conversation with Gemini AI!</p>
                            <small>Ask questions, get advice, or discuss any topic.</small>
                        </div>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="geminiChatInput" placeholder="Type your message here..." onkeypress="if(event.key === 'Enter') sendGeminiMessage()">
                        <button class="btn btn-primary" id="geminiSendBtn" onclick="sendGeminiMessage()">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearGeminiChat()" title="Clear Chat">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning" role="alert">
                <i class="fas fa-exclamation-triangle"></i> 
                <strong>Gemini service is not available.</strong><br>
                Please configure GEMINI_API_KEY in your environment or config.py file.
            </div>
            {% endif %}
        </div>
        
        {% elif active_menu == 'templates' %}
        <!-- Templates View -->
        <div class="bot-builder-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-layer-group text-primary"></i> Bot Templates
                    </h2>
                    <p class="text-muted mb-0 mt-2">Choose from pre-built templates to quickly create your bot</p>
                </div>
            </div>
            
            <!-- Bot Template Library -->
            <div class="mb-4">
                <div class="card bg-dark border-secondary">
                    <div class="card-header bg-secondary">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group text-info"></i> Start from Template
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Choose a pre-built template by platform:</p>
                        
                        <!-- Platform Filter Buttons -->
                        <div class="mb-3">
                            <div class="btn-group flex-wrap" role="group" id="platformFilter">
                                <button type="button" class="btn btn-sm btn-outline-primary active" data-platform="all" onclick="window.filterTemplatesByPlatform('all')">
                                    <i class="fas fa-th"></i> All Platforms
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" data-platform="telegram" onclick="window.filterTemplatesByPlatform('telegram')">
                                    <i class="fab fa-telegram"></i> Telegram
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-platform="facebook" onclick="window.filterTemplatesByPlatform('facebook')">
                                    <i class="fab fa-facebook"></i> Facebook
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-danger" data-platform="youtube" onclick="window.filterTemplatesByPlatform('youtube')">
                                    <i class="fab fa-youtube"></i> YouTube
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-dark" data-platform="tiktok" onclick="window.filterTemplatesByPlatform('tiktok')">
                                    <i class="fab fa-tiktok"></i> TikTok
                                </button>
                            </div>
                        </div>
                        
                        <div class="row" id="templateCards">
                            {% if templates and templates|length > 0 %}
                                {% for t in templates %}
                                <div class="col-md-6 col-lg-4 mb-4 template-card" data-platform="{{ t.platform|default('general') }}">
                                    <div class="card template-card-modern h-100" style="background: linear-gradient(135deg, rgba(14, 18, 31, 0.95) 0%, rgba(26, 31, 53, 0.95) 100%); border: 1px solid rgba(99, 199, 255, 0.2); border-radius: 15px; transition: all 0.3s ease; overflow: hidden; position: relative;">
                                        <!-- Platform Color Accent -->
                                        <div class="template-platform-accent" style="position: absolute; top: 0; left: 0; right: 0; height: 4px; 
                                            {% if t.platform == 'telegram' %}background: linear-gradient(90deg, #0088cc 0%, #229ED9 100%);
                                            {% elif t.platform == 'facebook' %}background: linear-gradient(90deg, #0078FF 0%, #1877F2 100%);
                                            {% elif t.platform == 'youtube' %}background: linear-gradient(90deg, #FF0000 0%, #FF4444 100%);
                                            {% elif t.platform == 'tiktok' %}background: linear-gradient(90deg, #000000 0%, #333333 100%);
                                            {% else %}background: linear-gradient(90deg, #63C7FF 0%, #A855F7 100%);{% endif %}">
                                        </div>
                                        
                                        <!-- Template Image/Icon Section -->
                                        <div class="template-image-section" style="height: 180px; background: 
                                            {% if t.platform == 'telegram' %}linear-gradient(135deg, rgba(0, 136, 204, 0.2) 0%, rgba(34, 158, 217, 0.1) 100%);
                                            {% elif t.platform == 'facebook' %}linear-gradient(135deg, rgba(0, 120, 255, 0.2) 0%, rgba(24, 119, 242, 0.1) 100%);
                                            {% elif t.platform == 'youtube' %}linear-gradient(135deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 68, 68, 0.1) 100%);
                                            {% elif t.platform == 'tiktok' %}linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(51, 51, 51, 0.2) 100%);
                                            {% else %}linear-gradient(135deg, rgba(99, 199, 255, 0.2) 0%, rgba(168, 85, 247, 0.1) 100%);{% endif %}
                                            display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                            <!-- Platform Icon -->
                                            <div style="width: 100px; height: 100px; border-radius: 20px; background: 
                                                {% if t.platform == 'telegram' %}linear-gradient(135deg, #0088cc 0%, #229ED9 100%);
                                                {% elif t.platform == 'facebook' %}linear-gradient(135deg, #0078FF 0%, #1877F2 100%);
                                                {% elif t.platform == 'youtube' %}linear-gradient(135deg, #FF0000 0%, #FF4444 100%);
                                                {% elif t.platform == 'tiktok' %}linear-gradient(135deg, #000000 0%, #333333 100%);
                                                {% else %}linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);{% endif %}
                                                display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                                {% if t.platform == 'telegram' %}
                                                    <i class="fab fa-telegram" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'facebook' %}
                                                    <i class="fab fa-facebook" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'youtube' %}
                                                    <i class="fab fa-youtube" style="font-size: 50px; color: white;"></i>
                                                {% elif t.platform == 'tiktok' %}
                                                    <i class="fab fa-tiktok" style="font-size: 50px; color: white;"></i>
                                                {% else %}
                                                    <i class="fas fa-robot" style="font-size: 50px; color: white;"></i>
                                                {% endif %}
                                            </div>
                                            <!-- Platform Badge Overlay -->
                                            <span class="badge" style="position: absolute; top: 10px; right: 10px;
                                                {% if t.platform == 'telegram' %}background: rgba(0, 136, 204, 0.9); color: white; border: 1px solid rgba(0, 136, 204, 1);
                                                {% elif t.platform == 'facebook' %}background: rgba(0, 120, 255, 0.9); color: white; border: 1px solid rgba(0, 120, 255, 1);
                                                {% elif t.platform == 'youtube' %}background: rgba(255, 0, 0, 0.9); color: white; border: 1px solid rgba(255, 0, 0, 1);
                                                {% elif t.platform == 'tiktok' %}background: rgba(0, 0, 0, 0.9); color: white; border: 1px solid rgba(255, 255, 255, 0.3);
                                                {% else %}background: rgba(99, 199, 255, 0.9); color: white; border: 1px solid rgba(99, 199, 255, 1);{% endif %}
                                                font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; backdrop-filter: blur(10px);">
                                                {% if t.platform == 'telegram' %}
                                                    <i class="fab fa-telegram"></i> Telegram
                                                {% elif t.platform == 'facebook' %}
                                                    <i class="fab fa-facebook"></i> Facebook
                                                {% elif t.platform == 'youtube' %}
                                                    <i class="fab fa-youtube"></i> YouTube
                                                {% elif t.platform == 'tiktok' %}
                                                    <i class="fab fa-tiktok"></i> TikTok
                                                {% else %}
                                                    <i class="fas fa-robot"></i> General
                                                {% endif %}
                                            </span>
                                        </div>
                                        
                                        <div class="card-body" style="padding: 20px;">
                                            <!-- Header with Title -->
                                            <div class="mb-3">
                                                <h6 class="card-title mb-1" style="color: #F0F4F8; font-weight: 600; font-size: 1.1rem; line-height: 1.3;">
                                                    {{ t.name }}
                                                </h6>
                                            </div>
                                            
                                            <!-- Description -->
                                            <p class="card-text mb-3" style="color: rgba(240, 244, 248, 0.7); font-size: 0.875rem; line-height: 1.5; min-height: 50px;">{{ t.description }}</p>
                                            
                                            <!-- Integration Guide -->
                                            {% if t.integration_guide %}
                                            <div class="mb-3">
                                                <button type="button" class="btn btn-sm" data-bs-toggle="collapse" data-bs-target="#integrationGuide{{ loop.index }}" aria-expanded="false" style="background: rgba(99, 199, 255, 0.1); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.3); border-radius: 8px; padding: 6px 12px; font-size: 0.8rem; transition: all 0.3s ease;">
                                                    <i class="fas fa-info-circle"></i> Integration Guide
                                                </button>
                                                <div class="collapse mt-2" id="integrationGuide{{ loop.index }}">
                                                    <div class="card card-body" style="background: rgba(99, 199, 255, 0.05); border: 1px solid rgba(99, 199, 255, 0.2); border-radius: 8px; color: rgba(240, 244, 248, 0.9); font-size: 0.8rem; white-space: pre-line;">{{ t.integration_guide }}</div>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <!-- Action Buttons -->
                                            <div class="d-flex gap-2 mt-auto">
                                                <button type="button" class="btn btn-sm flex-fill" onclick="window.loadTemplate('{{ t.id }}')" {% if not can_edit %}disabled title="Viewer role များအတွက် Template load လုပ်ခွင့်မရှိပါ"{% endif %} style="background: rgba(99, 199, 255, 0.1); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.3); border-radius: 8px; padding: 8px 12px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(99, 199, 255, 0.2)'; this.style.borderColor='rgba(99, 199, 255, 0.5)';" onmouseout="this.style.background='rgba(99, 199, 255, 0.1)'; this.style.borderColor='rgba(99, 199, 255, 0.3)';">
                                                    <i class="fas fa-download"></i> Load
                                                </button>
                                                <button type="button" class="btn btn-sm flex-fill" onclick="window.useTemplate('{{ t.id }}')" {% if not can_edit %}disabled title="Viewer role များအတွက် Template သုံးခွင့်မရှိပါ"{% endif %} style="
                                                    {% if t.platform == 'telegram' %}background: linear-gradient(135deg, #0088cc 0%, #229ED9 100%);
                                                    {% elif t.platform == 'facebook' %}background: linear-gradient(135deg, #0078FF 0%, #1877F2 100%);
                                                    {% elif t.platform == 'youtube' %}background: linear-gradient(135deg, #FF0000 0%, #FF4444 100%);
                                                    {% elif t.platform == 'tiktok' %}background: linear-gradient(135deg, #000000 0%, #333333 100%);
                                                    {% else %}background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%);{% endif %}
                                                    color: white; border: none; border-radius: 8px; padding: 8px 12px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" 
                                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';" 
                                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                                                    <i class="fas fa-magic"></i> Create
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <p class="text-muted text-center">No templates available. Click refresh to load templates.</p>
                                </div>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-info mt-3" onclick="window.loadTemplates()">
                            <i class="fas fa-sync"></i> Refresh Templates
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        {% elif active_menu == 'my-bots' %}
        <!-- My Bots View -->
        <div class="bot-builder-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-robot text-primary"></i> My Bots
                    </h2>
                    <p class="text-muted mb-0 mt-2">Manage all your created bots</p>
                </div>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-sm btn-outline-info" onclick="document.getElementById('importFile').click()" title="Import Bot from JSON" {% if not can_edit %}disabled{% endif %}>
                        <i class="fas fa-upload"></i> Import Bot
                    </button>
                    <input type="file" id="importFile" accept=".json,application/json" style="display: none;" onchange="importBot()" {% if not can_edit %}disabled{% endif %}>
                    {% if bots and bots|length > 0 and can_edit %}
                    <button type="button" class="btn btn-sm btn-outline-danger" id="deleteSelectedBtn" onclick="window.deleteSelectedBots()" title="Delete Selected Bots" disabled>
                        <i class="fas fa-trash-alt"></i> Delete Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="window.deleteAllTestBots()" title="Delete All Test Bots">
                        <i class="fas fa-broom"></i> Delete Test Bots
                    </button>
                    {% endif %}
                </div>
            </div>
            
            {% if bots and bots|length > 0 %}
            <!-- Bots Table -->
            <div class="table-responsive">
                <table class="table table-dark table-hover" id="myBotsTable">
                    <thead>
                        <tr>
                            <th scope="col" style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)" title="Select All" {% if not can_edit %}disabled{% endif %}>
                            </th>
                            <th scope="col">
                                <i class="fas fa-tag"></i> Bot Name
                            </th>
                            <th scope="col">
                                <i class="fas fa-comment-dots"></i> Initial Greeting
                            </th>
                            <th scope="col">
                                <i class="fas fa-list-ol"></i> Steps Count
                            </th>
                            <th scope="col">
                                <i class="fas fa-info-circle"></i> Status
                            </th>
                            <th scope="col">
                                <i class="fas fa-cog"></i> Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bot in bots %}
                        <tr>
                            <td>
                                <input type="checkbox" class="bot-checkbox" value="{{ bot.bot_name }}" onchange="updateDeleteButton()" {% if not can_edit %}disabled{% endif %}>
                            </td>
                            <td>
                                <strong>{{ bot.bot_name }}</strong>
                            </td>
                            <td>
                                {% if bot.initial_greeting|length > 50 %}
                                    {{ bot.initial_greeting[:50] }}...
                                {% else %}
                                    {{ bot.initial_greeting }}
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-primary">{{ bot.steps|length }} steps</span>
                            </td>
                            <td>
                                {% if bot.status %}
                                    {% if bot.status == 'draft' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-edit"></i> Draft
                                        </span>
                                    {% elif bot.status == 'published' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i> Live
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ bot.status }}</span>
                                    {% endif %}
                                {% else %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle"></i> Live
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <a href="{{ url_for('bot_builder') }}?bot_name={{ bot.bot_name|urlencode }}" class="btn btn-sm btn-primary" title="Edit Bot">
                                        <i class="fas fa-edit"></i> Edit
                                    </a>
                                    <button type="button" class="btn btn-sm btn-success" onclick="window.exportBot('{{ bot.bot_name|replace("'", "\\'") }}')" title="Export Bot">
                                        <i class="fas fa-download"></i> Export
                                    </button>
                                    <button type="button" class="btn btn-sm btn-info" onclick="window.showEmbedCode('{{ bot.bot_name|replace("'", "\\'") }}')" title="Get Embed Code">
                                        <i class="fas fa-code"></i> Get Embed Code
                                    </button>
                                    {% if can_edit %}
                                    <button type="button" class="btn btn-sm btn-danger" onclick="window.deleteBot('{{ bot.bot_name|replace("'", "\\'") }}')" title="Delete Bot">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle"></i> No bots found. Create your first bot in the Bot Builder section!
            </div>
            {% endif %}
        </div>
        {% elif active_menu == 'users' %}
        <!-- User Management View -->
        <div class="bot-builder-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">
                        <i class="fas fa-users-cog text-primary"></i> User Management
                    </h2>
                    <p class="text-muted mb-0 mt-2">Owner အတွက်သာ role များ ပြောင်းနိုင်ပါသည်။</p>
                </div>
                <a href="{{ url_for('register') }}" class="btn btn-sm btn-success">
                    <i class="fas fa-user-plus"></i> Create New User
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td><span class="badge bg-info text-dark text-uppercase">{{ user.role }}</span></td>
                            <td>{{ user.created_at }}</td>
                            <td>
                                <div class="d-flex gap-2 align-items-center">
                                    <form class="d-flex gap-2" method="POST" action="{{ url_for('update_user_role') }}">
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <select name="role" class="form-select form-select-sm" style="max-width: 150px;">
                                            <option value="viewer" {% if user.role == 'viewer' %}selected{% endif %}>Viewer</option>
                                            <option value="editor" {% if user.role == 'editor' %}selected{% endif %}>Editor</option>
                                            <option value="owner" {% if user.role == 'owner' %}selected{% endif %}>Owner</option>
                                        </select>
                                        <button type="submit" class="btn btn-sm btn-primary">
                                            <i class="fas fa-save"></i> Update
                                        </button>
                                    </form>
                                    {% if user.id != current_user.id %}
                                    <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" onsubmit="return confirm('{{ user.username }} ကို ဖျက်မှာ သေချာပါသလား?');" style="margin: 0;">
                                        <button type="submit" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </form>
                                    {% else %}
                                    <button type="button" class="btn btn-sm btn-secondary" disabled title="သင့်ကိုယ်တိုင် ဖျက်လို့မရပါ">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info mt-4 mb-0">
                <i class="fas fa-info-circle"></i> Default admin: username <strong>admin</strong>, password <strong>admin123</strong>. လုံခြုံရေးအတွက် ပြောင်းလဲရမည်။
            </div>
        </div>
        {% else %}
        <!-- Default View (Bot Builder) -->
        <div class="bot-builder-card">
            <h2 class="mb-4">
                <i class="fas fa-tools text-primary"></i> Bot Builder
            </h2>
            <p class="text-muted mb-4">Create and configure your chatbot with ease</p>

            <!-- Version Status Banner -->
            {% if bot_data and bot_data.bot_name %}
            <div class="alert alert-info mb-4 d-flex justify-content-between align-items-center" role="alert">
                <div>
                    <i class="fas fa-info-circle"></i> 
                    <strong>Editing:</strong> {{ bot_data.bot_name }}
                    {% if bot_data.is_live %}
                        <span class="badge bg-success ms-2"><i class="fas fa-check-circle"></i> Live (v{{ bot_data.version_number }})</span>
                    {% else %}
                        <span class="badge bg-warning text-dark ms-2"><i class="fas fa-edit"></i> Draft (v{{ bot_data.version_number }})</span>
                    {% endif %}
                    {% if draft_data and live_data %}
                        <span class="badge bg-secondary ms-2">Live: v{{ live_data.version_number }}</span>
                    {% endif %}
                </div>
                <div>
                    {% if draft_data and not bot_data.is_live %}
                    <button type="button" class="btn btn-sm btn-success me-2" onclick="window.publishDraft('{{ bot_data.bot_name|replace("'", "\\'") }}')" {% if not can_edit %}disabled{% endif %}>
                        <i class="fas fa-rocket"></i> Publish Draft
                    </button>
                    <button type="button" class="btn btn-sm btn-info" onclick="window.testDraft('{{ bot_data.bot_name|replace("'", "\\'") }}')" {% if not can_edit %}disabled{% endif %}>
                        <i class="fas fa-vial"></i> Test Draft
                    </button>
                    {% elif live_data and not bot_data.is_live %}
                    <a href="{{ url_for('bot_builder', bot_name=bot_data.bot_name) }}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-eye"></i> View Live
                    </a>
                    {% endif %}
                    {% if versions|length > 1 %}
                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="window.showVersionHistory('{{ bot_data.bot_name|replace("'", "\\'") }}')">
                        <i class="fas fa-history"></i> Version History
                    </button>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Bot Builder Form -->
            <form id="botBuilderForm" action="{{ url_for('save_bot') }}" method="POST">
                <!-- Bot Name Input -->
                <div class="mb-4">
                    <label for="botName" class="form-label">
                        <i class="fas fa-tag"></i> Bot Name
                    </label>
                    <input 
                        type="text" 
                        class="form-control form-control-lg" 
                        id="botName" 
                        name="botName" 
                        placeholder="Enter your bot name (e.g., Customer Support Bot)"
                        value="{% if bot_data %}{{ bot_data.bot_name }}{% endif %}"
                        required
                        data-validate="botName|minLength:2|maxLength:50"
                        minlength="2"
                        maxlength="50"
                    >
                    <small class="form-text text-muted">Give your bot a unique and descriptive name</small>
                </div>

                <!-- Initial Greeting Textarea -->
                <div class="mb-4">
                    <label for="initialGreeting" class="form-label">
                        <i class="fas fa-comment-dots"></i> Initial Greeting
                    </label>
                    <textarea 
                        class="form-control" 
                        id="initialGreeting" 
                        name="initialGreeting" 
                        rows="4" 
                        placeholder="Enter the greeting message that your bot will send when users first interact (e.g., Hello! Welcome to our service. How can I help you today?)"
                        required
                        data-validate="minLength:10|maxLength:500"
                        minlength="10"
                        maxlength="500"
                    ></textarea>
                    <small class="form-text text-muted">This message will be sent automatically when a user starts a conversation</small>
                </div>

                <!-- Add New Step Button -->
                <div class="mb-4">
                    <button type="button" class="btn btn-add-step" id="addStepBtn" {% if not can_edit %}disabled title="Viewer role များအတွက် Step ထည့်ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-plus-circle"></i> Add New Step
                    </button>
                    <small class="form-text text-muted d-block mt-2">Add conversation steps to build your bot's flow</small>
                </div>

                <!-- Steps Container (for dynamically added steps) -->
                <div id="stepsContainer" class="mt-4">
                    <!-- Steps will be added here dynamically -->
                </div>

                <!-- Hidden input for steps JSON (will be populated by JavaScript) -->
                <input type="hidden" id="stepsJson" name="stepsJson" value="[]">

                <!-- Submit Button -->
                <div class="mt-4 pt-4 border-top">
                    <button type="submit" class="btn btn-primary btn-lg" {% if not can_edit %}disabled title="Viewer role များအတွက် Save ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                    {% if bot_data and bot_data.bot_name %}
                    <button type="button" class="btn btn-success btn-lg ms-2" onclick="window.saveAndPublish()" {% if not can_edit %}disabled title="Viewer role များအတွက် Publish ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-rocket"></i> Save & Publish
                    </button>
                    <button type="button" class="btn btn-danger btn-lg ms-2" onclick="window.deleteCurrentBot('{{ bot_data.bot_name|replace("'", "\\'") }}')" {% if not can_edit %}disabled title="Viewer role များအတွက် Delete ခွင့်မရှိပါ"{% endif %}>
                        <i class="fas fa-trash"></i> Delete Bot
                    </button>
                    {% endif %}
                    <button type="button" class="btn btn-outline-secondary btn-lg ms-2" onclick="window.location.reload()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
    </div>
    {% endif %}
</div>

    <!-- Embed Code Modal -->
    <div class="modal fade" id="embedCodeModal" tabindex="-1" aria-labelledby="embedCodeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="background-color: #1A233A; color: #F0F4F8;">
                <div class="modal-header" style="border-bottom: 1px solid #3B5D9A;">
                    <h5 class="modal-title" id="embedCodeModalLabel">
                        <i class="fas fa-code"></i> Embed Code for <span id="embedBotName"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        Copy the code below and paste it into your website's HTML. The chat widget will appear on your page.
                    </p>
                    <div class="mb-3">
                        <label for="embedCodeText" class="form-label">Embed Code:</label>
                        <textarea 
                            class="form-control" 
                            id="embedCodeText" 
                            rows="15" 
                            readonly 
                            style="background-color: #0E121F; color: #F0F4F8; border: 1px solid #3B5D9A; font-family: 'Courier New', monospace; font-size: 12px;"
                        ></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-primary" onclick="copyEmbedCode()">
                            <i class="fas fa-copy"></i> Copy Code
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                    <div id="copySuccessMessage" class="alert alert-success mt-3" style="display: none;">
                        <i class="fas fa-check-circle"></i> Code copied to clipboard!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Chat Widget (Only show in Bot Builder view) -->
    {% if active_menu == 'bot-builder' or not active_menu %}
    <div class="chat-widget" id="chatWidget">
        <div class="chat-widget-header" onclick="window.toggleChatWidget()">
            <h6>
                <i class="fas fa-comments"></i> Test Chat
            </h6>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="chat-widget-toggle" onclick="event.stopPropagation(); event.preventDefault(); window.toggleChatWidget(); return false;" title="Minimize/Maximize" type="button">
                    <i class="fas fa-minus" id="chatToggleIcon"></i>
                </button>
                <button class="chat-widget-close" onclick="event.stopPropagation(); event.preventDefault(); window.closeChatWidget(); return false;" title="Close Chat" type="button">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="chat-widget-body" id="chatWidgetBody">
            <div class="chat-empty-state" id="chatEmptyState">
                <i class="fas fa-robot"></i>
                <p>Start chatting to test your bot!</p>
                <small id="chatEmptyStateMessage">Enter your bot name above first</small>
            </div>
        </div>
        <div class="chat-widget-input-container">
            <div class="chat-widget-input-wrapper">
                <input 
                    type="text" 
                    class="chat-widget-input" 
                    id="chatInput" 
                    placeholder="Type a message..."
                    onkeypress="window.handleChatKeyPress(event)"
                >
                <button class="chat-widget-send-btn" id="chatSendBtn" onclick="event.stopPropagation(); if(typeof window.sendChatMessage === 'function') { window.sendChatMessage(); } else { console.error('sendChatMessage function not found'); } return false;" type="button">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="chat-widget-send-btn" id="chatResetBtn" onclick="event.stopPropagation(); if(typeof window.resetChatSession === 'function') { window.resetChatSession(); } else { console.error('resetChatSession function not found'); } return false;" title="Reset Chat" style="margin-left: 5px; background: rgba(239, 68, 68, 0.8);" type="button">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Floating button to show chat widget if hidden -->
    <button class="chat-widget-show-btn" id="chatWidgetShowBtn" onclick="window.showChatWidget(); return false;" style="display: none;" title="Show Test Chat" type="button">
        <i class="fas fa-comments"></i>
    </button>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/form-validation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/loading-feedback.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}"></script>
    <script>
        // Step counter for tracking step numbers
        let stepCount = 0;
        const canEditBots = {{ 'true' if can_edit else 'false' }};
        window.canEditBots = canEditBots;
        
        // Chat widget functions are defined in the head section to avoid reference errors

        /**
         * Function to add a new conversation step
         * Creates a step template with Type Selection and Content Input
         */
        function addNewStep() {
            stepCount++;
            const stepsContainer = document.getElementById('stepsContainer');
            
            // Create unique IDs for this step
            const stepId = 'step-' + stepCount;
            const typeSelectId = 'stepType-' + stepCount;
            const contentInputId = 'stepContent-' + stepCount;
            
            // Create step card element
            const stepCard = document.createElement('div');
            stepCard.className = 'card mb-3 step-card';
            stepCard.id = stepId;
            stepCard.setAttribute('data-step-number', stepCount);
            
            // Step Template HTML (Enhanced with Advanced Features)
            stepCard.innerHTML = `
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list-ol text-primary"></i> Step ${stepCount}
                    </h5>
                    <button type="button" class="btn btn-sm btn-outline-danger remove-step" onclick="removeStep('${stepId}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                <div class="card-body">
                    <!-- Type Selection Dropdown -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Step Type
                        </label>
                        <select class="form-select step-type-select" id="${typeSelectId}" name="stepType[]" onchange="updateContentInput('${stepId}', '${typeSelectId}', '${contentInputId}')" required>
                            <option value="">-- Select Type --</option>
                            <option value="message">Message</option>
                            <option value="question">Question</option>
                            <option value="api_call">External API Call</option>
                            <option value="webhook">Webhook</option>
                        </select>
                        <small class="form-text text-muted">Choose step type: Message, Question, or External API Call</small>
                    </div>
                    
                    <!-- Content Input Field (Dynamic based on Type) -->
                    <div class="mb-3" id="contentField-${stepCount}">
                        <label class="form-label" for="${contentInputId}">
                            <i class="fas fa-comment"></i> Content
                        </label>
                        <textarea 
                            class="form-control step-content-input" 
                            id="${contentInputId}" 
                            name="stepContent[]" 
                            rows="3"
                            placeholder="Enter content based on selected type..."
                            required
                            data-validate="minLength:1|maxLength:1000"
                            minlength="1"
                            maxlength="1000"
                        ></textarea>
                        <small class="form-text text-muted step-content-hint">Select a type first to see the appropriate placeholder</small>
                    </div>
                    
                    <!-- API Configuration Fields (Shown only for API Call type) -->
                    <div id="apiConfigFields-${stepCount}" style="display: none;">
                        <div class="card bg-dark border-secondary mb-3">
                            <div class="card-header bg-secondary">
                                <h6 class="mb-0"><i class="fas fa-plug"></i> API Configuration</h6>
                            </div>
                            <div class="card-body">
                                <!-- API URL -->
                                <div class="mb-3">
                                    <label class="form-label" for="apiUrl-${stepCount}">
                                        <i class="fas fa-link"></i> API URL
                                    </label>
                                    <input 
                                        type="text" 
                                        class="form-control" 
                                        id="apiUrl-${stepCount}"
                                        name="apiUrl-${stepCount}"
                                        placeholder="https://api.example.com/endpoint"
                                        data-validate="url"
                                    >
                                    <small class="form-text text-muted">Enter the full API endpoint URL. Use variables: {{variable_name}}</small>
                                </div>
                                
                                <!-- HTTP Method -->
                                <div class="mb-3">
                                    <label class="form-label" for="apiMethod-${stepCount}">
                                        <i class="fas fa-exchange-alt"></i> HTTP Method
                                    </label>
                                    <select class="form-select" id="apiMethod-${stepCount}">
                                        <option value="GET">GET</option>
                                        <option value="POST" selected>POST</option>
                                        <option value="PUT">PUT</option>
                                    </select>
                                    <small class="form-text text-muted">Select the HTTP method for the API call</small>
                                </div>
                                
                                <!-- Headers (JSON) -->
                                <div class="mb-3">
                                    <label class="form-label" for="apiHeaders-${stepCount}">
                                        <i class="fas fa-heading"></i> Headers (JSON)
                                    </label>
                                    <textarea 
                                        class="form-control font-monospace json-input" 
                                        id="apiHeaders-${stepCount}"
                                        name="apiHeaders-${stepCount}"
                                        rows="3"
                                        placeholder='{"Authorization": "Bearer {{api_token}}", "Content-Type": "application/json"}'
                                        data-json="true"
                                        data-validate="json"
                                    ></textarea>
                                    <small class="form-text text-muted">Enter headers as JSON. Use variables: {{variable_name}}</small>
                                </div>
                                
                                <!-- Body (JSON) -->
                                <div class="mb-3">
                                    <label class="form-label" for="apiBody-${stepCount}">
                                        <i class="fas fa-code"></i> Body (JSON)
                                    </label>
                                    <textarea 
                                        class="form-control font-monospace json-input" 
                                        id="apiBody-${stepCount}"
                                        name="apiBody-${stepCount}"
                                        rows="4"
                                        placeholder='{"name": "{{user_name}}", "email": "{{user_email}}"}'
                                        data-json="true"
                                        data-validate="json"
                                    ></textarea>
                                    <small class="form-text text-muted">Enter request body as JSON (for POST/PUT). Use variables: {{variable_name}}</small>
                                </div>
                                
                                <!-- Response Message Template -->
                                <div class="mb-3">
                                    <label class="form-label" for="apiResponseTemplate-${stepCount}">
                                        <i class="fas fa-reply"></i> Response Message Template
                                    </label>
                                    <textarea 
                                        class="form-control" 
                                        id="apiResponseTemplate-${stepCount}"
                                        rows="2"
                                        placeholder="API call successful! Response: {{api_response}}"
                                    ></textarea>
                                    <small class="form-text text-muted">Message to show after API call. Use {{api_response}} for API response data</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Options (Collapsible) -->
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#advancedOptions-${stepCount}" aria-expanded="false">
                            <i class="fas fa-cog"></i> Advanced Options
                        </button>
                    </div>
                    
                    <div class="collapse" id="advancedOptions-${stepCount}">
                        <div class="card card-body bg-dark border border-secondary">
                            <!-- Triggers (Keywords that trigger this step) -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-key"></i> Triggers (Keywords)
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-sm" 
                                    id="stepTriggers-${stepCount}"
                                    placeholder="Enter keywords separated by commas (e.g., help, support, assistance)"
                                >
                                <small class="form-text text-muted">Keywords that will trigger this step. Leave empty to use default flow.</small>
                            </div>
                            
                            <!-- Save Answer to Variable (For Questions) -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-database"></i> Save Answer to Variable
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control form-control-sm" 
                                    id="stepVariable-${stepCount}"
                                    placeholder="Variable name (e.g., user_name, email)"
                                >
                                <small class="form-text text-muted">Save user's answer to a variable for later use. Use in content with {variable_name}</small>
                            </div>
                            
                            <!-- Condition (When to show this step) -->
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-filter"></i> Condition
                                </label>
                                <select class="form-select form-select-sm" id="stepCondition-${stepCount}">
                                    <option value="">Always (No condition)</option>
                                    <option value="variable_equals">Variable Equals</option>
                                    <option value="step_completed">Step Completed</option>
                                    <option value="contains_keyword">Contains Keyword</option>
                                </select>
                                <input 
                                    type="text" 
                                    class="form-control form-control-sm mt-2" 
                                    id="stepConditionValue-${stepCount}"
                                    placeholder="Condition value (e.g., variable_name=value)"
                                    style="display: none;"
                                >
                                <small class="form-text text-muted">Set condition for when this step should be executed</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listener for condition select
            setTimeout(() => {
                const conditionSelect = document.getElementById(`stepCondition-${stepCount}`);
                const conditionValue = document.getElementById(`stepConditionValue-${stepCount}`);
                if (conditionSelect) {
                    conditionSelect.addEventListener('change', function() {
                        if (this.value) {
                            conditionValue.style.display = 'block';
                        } else {
                            conditionValue.style.display = 'none';
                        }
                    });
                }
            }, 100);
            
            // Append step card to container
            stepsContainer.appendChild(stepCard);
            
            // Scroll to the new step for better UX
            stepCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        /**
         * Function to update content input field based on selected type
         * @param {string} stepId - The ID of the step card
         * @param {string} typeSelectId - The ID of the type select dropdown
         * @param {string} contentInputId - The ID of the content input field
         */
        function updateContentInput(stepId, typeSelectId, contentInputId) {
            const typeSelect = document.getElementById(typeSelectId);
            const contentInput = document.getElementById(contentInputId);
            const hintText = contentInput.parentElement.querySelector('.step-content-hint');
            const stepNumber = stepId.replace('step-', '');
            
            // Get API config fields container
            const apiConfigFields = document.getElementById(`apiConfigFields-${stepNumber}`);
            const contentField = document.getElementById(`contentField-${stepNumber}`);
            
            const selectedType = typeSelect.value;
            
            if (selectedType === 'message') {
                // For Message type: Text input for bot message
                if (contentInput.tagName === 'TEXTAREA') {
                    contentInput.placeholder = 'Enter the message that the bot will send (e.g., Hello! How can I help you today?)';
                }
                contentInput.required = true;
                if (contentField) contentField.style.display = 'block';
                if (apiConfigFields) apiConfigFields.style.display = 'none';
                if (hintText) {
                    hintText.textContent = 'Enter the message content that your bot will send to users';
                }
            } else if (selectedType === 'question') {
                // For Question type: Text input for question
                if (contentInput.tagName === 'TEXTAREA') {
                    contentInput.placeholder = 'Enter the question that the bot will ask (e.g., What is your name?)';
                }
                contentInput.required = true;
                if (contentField) contentField.style.display = 'block';
                if (apiConfigFields) apiConfigFields.style.display = 'none';
                if (hintText) {
                    hintText.textContent = 'Enter the question that your bot will ask users';
                }
            } else if (selectedType === 'api_call') {
                // For API Call type: Show API configuration fields
                contentInput.required = false;
                if (contentField) contentField.style.display = 'none';
                if (apiConfigFields) apiConfigFields.style.display = 'block';
                if (hintText) {
                    hintText.textContent = 'Configure external API call settings below';
                }
            } else if (selectedType === 'webhook') {
                // For Webhook type: Show webhook configuration fields (same as API call)
                contentInput.required = false;
                if (contentField) contentField.style.display = 'none';
                if (apiConfigFields) apiConfigFields.style.display = 'block';
                if (hintText) {
                    hintText.textContent = 'Configure webhook settings below';
                }
            } else {
                // Default: Clear placeholder
                if (contentInput.tagName === 'TEXTAREA') {
                    contentInput.placeholder = 'Enter content based on selected type...';
                }
                contentInput.required = false;
                if (contentField) contentField.style.display = 'block';
                if (apiConfigFields) apiConfigFields.style.display = 'none';
                if (hintText) {
                    hintText.textContent = 'Select a type first to see the appropriate placeholder';
                }
            }
            
            // Clear the input when type changes
            if (selectedType !== 'api_call' && selectedType !== 'webhook') {
                contentInput.value = '';
            }
        }

        /**
         * Function to remove a step
         * @param {string} stepId - The ID of the step card to remove
         */
        function removeStep(stepId) {
            const stepCard = document.getElementById(stepId);
            if (stepCard && confirm('Are you sure you want to remove this step?')) {
                stepCard.remove();
                // Optionally renumber remaining steps
                renumberSteps();
            }
        }

        /**
         * Function to renumber steps after removal
         */
        function renumberSteps() {
            const stepCards = document.querySelectorAll('.step-card');
            stepCards.forEach((card, index) => {
                const stepNumber = index + 1;
                const header = card.querySelector('.card-header h5');
                if (header) {
                    header.innerHTML = `<i class="fas fa-list-ol text-primary"></i> Step ${stepNumber}`;
                }
                card.setAttribute('data-step-number', stepNumber);
            });
        }

        /**
         * Show alert message (Success/Error)
         */
        window.showAlertMessage = function(message, type = 'success') {
            // Remove existing alerts
            const existingAlerts = document.querySelectorAll('.custom-alert-message');
            existingAlerts.forEach(alert => alert.remove());
            
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert-message alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 500px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                animation: slideInRight 0.3s ease;
            `;
            
            const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
            alertDiv.innerHTML = `
                <i class="fas fa-${icon}"></i> 
                <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> 
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Add to page
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds for success, 8 seconds for error
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => alertDiv.remove(), 300);
            }, type === 'success' ? 5000 : 8000);
        }
        
        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // Load existing bot data for editing
        {% if bot_data and bot_data.steps %}
        function loadExistingBotSteps() {
            const steps = {{ bot_data.steps|tojson|safe }};
            const stepsContainer = document.getElementById('stepsContainer');
            
            if (steps && steps.length > 0) {
                steps.forEach((step, index) => {
                    stepCount++;
                    const stepId = 'step-' + stepCount;
                    const typeSelectId = 'stepType-' + stepCount;
                    const contentInputId = 'stepContent-' + stepCount;
                    
                    const stepCard = document.createElement('div');
                    stepCard.className = 'card mb-3 step-card';
                    stepCard.id = stepId;
                    stepCard.setAttribute('data-step-number', stepCount);
                    
                    const stepType = step.type || '';
                    const stepContent = (step.content || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    
                    stepCard.innerHTML = `
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-list-ol text-primary"></i> Step ${stepCount}
                            </h5>
                            <button type="button" class="btn btn-sm btn-outline-danger remove-step" onclick="removeStep('${stepId}')">
                                <i class="fas fa-trash"></i> Remove
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">
                                    <i class="fas fa-tag"></i> Step Type
                                </label>
                                <select class="form-select step-type-select" id="${typeSelectId}" name="stepType[]" onchange="updateContentInput('${stepId}', '${typeSelectId}', '${contentInputId}')" required>
                                    <option value="">-- Select Type --</option>
                                    <option value="message" ${stepType === 'message' ? 'selected' : ''}>Message</option>
                                    <option value="question" ${stepType === 'question' ? 'selected' : ''}>Question</option>
                                    <option value="api_call" ${stepType === 'api_call' ? 'selected' : ''}>External API Call</option>
                                </select>
                                <small class="form-text text-muted">Choose step type: Message, Question, or External API Call</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label" for="${contentInputId}">
                                    <i class="fas fa-comment"></i> Content
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control step-content-input" 
                                    id="${contentInputId}" 
                                    name="stepContent[]" 
                                    value="${stepContent}"
                                    placeholder="Enter content based on selected type..."
                                    required
                                >
                                <small class="form-text text-muted step-content-hint">${stepType === 'message' ? 'Enter the message content that your bot will send to users' : stepType === 'question' ? 'Enter the question that your bot will ask users' : 'Select a type first to see the appropriate placeholder'}</small>
                            </div>
                        </div>
                    `;
                    
                    stepsContainer.appendChild(stepCard);
                });
            }
        }
        {% endif %}

        // Initialize event listeners when page loads
        document.addEventListener('DOMContentLoaded', function() {
            const addStepBtn = document.getElementById('addStepBtn');
            const botBuilderForm = document.getElementById('botBuilderForm');
            
            {% if bot_data and bot_data.steps %}
            // Load existing bot steps for editing
            loadExistingBotSteps();
            {% endif %}
            
            // Attach click event to "Add New Step" button
            if (addStepBtn) {
                addStepBtn.addEventListener('click', function() {
                    if (!window.canEditBots) {
                        window.showAlertMessage('Viewer role အတွက် bot များကို ပြင်ဆင်ခွင့်မရှိပါ။', 'error');
                        return;
                    }
                    addNewStep();
                });
            }
            
            // Form submission handler - Use validator if available
            if (botBuilderForm) {
                botBuilderForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    // Get form values (always collect, regardless of validator)
                    const botNameInput = document.getElementById('botName') || document.getElementById('botNameFlowView');
                    const initialGreetingInput = document.getElementById('initialGreeting');
                    
                    let botName = '';
                    let initialGreeting = '';
                    
                    if (botNameInput) {
                        botName = botNameInput.value.trim();
                    }
                    
                    if (initialGreetingInput) {
                        initialGreeting = initialGreetingInput.value.trim();
                    }
                    
                    // Use validator if available
                    if (window.botFormValidator) {
                        if (!window.botFormValidator.validateForm()) {
                            return; // Validation errors already shown
                        }
                        // Re-get values after validation (in case they were updated)
                        if (botNameInput) botName = botNameInput.value.trim();
                        if (initialGreetingInput) initialGreeting = initialGreetingInput.value.trim();
                    }
                    
                    // Validate required fields (always check, even with validator)
                    if (!botName) {
                        const errorMsg = 'Bot အမည် ထည့်သွင်းရန် လိုအပ်ပါသည်';
                        if (window.showError) {
                            window.showError(errorMsg);
                        } else if (window.showToast) {
                            window.showToast(errorMsg, 'error');
                        } else {
                            alert(errorMsg);
                        }
                        if (botNameInput) {
                            botNameInput.focus();
                            botNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                    
                    if (!initialGreeting) {
                        const errorMsg = 'Initial Greeting ထည့်သွင်းရန် လိုအပ်ပါသည်';
                        if (window.showError) {
                            window.showError(errorMsg);
                        } else if (window.showToast) {
                            window.showToast(errorMsg, 'error');
                        } else {
                            alert(errorMsg);
                        }
                        if (initialGreetingInput) {
                            initialGreetingInput.focus();
                            initialGreetingInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                    
                    // Collect all steps data using shared function (defined above)
                    const steps = collectAllSteps();
                    
                    // Validate steps (check for API/webhook URL requirements)
                    for (let i = 0; i < steps.length; i++) {
                        const step = steps[i];
                        if (step.type === 'api_call' && (!step.api_config || !step.api_config.url)) {
                            const errorMsg = `Step ${i + 1}: API URL is required for API Call type`;
                            if (window.showError) {
                                window.showError(errorMsg);
                            } else {
                                alert(errorMsg);
                            }
                            return;
                        }
                        if (step.type === 'webhook' && (!step.webhook_config || !step.webhook_config.url)) {
                            const errorMsg = `Step ${i + 1}: Webhook URL is required for Webhook type`;
                            if (window.showError) {
                                window.showError(errorMsg);
                            } else {
                                alert(errorMsg);
                            }
                            return;
                        }
                    }
                    
                    // Convert steps to JSON string
                    const stepsJson = JSON.stringify(steps);
                    
                    // Set in hidden input if it exists (may not exist in all views)
                    const stepsJsonInput = document.getElementById('stepsJson');
                    if (stepsJsonInput) {
                        stepsJsonInput.value = stepsJson;
                    }
                    
                    // Create form data object for POST request
                    const formData = {
                        botName: botName,
                        initialGreeting: initialGreeting,
                        stepsJson: stepsJson,
                        publish: false  // Default to draft
                    };
                    
                    console.log('Submitting Bot Configuration:', formData);
                    
                    // Show loading state
                    const submitBtn = botBuilderForm.querySelector('button[type="submit"]');
                    if (!submitBtn) {
                        console.error('Submit button not found');
                        return;
                    }
                    
                    const originalBtnText = submitBtn.innerHTML;
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                    
                    // Submit form data via fetch API (POST request)
                    fetch('{{ url_for("save_bot") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    })
                    .then(async response => {
                        console.log('Response status:', response.status);
                        console.log('Response ok:', response.ok);
                        console.log('Content-Type:', response.headers.get('Content-Type'));
                        
                        // Get response text first to check if it's JSON
                        const responseText = await response.text();
                        console.log('Response text (first 500 chars):', responseText.substring(0, 500));
                        
                        // Check if response is ok
                        if (!response.ok) {
                            // Try to parse as JSON for error message
                            try {
                                const errorData = JSON.parse(responseText);
                                throw new Error(errorData.error || `Server error: ${response.status}`);
                            } catch (parseErr) {
                                // If not JSON, use the text or status
                                throw new Error(responseText || `Server error: ${response.status}`);
                            }
                        }
                        
                        // Parse JSON response
                        try {
                            const data = JSON.parse(responseText);
                            console.log('Response data:', data);
                            
                            if (data && data.success) {
                                // Success - show success message
                                const successMsg = data.message || `Bot "${botName}" has been saved successfully!`;
                                if (window.showSuccess) {
                                    window.showSuccess(successMsg);
                                } else if (window.showToast) {
                                    window.showToast(successMsg, 'success');
                                } else if (window.showAlertMessage) {
                                    window.showAlertMessage(successMsg, 'success');
                                } else {
                                    alert(successMsg);
                                }
                                
                                // Reset chat session to allow new conversation
                                if (typeof chatSessionData !== 'undefined') {
                                    chatSessionData = {};
                                }
                                if (typeof chatBotName !== 'undefined') {
                                    chatBotName = botName; // Update bot name for chat
                                }
                                
                                // Reset button
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                                
                                console.log('Bot saved successfully!');
                            } else {
                                // Error - show error message
                                const errorMsg = (data && data.error) || 'Failed to save bot';
                                window.showAlertMessage(errorMsg, 'error');
                                
                                // Reset button
                                submitBtn.disabled = false;
                                submitBtn.innerHTML = originalBtnText;
                            }
                        } catch (parseErr) {
                            console.error('JSON parse error:', parseErr);
                            console.error('Response text that failed to parse:', responseText);
                            throw new Error('Invalid response from server. Server returned: ' + responseText.substring(0, 200));
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalBtnText;
                        window.showAlertMessage('Error: ' + error.message + '\n\nPlease check the console for more details.', 'error');
                    });
                    });
            }
        });

        // ========== Chat Widget JavaScript ==========
        
        // Chat session data
        let chatSessionData = {};
        let chatBotName = '';
        let chatSessionId = null;
        
        /**
         * Reset chat session to start new conversation
         */
        window.resetChatSession = async function() {
            try {
                // Reset session data and ID - completely clear all data including variables
                chatSessionData = {
                    conversation_started: false,
                    current_step: null,
                    step_history: [],
                    completed_steps: [],
                    variables: {},
                    last_user_message: '',
                    waiting_for_answer: false,
                    question_step_id: null
                };
                chatSessionId = null;
                
                const chatWidgetBody = document.getElementById('chatWidgetBody');
                const chatEmptyState = document.getElementById('chatEmptyState');
                const chatInput = document.getElementById('chatInput');
                const chatSendBtn = document.getElementById('chatSendBtn');
                
                if (!chatWidgetBody) {
                    console.error('Chat widget body not found');
                    return;
                }
                
                // Clear all chat messages - use more comprehensive selector
                const messages = chatWidgetBody.querySelectorAll('.chat-message, [class*="chat-message"]');
                messages.forEach(msg => msg.remove());
                
                // Clear any loading indicators or error messages
                const loadingIndicators = chatWidgetBody.querySelectorAll('.chat-loading, .chat-error, [class*="loading"], [class*="error"]');
                loadingIndicators.forEach(indicator => indicator.remove());
                
                // Clear all innerHTML except empty state (more thorough cleanup)
                const allChildren = Array.from(chatWidgetBody.children);
                allChildren.forEach(child => {
                    if (child.id !== 'chatEmptyState' && !child.classList.contains('chat-empty-state')) {
                        child.remove();
                    }
                });
                
                // Show empty state
                if (chatEmptyState) {
                    chatEmptyState.style.display = 'flex';
                }
                
                // Re-enable input and reset button states
                if (chatInput) {
                    chatInput.disabled = false;
                    chatInput.value = '';
                    chatInput.focus();
                }
                
                if (chatSendBtn) {
                    chatSendBtn.disabled = false;
                    chatSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                }
                
                // Scroll to top of chat widget
                chatWidgetBody.scrollTop = 0;
                
                // Optional: Send reset notification to backend (if needed in future)
                // For now, the backend is stateless, so just resetting frontend is sufficient
                
                console.log('Chat session reset successfully - all variables cleared');
                
                // Show brief visual feedback
                const resetBtn = document.getElementById('chatResetBtn');
                if (resetBtn) {
                    const originalBg = resetBtn.style.background;
                    resetBtn.style.background = 'rgba(34, 197, 94, 0.8)'; // Green flash
                    setTimeout(() => {
                        resetBtn.style.background = originalBg;
                    }, 300);
                }
                
            } catch (error) {
                console.error('Error resetting chat session:', error);
                alert('Error resetting chat session. Please try again.');
            }
        };
        
        // Initialize chat buttons with event listeners (backup to onclick)
        function initializeChatButtonListeners() {
            // Wait a bit for DOM to be fully ready
            setTimeout(function() {
                const chatSendBtn = document.getElementById('chatSendBtn');
                const chatResetBtn = document.getElementById('chatResetBtn');
                
                // Add click listener to send button
                if (chatSendBtn) {
                    // Remove any existing listeners by cloning
                    const sendBtnClone = chatSendBtn.cloneNode(true);
                    chatSendBtn.parentNode.replaceChild(sendBtnClone, chatSendBtn);
                    
                    sendBtnClone.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        if (typeof window.sendChatMessage === 'function') {
                            window.sendChatMessage();
                        } else {
                            console.error('sendChatMessage function not available');
                        }
                        return false;
                    });
                }
                
                // Add click listener to reset button
                if (chatResetBtn) {
                    // Remove any existing listeners by cloning
                    const resetBtnClone = chatResetBtn.cloneNode(true);
                    chatResetBtn.parentNode.replaceChild(resetBtnClone, chatResetBtn);
                    
                    resetBtnClone.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        if (typeof window.resetChatSession === 'function') {
                            window.resetChatSession();
                        } else {
                            console.error('resetChatSession function not available');
                        }
                        return false;
                    });
                }
            }, 100);
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeChatButtonListeners);
        } else {
            initializeChatButtonListeners();
        }
        
        /**
         * Export bot configuration
         */
        window.exportBot = async function(botName) {
            try {
                const response = await fetch(`/api/bot/export/${encodeURIComponent(botName)}`);
                const data = await response.json();
                
                if (data.success) {
                    // Download as JSON file
                    const blob = new Blob([JSON.stringify(data.bot_config, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${botName}_config.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    window.showAlertMessage(`Bot "${botName}" exported successfully!`, 'success');
                } else {
                    window.showAlertMessage(`Error: ${data.error}`, 'error');
                }
            } catch (error) {
                console.error('Export error:', error);
                window.showAlertMessage('Error exporting bot: ' + error.message, 'error');
            }
        }
        
        /**
         * Delete current bot from Bot Builder page
         */
        window.deleteCurrentBot = async function(botName) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete bot "${botName}"?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                // Encode bot name properly for URL
                const encodedBotName = encodeURIComponent(botName);
                
                // Try DELETE method first, fallback to POST if needed
                let response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // If DELETE fails, try POST
                if (!response.ok && response.status === 405) {
                    response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    window.showAlertMessage(`Bot "${botName}" deleted successfully!`, 'success');
                    // Redirect to My Bots page after a short delay
                    setTimeout(() => {
                        window.location.href = '/my-bots';
                    }, 1000);
                } else {
                    window.showAlertMessage(`Error: ${data.error || 'Failed to delete bot'}`, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                window.showAlertMessage('Error deleting bot: ' + error.message, 'error');
            }
        }
        
        /**
         * Delete bot function with confirmation
         */
        window.deleteBot = async function(botName) {
            // Show confirmation dialog
            if (!confirm(`Are you sure you want to delete bot "${botName}"?\n\nThis action cannot be undone!`)) {
                return;
            }
            
            try {
                // Encode bot name properly for URL
                const encodedBotName = encodeURIComponent(botName);
                
                // Try DELETE method first, fallback to POST if needed
                let response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                // If DELETE fails, try POST
                if (!response.ok && response.status === 405) {
                    response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                }
                
                const data = await response.json();
                
                if (data.success) {
                    window.showAlertMessage(`Bot "${botName}" deleted successfully!`, 'success');
                    // Reload the page after a short delay to refresh the bot list
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    window.showAlertMessage(`Error: ${data.error || 'Failed to delete bot'}`, 'error');
                }
            } catch (error) {
                console.error('Delete error:', error);
                window.showAlertMessage('Error deleting bot: ' + error.message, 'error');
            }
        }
        
        /**
         * Toggle select all checkboxes
         */
        window.toggleSelectAll = function(checkbox) {
            const botCheckboxes = document.querySelectorAll('.bot-checkbox');
            botCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateDeleteButton();
        }
        
        /**
         * Update delete selected button state
         */
        window.updateDeleteButton = function() {
            const selectedCheckboxes = document.querySelectorAll('.bot-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const selectedCount = document.getElementById('selectedCount');
            
            if (deleteBtn && selectedCount) {
                const count = selectedCheckboxes.length;
                selectedCount.textContent = count;
                deleteBtn.disabled = count === 0;
            }
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const allCheckboxes = document.querySelectorAll('.bot-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = selectedCheckboxes.length === allCheckboxes.length;
                selectAllCheckbox.indeterminate = selectedCheckboxes.length > 0 && selectedCheckboxes.length < allCheckboxes.length;
            }
        }
        
        /**
         * Delete selected bots
         */
        window.deleteSelectedBots = async function() {
            const selectedCheckboxes = document.querySelectorAll('.bot-checkbox:checked');
            const selectedBots = Array.from(selectedCheckboxes).map(cb => cb.value);
            
            if (selectedBots.length === 0) {
                window.showAlertMessage('Please select at least one bot to delete.', 'error');
                return;
            }
            
            // Show confirmation
            const confirmMessage = `Are you sure you want to delete ${selectedBots.length} selected bot(s)?\n\nBots to delete:\n${selectedBots.join('\n')}\n\nThis action cannot be undone!`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Delete all selected bots
            let successCount = 0;
            let failCount = 0;
            const errors = [];
            
            for (const botName of selectedBots) {
                try {
                    const encodedBotName = encodeURIComponent(botName);
                    let response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok && response.status === 405) {
                        response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                        errors.push(`${botName}: ${data.error || 'Unknown error'}`);
                    }
                } catch (error) {
                    console.error(`Error deleting bot ${botName}:`, error);
                    failCount++;
                    errors.push(`${botName}: ${error.message}`);
                }
            }
            
            // Show result
            if (successCount > 0) {
                let message = `Successfully deleted ${successCount} bot(s)`;
                if (failCount > 0) {
                    message += ` (${failCount} failed)`;
                }
                window.showAlertMessage(message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                window.showAlertMessage(`Failed to delete bots. Errors: ${errors.join('; ')}`, 'error');
            }
        }
        
        /**
         * Delete all test bots (bots with "Test" in the name)
         */
        window.deleteAllTestBots = async function() {
            // Get all bots from the table
            const botRows = document.querySelectorAll('#myBotsTable tbody tr');
            const testBots = [];
            
            botRows.forEach(row => {
                const botNameCell = row.querySelector('td:nth-child(2) strong');
                if (botNameCell) {
                    const botName = botNameCell.textContent.trim();
                    // Check if bot name contains "Test" (case insensitive)
                    if (botName.toLowerCase().includes('test') || 
                        botName.toLowerCase().includes('variable test') ||
                        botName.toLowerCase().includes('flow test') ||
                        botName.toLowerCase().includes('chat test') ||
                        botName.toLowerCase().includes('api test')) {
                        testBots.push(botName);
                    }
                }
            });
            
            if (testBots.length === 0) {
                window.showAlertMessage('No test bots found to delete.', 'info');
                return;
            }
            
            // Show confirmation
            const confirmMessage = `Are you sure you want to delete ${testBots.length} test bot(s)?\n\nBots to delete:\n${testBots.join('\n')}\n\nThis action cannot be undone!`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Delete all test bots
            let successCount = 0;
            let failCount = 0;
            
            for (const botName of testBots) {
                try {
                    const encodedBotName = encodeURIComponent(botName);
                    let response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok && response.status === 405) {
                        response = await fetch(`/api/bot/delete/${encodedBotName}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                    }
                    
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                    }
                } catch (error) {
                    console.error(`Error deleting bot ${botName}:`, error);
                    failCount++;
                }
            }
            
            // Show result
            if (successCount > 0) {
                window.showAlertMessage(`Successfully deleted ${successCount} test bot(s)${failCount > 0 ? ` (${failCount} failed)` : ''}!`, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                window.showAlertMessage(`Failed to delete test bots.`, 'error');
            }
        }
        
        /**
         * Import bot configuration
         */
        window.importBot = async function() {
            const fileInput = document.getElementById('importFile');
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                window.showAlertMessage('Please select a JSON file to import', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async function(e) {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    const botConfig = jsonData.bot_config || jsonData;
                    
                    const response = await fetch('/api/bot/import', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ bot_config: botConfig })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        window.showAlertMessage('Imported Successfully', 'success');
                        fileInput.value = '';
                        // Reload page after 1 second to show the new bot
                        setTimeout(() => {
                            window.location.href = '/my-bots';
                        }, 1000);
                    } else {
                        window.showAlertMessage(`Error: ${data.error}`, 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    window.showAlertMessage('Error importing bot: ' + error.message, 'error');
                }
            };
            
            reader.readAsText(file);
        }
        
        /**
         * Show embed code modal with generated JavaScript snippet
         */
        window.showEmbedCode = function(botName) {
            console.log('showEmbedCode called with botName:', botName);
            
            // Ensure botName is a string
            if (!botName) {
                alert('Error: Bot name is required');
                return;
            }
            
            try {
                // Check if modal element exists
                const modalElement = document.getElementById('embedCodeModal');
                if (!modalElement) {
                    console.error('Modal element not found');
                    alert('Error: Modal element not found. Please refresh the page.');
                    return;
                }
                
                console.log('Modal element found');
                
                // Set bot name in modal
                const botNameElement = document.getElementById('embedBotName');
                if (botNameElement) {
                    botNameElement.textContent = botName;
                } else {
                    console.warn('Bot name element not found');
                }
                
                // Get current host (for the API endpoint)
                const currentHost = window.location.origin;
                const apiUrl = currentHost + '/chat';
                
                // Generate embed code
                const embedCode = `<!-- AZone Chat Widget - ${botName} -->
<scr' + 'ipt>
(function() {
    // Configuration
    const BOT_NAME = '${botName}';
    const API_URL = '${apiUrl}';
    
    // Create widget container
    const widgetContainer = document.createElement('div');
    widgetContainer.id = 'azone-chat-widget';
    widgetContainer.style.cssText = \`
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 350px;
        height: 500px;
        max-height: 80vh;
        background: linear-gradient(135deg, #1A233A 0%, #0E121F 100%);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        display: none;
        flex-direction: column;
        z-index: 10000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        border: 1px solid #3B5D9A;
    \`;
    
    // Create toggle button
    const toggleButton = document.createElement('button');
    toggleButton.id = 'azone-chat-toggle';
    toggleButton.style.cssText = \`
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(90deg, #63C7FF 0%, #3B5D9A 100%);
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        z-index: 10001;
        transition: transform 0.2s;
    \`;
    toggleButton.innerHTML = '<i class="fas fa-comments"></i>';
    toggleButton.onclick = function() {
        const isVisible = widgetContainer.style.display !== 'none';
        widgetContainer.style.display = isVisible ? 'none' : 'flex';
        toggleButton.style.display = isVisible ? 'block' : 'none';
    };
    
    // Widget header
    const header = document.createElement('div');
    header.style.cssText = \`
        background: linear-gradient(180deg, #1A233A 0%, #0E121F 100%);
        padding: 15px;
        border-radius: 15px 15px 0 0;
        border-bottom: 1px solid #3B5D9A;
        display: flex;
        justify-content: space-between;
        align-items: center;
    \`;
    header.innerHTML = \`
        <h6 style="margin: 0; color: #63C7FF;">
            <i class="fas fa-robot"></i> \${BOT_NAME}
        </h6>
        <button onclick="document.getElementById('azone-chat-widget').style.display='none'; document.getElementById('azone-chat-toggle').style.display='block';" 
                style="background: none; border: none; color: #F0F4F8; cursor: pointer; font-size: 20px;">
            <i class="fas fa-times"></i>
        </button>
    \`;
    
    // Chat messages area
    const messagesArea = document.createElement('div');
    messagesArea.id = 'azone-messages';
    messagesArea.style.cssText = \`
        flex: 1;
        overflow-y: auto;
        padding: 15px;
        background-color: #0E121F;
    \`;
    
    // Input area
    const inputArea = document.createElement('div');
    inputArea.style.cssText = \`
        padding: 15px;
        border-top: 1px solid #3B5D9A;
        background-color: #1A233A;
        border-radius: 0 0 15px 15px;
    \`;
    const inputWrapper = document.createElement('div');
    inputWrapper.style.cssText = 'display: flex; gap: 10px;';
    const input = document.createElement('input');
    input.type = 'text';
    input.placeholder = 'Type a message...';
    input.id = 'azone-chat-input';
    input.style.cssText = \`
        flex: 1;
        padding: 10px;
        border: 1px solid #3B5D9A;
        border-radius: 20px;
        background-color: #0E121F;
        color: #F0F4F8;
        outline: none;
    \`;
    const sendButton = document.createElement('button');
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
    sendButton.style.cssText = \`
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        background: linear-gradient(90deg, #63C7FF 0%, #3B5D9A 100%);
        color: white;
        cursor: pointer;
    \`;
    
    // Session data
    let sessionData = {};
    let sessionId = null;
    
    // Add message to chat
    function addMessage(text, isBot = false) {
        const messageDiv = document.createElement('div');
        messageDiv.style.cssText = \`
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 80%;
            word-wrap: break-word;
            \${isBot ? 'background-color: #1A233A; color: #F0F4F8; margin-right: auto;' : 'background: linear-gradient(90deg, #63C7FF 0%, #3B5D9A 100%); color: white; margin-left: auto; text-align: right;'}
        \`;
        messageDiv.textContent = text;
        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }
    
    // Send message
    async function sendMessage() {
        const message = input.value.trim();
        if (!message) return;
        
        addMessage(message, false);
        input.value = '';
        input.disabled = true;
        sendButton.disabled = true;
        sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }
            
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    bot_name: BOT_NAME,
                    user_message: message,
                    session_data: sessionData,
                    session_id: sessionId
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addMessage(data.bot_response, true);
                sessionData = data.session_data || {};
                sessionId = data.session_id || sessionId;
            } else {
                addMessage('Error: ' + (data.error || 'Failed to get response'), true);
            }
        } catch (error) {
            addMessage('Error: ' + error.message, true);
        } finally {
            input.disabled = false;
            sendButton.disabled = false;
            sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }
    }
    
    sendButton.onclick = sendMessage;
    input.onkeypress = function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    };
    
    inputWrapper.appendChild(input);
    inputWrapper.appendChild(sendButton);
    inputArea.appendChild(inputWrapper);
    
    widgetContainer.appendChild(header);
    widgetContainer.appendChild(messagesArea);
    widgetContainer.appendChild(inputArea);
    
    document.body.appendChild(widgetContainer);
    document.body.appendChild(toggleButton);
    
    // Load Font Awesome if not already loaded
    if (!document.querySelector('link[href*="font-awesome"]')) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
        document.head.appendChild(link);
    }
    
    // Show initial greeting
    setTimeout(() => {
        addMessage('Hello! I\\'m ' + BOT_NAME + '. How can I help you today?', true);
    }, 500);
})();
<\/script>`;
            
                // Set embed code in textarea
                const embedCodeText = document.getElementById('embedCodeText');
                if (embedCodeText) {
                    embedCodeText.value = embedCode;
                }
                
                // Hide copy success message
                const copySuccessMsg = document.getElementById('copySuccessMessage');
                if (copySuccessMsg) {
                    copySuccessMsg.style.display = 'none';
                }
                
                // Show modal using Bootstrap or fallback
                console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
                
                // Function to show modal
                function showModal() {
                    modalElement.style.display = 'block';
                    modalElement.classList.add('show');
                    modalElement.setAttribute('aria-hidden', 'false');
                    modalElement.style.zIndex = '1055';
                    document.body.classList.add('modal-open');
                    
                    // Create or update backdrop
                    let backdrop = document.getElementById('embedModalBackdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.className = 'modal-backdrop fade show';
                        backdrop.id = 'embedModalBackdrop';
                        backdrop.style.zIndex = '1050';
                        document.body.appendChild(backdrop);
                    }
                    
                    // Close button handlers
                    const closeButtons = modalElement.querySelectorAll('[data-bs-dismiss="modal"], .btn-close, button[data-bs-dismiss]');
                    closeButtons.forEach(btn => {
                        btn.onclick = function() {
                            hideModal();
                        };
                    });
                    
                    // Close on backdrop click
                    backdrop.onclick = function() {
                        hideModal();
                    };
                }
                
                // Function to hide modal
                function hideModal() {
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    modalElement.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('modal-open');
                    
                    const backdrop = document.getElementById('embedModalBackdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                }
                
                // Try Bootstrap first, then fallback
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    console.log('Using Bootstrap Modal');
                    try {
                        const modal = new bootstrap.Modal(modalElement, {
                            backdrop: true,
                            keyboard: true
                        });
                        modal.show();
                    } catch (e) {
                        console.error('Bootstrap Modal error:', e);
                        showModal();
                    }
                } else {
                    console.log('Using fallback modal display');
                    showModal();
                }
            } catch (error) {
                console.error('Error showing embed code modal:', error);
                alert('Error: ' + error.message + '\n\nPlease check the browser console for details.');
            }
        }
        
        /**
         * Copy embed code to clipboard
         */
        window.copyEmbedCode = function() {
            const embedCodeText = document.getElementById('embedCodeText');
            embedCodeText.select();
            embedCodeText.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // Show success message
                const successMsg = document.getElementById('copySuccessMessage');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);
            } catch (err) {
                // Fallback for modern browsers
                navigator.clipboard.writeText(embedCodeText.value).then(() => {
                    const successMsg = document.getElementById('copySuccessMessage');
                    successMsg.style.display = 'block';
                    setTimeout(() => {
                        successMsg.style.display = 'none';
                    }, 3000);
                }).catch(() => {
                    alert('Failed to copy. Please select and copy manually.');
                });
            }
        }
        
        // Chat widget functions are defined at the top of the script to avoid reference errors
        
        /**
         * Handle Enter key press in chat input
         */
        window.handleChatKeyPress = function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                if (typeof window.sendChatMessage === 'function') {
                    window.sendChatMessage();
                }
            }
        }
        
        /**
         * Telegram Integration Functions
         */
        async function connectTelegram(botName) {
            const tokenInput = document.getElementById(`telegram-token-${botName.replace(/ /g, '_')}`);
            const token = tokenInput ? tokenInput.value.trim() : '';
            
            if (!token) {
                const errorMsg = 'Telegram bot token ထည့်သွင်းရန် လိုအပ်ပါသည်။';
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            try {
                if (window.showToast) {
                    window.showToast('Telegram နှင့် ချိတ်ဆက်နေသည်...', 'info');
                }
                
                const response = await fetch(`/api/telegram/connect/${encodeURIComponent(botName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bot_token: token })
                });
                
                const data = await response.json();
                if (data.success) {
                    const successMsg = data.message || 'Telegram နှင့် အောင်မြင်စွာ ချိတ်ဆက်လိုက်ပါပြီ!';
                    if (window.showSuccess) {
                        window.showSuccess(successMsg);
                    } else if (window.showToast) {
                        window.showToast(successMsg, 'success');
                    } else {
                        alert(successMsg);
                    }
                    checkTelegramStatus(botName);
                } else {
                    const errorMsg = 'အမှား: ' + (data.error || 'Unknown error');
                    if (window.showError) {
                        window.showError(errorMsg);
                    } else if (window.showToast) {
                        window.showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                const errorMsg = 'Telegram ချိတ်ဆက်ရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }
        
        async function disconnectTelegram(botName) {
            if (!confirm(`Telegram bot "${botName}" ကို disconnect လုပ်ရန် သေချာပါသလား?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/telegram/disconnect/${encodeURIComponent(botName)}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    const successMsg = data.message || 'Telegram မှ disconnect လုပ်ပြီးပါပြီ။';
                    if (window.showSuccess) {
                        window.showSuccess(successMsg);
                    } else if (window.showToast) {
                        window.showToast(successMsg, 'success');
                    } else {
                        alert(successMsg);
                    }
                    checkTelegramStatus(botName);
                } else {
                    const errorMsg = 'အမှား: ' + (data.error || 'Unknown error');
                    if (window.showError) {
                        window.showError(errorMsg);
                    } else if (window.showToast) {
                        window.showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                const errorMsg = 'Disconnect လုပ်ရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }
        
        async function checkTelegramStatus(botName) {
            try {
                // Preserve token input value before status check
                const botNameSafe = botName.replace(/ /g, '_');
                const tokenInput = document.getElementById(`telegram-token-${botNameSafe}`);
                const savedToken = tokenInput ? tokenInput.value : '';
                
                const response = await fetch(`/api/telegram/status/${encodeURIComponent(botName)}`);
                const data = await response.json();
                
                const statusText = document.getElementById(`telegram-status-text-${botNameSafe}`);
                if (statusText) {
                    if (data.connected) {
                        statusText.textContent = 'Connected';
                        statusText.className = 'badge bg-success';
                    } else {
                        statusText.textContent = 'Not Connected';
                        statusText.className = 'badge bg-secondary';
                    }
                }
                
                // Restore token input value after status check
                if (tokenInput && savedToken) {
                    tokenInput.value = savedToken;
                }
            } catch (error) {
                console.error('Error checking Telegram status:', error);
            }
        }
        
        // Facebook Messenger Integration Functions
        async function connectFacebook(botName) {
            const botNameSafe = botName.replace(/ /g, '_');
            const tokenInput = document.getElementById(`facebook-token-${botNameSafe}`);
            const pageAccessToken = tokenInput ? tokenInput.value.trim() : '';
            
            if (!pageAccessToken) {
                const errorMsg = 'Facebook Page Access Token ထည့်သွင်းရန် လိုအပ်ပါသည်။';
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                return;
            }
            
            try {
                if (window.showToast) {
                    window.showToast('Facebook Messenger နှင့် ချိတ်ဆက်နေသည်...', 'info');
                }
                
                const response = await fetch(`/api/facebook/connect/${encodeURIComponent(botName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ page_access_token: pageAccessToken })
                });
                
                const data = await response.json();
                if (data.success) {
                    const successMsg = data.message || 'Facebook Messenger နှင့် အောင်မြင်စွာ ချိတ်ဆက်လိုက်ပါပြီ!';
                    if (window.showSuccess) {
                        window.showSuccess(successMsg);
                    } else if (window.showToast) {
                        window.showToast(successMsg, 'success');
                    } else {
                        alert(successMsg);
                    }
                    checkFacebookStatus(botName);
                } else {
                    const errorMsg = 'အမှား: ' + (data.error || 'Unknown error');
                    if (window.showError) {
                        window.showError(errorMsg);
                    } else if (window.showToast) {
                        window.showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                const errorMsg = 'Facebook ချိတ်ဆက်ရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }
        
        async function disconnectFacebook(botName) {
            if (!confirm(`Facebook bot "${botName}" ကို disconnect လုပ်ရန် သေချာပါသလား?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/facebook/disconnect/${encodeURIComponent(botName)}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    const successMsg = data.message || 'Facebook Messenger မှ disconnect လုပ်ပြီးပါပြီ။';
                    if (window.showSuccess) {
                        window.showSuccess(successMsg);
                    } else if (window.showToast) {
                        window.showToast(successMsg, 'success');
                    } else {
                        alert(successMsg);
                    }
                    checkFacebookStatus(botName);
                } else {
                    const errorMsg = 'အမှား: ' + (data.error || 'Unknown error');
                    if (window.showError) {
                        window.showError(errorMsg);
                    } else if (window.showToast) {
                        window.showToast(errorMsg, 'error');
                    } else {
                        alert(errorMsg);
                    }
                }
            } catch (error) {
                const errorMsg = 'Facebook disconnect လုပ်ရာတွင် အမှားအယွင်း: ' + error.message;
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
            }
        }
        
        async function checkFacebookStatus(botName) {
            try {
                // Preserve token input value before status check
                const botNameSafe = botName.replace(/ /g, '_');
                const tokenInput = document.getElementById(`facebook-token-${botNameSafe}`);
                const savedToken = tokenInput ? tokenInput.value : '';
                
                const response = await fetch(`/api/facebook/status/${encodeURIComponent(botName)}`);
                const data = await response.json();
                
                const statusText = document.getElementById(`facebook-status-text-${botNameSafe}`);
                if (statusText) {
                    if (data.connected) {
                        statusText.textContent = 'Connected';
                        statusText.className = 'badge bg-success';
                    } else {
                        statusText.textContent = 'Not Connected';
                        statusText.className = 'badge bg-secondary';
                    }
                }
                
                // Update webhook URL if available
                if (data.webhook_url) {
                    const webhookUrlElement = document.getElementById('facebookWebhookUrl');
                    if (webhookUrlElement) {
                        webhookUrlElement.textContent = data.webhook_url;
                    }
                }
                
                // Restore token input value after status check
                if (tokenInput && savedToken) {
                    tokenInput.value = savedToken;
                }
            } catch (error) {
                console.error('Error checking Facebook status:', error);
            }
        }
        
        // Load webhook URL on page load
        async function loadWebhookUrl() {
            try {
                const response = await fetch('/api/facebook/webhook-url');
                const data = await response.json();
                if (data.success) {
                    const webhookUrlElement = document.getElementById('facebookWebhookUrl');
                    const verifyTokenElement = document.getElementById('facebookVerifyToken');
                    if (webhookUrlElement) {
                        webhookUrlElement.textContent = data.webhook_url;
                    }
                    if (verifyTokenElement) {
                        verifyTokenElement.textContent = data.verify_token;
                    }
                }
            } catch (error) {
                console.error('Error loading webhook URL:', error);
                const webhookUrlElement = document.getElementById('facebookWebhookUrl');
                if (webhookUrlElement) {
                    webhookUrlElement.textContent = window.location.origin + '/webhook/facebook';
                }
            }
        }
        
        // Copy webhook URL to clipboard
        function copyWebhookUrl() {
            const webhookUrlElement = document.getElementById('facebookWebhookUrl');
            if (webhookUrlElement) {
                const webhookUrl = webhookUrlElement.textContent.trim();
                navigator.clipboard.writeText(webhookUrl).then(() => {
                    if (window.showToast) {
                        window.showToast('Webhook URL copied to clipboard!', 'success');
                    } else {
                        alert('Webhook URL copied to clipboard!');
                    }
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    if (window.showToast) {
                        window.showToast('Failed to copy webhook URL', 'error');
                    }
                });
            }
        }
        
        // Copy template webhook URL
        function copyTemplateWebhookUrl() {
            const webhookUrlElement = document.getElementById('templateWebhookUrl');
            if (webhookUrlElement) {
                const webhookUrl = webhookUrlElement.textContent.trim();
                navigator.clipboard.writeText(webhookUrl).then(() => {
                    if (window.showToast) {
                        window.showToast('Webhook URL copied to clipboard!', 'success');
                    } else {
                        alert('Webhook URL copied to clipboard!');
                    }
                }).catch(err => {
                    console.error('Failed to copy:', err);
                });
            }
        }
        
        // Check Telegram and Facebook status on page load if bot_data exists
        {% if bot_data %}
        document.addEventListener('DOMContentLoaded', function() {
            const botName = '{{ bot_data.bot_name }}';
            const botNameSafe = botName.replace(/ /g, '_');
            
            // Restore saved tokens from localStorage
            const savedTelegramToken = localStorage.getItem(`telegram_token_${botNameSafe}`);
            const savedFacebookToken = localStorage.getItem(`facebook_token_${botNameSafe}`);
            
            if (savedTelegramToken) {
                const telegramTokenInput = document.getElementById(`telegram-token-${botNameSafe}`);
                if (telegramTokenInput && !telegramTokenInput.value) {
                    telegramTokenInput.value = savedTelegramToken;
                }
            }
            
            if (savedFacebookToken) {
                const facebookTokenInput = document.getElementById(`facebook-token-${botNameSafe}`);
                if (facebookTokenInput && !facebookTokenInput.value) {
                    facebookTokenInput.value = savedFacebookToken;
                }
            }
            
            // Save tokens to localStorage when user types
            const telegramTokenInput = document.getElementById(`telegram-token-${botNameSafe}`);
            if (telegramTokenInput) {
                telegramTokenInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        localStorage.setItem(`telegram_token_${botNameSafe}`, this.value);
                    } else {
                        localStorage.removeItem(`telegram_token_${botNameSafe}`);
                    }
                });
            }
            
            const facebookTokenInput = document.getElementById(`facebook-token-${botNameSafe}`);
            if (facebookTokenInput) {
                facebookTokenInput.addEventListener('input', function() {
                    if (this.value.trim()) {
                        localStorage.setItem(`facebook_token_${botNameSafe}`, this.value);
                    } else {
                        localStorage.removeItem(`facebook_token_${botNameSafe}`);
                    }
                });
            }
            
            // Check status
            checkTelegramStatus(botName);
            checkFacebookStatus(botName);
            loadWebhookUrl();
        });
        {% endif %}
        
        // Load webhook URL on page load (for all pages)
        document.addEventListener('DOMContentLoaded', function() {
            loadWebhookUrl();
        });
        
        /**
         * Send chat message to API
         */
        window.sendChatMessage = async function() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const chatWidgetBody = document.getElementById('chatWidgetBody');
            const chatEmptyState = document.getElementById('chatEmptyState');
            const userMessage = chatInput.value.trim();
            
            if (!userMessage) {
                return;
            }
            
            // Get bot name from form or flow view
            const botNameInput = document.getElementById('botName');
            const botNameFlowViewInput = document.getElementById('botNameFlowView');
            chatBotName = '';
            
            if (botNameInput && botNameInput.value.trim()) {
                chatBotName = botNameInput.value.trim();
            } else if (botNameFlowViewInput && botNameFlowViewInput.value.trim()) {
                chatBotName = botNameFlowViewInput.value.trim();
            }
            
            if (!chatBotName) {
                const errorMsg = 'Bot အမည် ထည့်သွင်းရန် လိုအပ်ပါသည်။ Test Chat မစတင်မီ Bot အမည် ထည့်သွင်းပါ။';
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                if (botNameFlowViewInput) {
                    botNameFlowViewInput.focus();
                } else if (botNameInput) {
                    botNameInput.focus();
                }
                return;
            }
            
            // Check if bot has steps - need at least initial greeting or steps to test
            const stepsJsonInput = document.getElementById('stepsJson');
            let stepsData = [];
            try {
                if (stepsJsonInput && stepsJsonInput.value) {
                    stepsData = JSON.parse(stepsJsonInput.value);
                }
            } catch (e) {
                console.error('Error parsing steps:', e);
            }
            
            // Check flow nodes if in Visual Flow View
            let hasFlowNodes = false;
            if (typeof flowNodes !== 'undefined' && flowNodes.length > 0) {
                // Count flow nodes that are not 'start' type (start node doesn't count as a step)
                const validFlowNodes = flowNodes.filter(node => 
                    node.type && 
                    node.type !== 'start' && 
                    node.content && 
                    node.content.trim()
                );
                hasFlowNodes = validFlowNodes.length > 0;
            }
            
            const initialGreetingInput = document.getElementById('initialGreeting');
            const hasInitialGreeting = initialGreetingInput && initialGreetingInput.value.trim();
            const hasSteps = stepsData && stepsData.length > 0;
            
            if (!hasInitialGreeting && !hasSteps && !hasFlowNodes) {
                const errorMsg = 'Test Chat စတင်ရန် Initial Greeting သို့မဟုတ် Steps ထည့်သွင်းရန် လိုအပ်ပါသည်။';
                if (window.showError) {
                    window.showError(errorMsg);
                } else if (window.showToast) {
                    window.showToast(errorMsg, 'error');
                } else {
                    alert(errorMsg);
                }
                chatInput.focus();
                return;
            }
            
            // Disable input and button
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            chatSendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            // Hide empty state
            if (chatEmptyState) {
                chatEmptyState.style.display = 'none';
            }
            
            // Add user message to chat
            addChatMessage(userMessage, 'user');
            
            // Clear input
            chatInput.value = '';
            
            try {
                // Initialize session ID if not exists
                if (!chatSessionId) {
                    chatSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                }
                
                // Auto-save bot before testing (works for both form view and flow view)
                let needsAutoSave = false;
                let botSteps = [];
                let botInitialGreeting = '';
                
                // Collect bot data from form view or flow view
                if (hasFlowNodes && typeof collectAllSteps === 'function') {
                    // Flow view: collect from flow nodes
                    botSteps = collectAllSteps();
                    botInitialGreeting = initialGreetingInput ? initialGreetingInput.value.trim() : '';
                } else {
                    // Form view: collect from form inputs
                    botSteps = stepsData || [];
                    botInitialGreeting = initialGreetingInput ? initialGreetingInput.value.trim() : '';
                }
                
                // Check if bot exists in database by trying to fetch draft version
                try {
                    const checkResponse = await fetch(`/api/bot/${encodeURIComponent(chatBotName)}/draft`);
                    if (!checkResponse.ok || checkResponse.status === 404) {
                        needsAutoSave = true;
                    }
                } catch (e) {
                    // If check fails, assume bot doesn't exist
                    needsAutoSave = true;
                }
                
                // Auto-save bot if it doesn't exist
                if (needsAutoSave) {
                    console.log('Auto-saving bot before testing...');
                    if (window.showToast) {
                        window.showToast('Bot ကို auto-save လုပ်နေသည်...', 'info');
                    }
                    
                    // Prepare form data for saving
                    const saveFormData = {
                        botName: chatBotName,
                        initialGreeting: botInitialGreeting || 'Hello! How can I help you?',
                        stepsJson: JSON.stringify(botSteps),
                        publish: false  // Save as draft
                    };
                    
                    const saveResponse = await fetch('{{ url_for("save_bot") }}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(saveFormData)
                    });
                    
                    if (saveResponse.ok) {
                        const saveData = await saveResponse.json();
                        if (saveData.success) {
                            console.log('Bot auto-saved successfully');
                            if (window.showToast) {
                                window.showToast('Bot ကို auto-save လုပ်ပြီးပါပြီ။ Test Chat စတင်နေသည်...', 'success');
                            }
                        } else {
                            console.warn('Auto-save failed:', saveData.error);
                            throw new Error(saveData.error || 'Bot save လုပ်ရာတွင် အမှားအယွင်း ဖြစ်ပွားပါသည်။');
                        }
                    } else {
                        const errorText = await saveResponse.text();
                        let errorMsg = 'Bot save လုပ်ရာတွင် အမှားအယွင်း ဖြစ်ပွားပါသည်။';
                        try {
                            const errorData = JSON.parse(errorText);
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            errorMsg = errorText || errorMsg;
                        }
                        throw new Error(errorMsg);
                    }
                }
                
                // Prepare request data
                const requestData = {
                    bot_name: chatBotName,
                    user_message: userMessage,
                    session_data: chatSessionData,
                    session_id: chatSessionId
                };
                
                console.log('Sending chat request:', { bot_name: chatBotName, user_message: userMessage.substring(0, 50) });
                
                // Try to send POST request to /chat endpoint
                // First try regular chat (for saved/published bots)
                let response;
                try {
                    // Create abort controller for timeout (fallback for older browsers)
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                    
                    response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                } catch (fetchError) {
                    // Handle network errors
                    if (fetchError.name === 'AbortError' || fetchError.name === 'TimeoutError') {
                        throw new Error('Request timeout. Please try again.');
                    } else if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {
                        throw new Error('Cannot connect to server. Please check if the server is running.');
                    } else {
                        throw fetchError;
                    }
                }
                
                // If bot not found, try draft test endpoint
                if (!response.ok && response.status === 404) {
                    console.log('Bot not found in live, trying draft test...');
                    try {
                        // Create abort controller for timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                        
                        response = await fetch(`/api/bot/${encodeURIComponent(chatBotName)}/test-draft`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                user_message: userMessage,
                                session_data: chatSessionData,
                                session_id: chatSessionId
                            }),
                            signal: controller.signal
                        });
                        
                        clearTimeout(timeoutId);
                    } catch (fetchError) {
                        if (fetchError.name === 'AbortError' || fetchError.name === 'TimeoutError') {
                            throw new Error('Request timeout. Please try again.');
                        } else if (fetchError.name === 'TypeError' && fetchError.message.includes('fetch')) {
                            throw new Error('Cannot connect to server. Please check if the server is running.');
                        } else {
                            throw fetchError;
                        }
                    }
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        errorMsg = errorText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // Update session data and session ID
                    chatSessionData = data.session_data || {};
                    if (data.session_id) {
                        chatSessionId = data.session_id;
                    }
                    
                    // Add bot response to chat
                    addChatMessage(data.bot_response, 'bot');
                } else {
                    // Show error message
                    addChatMessage('Error: ' + (data.error || 'Unknown error occurred'), 'error');
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                // Provide more detailed error message in Burmese
                let errorMessage = 'Chat API နှင့် ချိတ်ဆက်ရာတွင် အမှားအယွင်း ဖြစ်ပွားပါသည်။';
                
                if (error.message) {
                    // Translate common error messages
                    if (error.message.includes('Draft version') && error.message.includes('not found')) {
                        errorMessage = `Bot "${chatBotName}" ကို ပထမဦးစွာ save လုပ်ရန် လိုအပ်ပါသည်။ "Save Bot Configuration" button ကို နှိပ်ပါ။`;
                    } else if (error.message.includes('not found')) {
                        errorMessage = `Bot "${chatBotName}" ကို မတွေ့ပါ။ Bot ကို save လုပ်ပြီးပါပြီလား?`;
                    } else if (error.message.includes('save') || error.message.includes('Save')) {
                        errorMessage = error.message;
                    } else {
                        errorMessage += ' ' + error.message;
                    }
                } else if (error.name === 'TypeError' && error.message && error.message.includes('fetch')) {
                    errorMessage = 'Server နှင့် ချိတ်ဆက်ရာတွင် အမှားအယွင်း ဖြစ်ပွားပါသည်။ Server ကို စစ်ဆေးပါ။';
                } else if (error.name === 'NetworkError' || (error.message && error.message.includes('network'))) {
                    errorMessage = 'Network error ဖြစ်ပွားပါသည်။ Internet connection ကို စစ်ဆေးပါ။';
                }
                
                addChatMessage(errorMessage, 'error');
            } finally {
                // Re-enable input and button
                chatInput.disabled = false;
                chatSendBtn.disabled = false;
                chatSendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                chatInput.focus();
                
                // Scroll to bottom
                scrollChatToBottom();
            }
        }
        
        /**
         * Add message to chat history
         */
        function addChatMessage(message, type) {
            const chatWidgetBody = document.getElementById('chatWidgetBody');
            const chatEmptyState = document.getElementById('chatEmptyState');
            
            // Hide empty state if exists
            if (chatEmptyState) {
                chatEmptyState.style.display = 'none';
            }
            
            // Create message element
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            messageDiv.innerHTML = `
                <div class="chat-message-bubble">${escapeHtml(message)}</div>
                <div class="chat-message-time">${time}</div>
            `;
            
            chatWidgetBody.appendChild(messageDiv);
            
            // Scroll to bottom
            scrollChatToBottom();
        }
        
        /**
         * Scroll chat to bottom
         */
        function scrollChatToBottom() {
            const chatWidgetBody = document.getElementById('chatWidgetBody');
            if (chatWidgetBody) {
                chatWidgetBody.scrollTop = chatWidgetBody.scrollHeight;
            }
        }
        
        /**
         * Escape HTML to prevent XSS
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ========== Visual Flow Builder JavaScript ==========
        
        let flowNodes = [];
        let flowConnections = [];
        let selectedNode = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let flowNodeCounter = 0;
        
        // switchToFormView and switchToFlowView are defined in the head section
        // This is a placeholder to prevent errors if referenced before full load
        
        /**
         * Switch to Flow View (enhanced version with flow sync)
         */
        if (typeof window.switchToFlowView === 'function') {
            // Override with enhanced version that includes flow sync
            const originalSwitchToFlowView = window.switchToFlowView;
            window.switchToFlowView = function() {
                originalSwitchToFlowView();
                // Additional flow-specific logic
                const formContainer = document.getElementById('formViewContainer');
                const flowContainer = document.getElementById('flowViewContainer');
                const formBtn = document.getElementById('formViewBtn');
                const flowBtn = document.getElementById('flowViewBtn');
                if (formContainer) formContainer.style.display = 'none';
                if (flowContainer) flowContainer.style.display = 'block';
                if (formBtn) formBtn.classList.remove('active');
                if (flowBtn) flowBtn.classList.add('active');
                
                // Sync bot name from form view to flow view
                if (typeof window.syncBotNameToFlowView === 'function') {
                    window.syncBotNameToFlowView();
                }
                
                // Sync form steps to flow if flow is empty
                if (typeof syncFormToFlow === 'function' && typeof flowNodes !== 'undefined' && flowNodes.length === 0) {
                    syncFormToFlow();
                }
                
                // Draw connections
                if (typeof drawFlowConnections === 'function') {
                    drawFlowConnections();
                }
            };
        } else {
            window.switchToFlowView = function() {
                document.getElementById('formViewContainer').style.display = 'none';
                document.getElementById('flowViewContainer').style.display = 'block';
                document.getElementById('formViewBtn').classList.remove('active');
                document.getElementById('flowViewBtn').classList.add('active');
                
                // Sync bot name from form view to flow view
                if (typeof window.syncBotNameToFlowView === 'function') {
                    window.syncBotNameToFlowView();
                }
                
                // Sync form steps to flow if flow is empty
                if (flowNodes.length === 0) {
                    syncFormToFlow();
                }
                
                // Draw connections
                drawFlowConnections();
            };
        }
        
        /**
         * Add a new flow node
         */
        window.addFlowNode = function(nodeType = 'message') {
            flowNodeCounter++;
            const nodeId = 'flow-node-' + flowNodeCounter;
            
            const node = {
                id: nodeId,
                type: nodeType,
                content: '',
                x: 200 + (flowNodes.length * 250),
                y: 150 + (Math.floor(flowNodes.length / 3) * 200),
                data: {}
            };
            
            flowNodes.push(node);
            renderFlowNode(node);
            drawFlowConnections();
        }
        
        /**
         * Render a flow node
         */
        function renderFlowNode(node) {
            const container = document.getElementById('flowNodesContainer');
            const nodeElement = document.createElement('div');
            nodeElement.className = `flow-node flow-node-${node.type}`;
            nodeElement.id = node.id;
            nodeElement.style.left = node.x + 'px';
            nodeElement.style.top = node.y + 'px';
            
            // Set icon and label based on node type
            let icon, label;
            switch(node.type) {
                case 'start':
                    icon = 'fa-play';
                    label = 'Start';
                    break;
                case 'message':
                    icon = 'fa-comment';
                    label = 'Message';
                    break;
                case 'question':
                    icon = 'fa-question-circle';
                    label = 'Question';
                    break;
                case 'api_call':
                    icon = 'fa-plug';
                    label = 'API Call';
                    break;
                case 'webhook':
                    icon = 'fa-link';
                    label = 'Webhook';
                    break;
                default:
                    icon = 'fa-circle';
                    label = 'Node';
            }
            
            nodeElement.innerHTML = `
                <div class="flow-node-actions">
                    <button class="flow-node-action-btn flow-node-edit-btn" onclick="editFlowNode('${node.id}')" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="flow-node-action-btn" onclick="deleteFlowNode('${node.id}')" title="Delete">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="flow-node-content" onclick="selectFlowNode('${node.id}')">
                    <i class="fas ${icon}"></i>
                    <div class="flow-node-label">${label}</div>
                    ${node.content ? `<div style="font-size: 0.75rem; margin-top: 5px; opacity: 0.9;">${node.content.substring(0, 20)}${node.content.length > 20 ? '...' : ''}</div>` : ''}
                </div>
                <div class="flow-node-connector input"></div>
                <div class="flow-node-connector output"></div>
            `;
            
            // Make node draggable
            makeNodeDraggable(nodeElement, node);
            
            container.appendChild(nodeElement);
        }
        
        /**
         * Make node draggable
         */
        function makeNodeDraggable(element, node) {
            element.addEventListener('mousedown', function(e) {
                if (e.target.closest('.flow-node-action-btn')) return;
                
                isDragging = true;
                selectedNode = node;
                element.classList.add('selected');
                
                const rect = element.getBoundingClientRect();
                const canvasRect = document.getElementById('flowCanvas').getBoundingClientRect();
                dragOffset.x = e.clientX - rect.left;
                dragOffset.y = e.clientY - rect.top;
                
                e.preventDefault();
            });
        }
        
        /**
         * Handle mouse move for dragging
         */
        document.addEventListener('mousemove', function(e) {
            if (isDragging && selectedNode) {
                const canvas = document.getElementById('flowCanvas');
                const canvasRect = canvas.getBoundingClientRect();
                
                const x = e.clientX - canvasRect.left - dragOffset.x;
                const y = e.clientY - canvasRect.top - dragOffset.y;
                
                selectedNode.x = Math.max(0, Math.min(x, canvas.offsetWidth - 150));
                selectedNode.y = Math.max(0, Math.min(y, canvas.offsetHeight - 100));
                
                const nodeElement = document.getElementById(selectedNode.id);
                if (nodeElement) {
                    nodeElement.style.left = selectedNode.x + 'px';
                    nodeElement.style.top = selectedNode.y + 'px';
                }
                
                drawFlowConnections();
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                if (selectedNode) {
                    const nodeElement = document.getElementById(selectedNode.id);
                    if (nodeElement) {
                        nodeElement.classList.remove('selected');
                    }
                }
                selectedNode = null;
            }
        });
        
        /**
         * Select flow node
         */
        function selectFlowNode(nodeId) {
            // Remove previous selection
            document.querySelectorAll('.flow-node').forEach(n => n.classList.remove('selected'));
            
            // Select new node
            const nodeElement = document.getElementById(nodeId);
            if (nodeElement) {
                nodeElement.classList.add('selected');
                selectedNode = flowNodes.find(n => n.id === nodeId);
            }
        }
        
        /**
         * Edit flow node
         */
        window.editFlowNode = function(nodeId) {
            const node = flowNodes.find(n => n.id === nodeId);
            if (!node) return;
            
            // Use custom modal instead of prompt()
            const editModal = document.createElement('div');
            editModal.className = 'modal fade show';
            editModal.style.display = 'block';
            editModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
            // Check if this is a 'start' node - disable Step Type for start nodes
            const isStartNode = node.type === 'start';
            const nodeTypeSelected = node.type === 'message' ? 'selected' : '';
            const nodeQuestionSelected = node.type === 'question' ? 'selected' : '';
            const nodeApiCallSelected = node.type === 'api_call' ? 'selected' : '';
            const nodeWebhookSelected = node.type === 'webhook' ? 'selected' : '';
            const nodeStartSelected = node.type === 'start' ? 'selected' : '';
            const stepTypeDisabled = isStartNode ? 'disabled' : '';
            const stepTypeReadonly = isStartNode ? 'readonly' : '';
            
            // Get variable name from node data if it exists
            let variableName = '';
            if (node.data && node.data.variable_name) {
                variableName = node.data.variable_name;
            } else if (node.data && node.data.actions && node.data.actions.length > 0) {
                const saveAction = node.data.actions.find(a => a.type === 'save_answer');
                if (saveAction) {
                    variableName = saveAction.variable || '';
                }
            } else if (node.data && node.data.variables) {
                // Extract variable name from variables object
                const varKeys = Object.keys(node.data.variables);
                if (varKeys.length > 0) {
                    variableName = varKeys[0];
                }
            }
            
            editModal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content bg-dark border-secondary">
                        <div class="modal-header border-secondary">
                            <h5 class="modal-title text-white">Edit Flow Node</h5>
                            <button type="button" class="btn-close btn-close-white" id="closeEditNodeModal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label text-white">Step Type:</label>
                                <select class="form-select bg-dark text-white border-secondary" id="editNodeType" ${stepTypeDisabled}>
                                    ${isStartNode ? `<option value="start" ${nodeStartSelected}>Start</option>` : ''}
                                    <option value="message" ${nodeTypeSelected}>Message</option>
                                    <option value="question" ${nodeQuestionSelected}>Question</option>
                                    <option value="api_call" ${nodeApiCallSelected}>API Call</option>
                                    <option value="webhook" ${nodeWebhookSelected}>Webhook</option>
                                </select>
                                ${isStartNode ? '<small class="form-text text-muted"><i class="fas fa-info-circle"></i> Start node type cannot be changed</small>' : ''}
                            </div>
                            <div class="mb-3" id="editNodeContentContainer">
                                <label class="form-label text-white">Step Content:</label>
                                <textarea class="form-control bg-dark text-white border-secondary" id="editNodeContent" rows="3"></textarea>
                            </div>
                            <div class="mb-3" id="editNodeApiConfigMessage" style="display: ${node.type === 'api_call' || node.type === 'webhook' ? 'block' : 'none'};">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle"></i> 
                                    ${node.type === 'api_call' ? 'API Call configuration can be edited in Form View. Switch to Form View to configure API settings.' : 'Webhook configuration can be edited in Form View. Switch to Form View to configure webhook settings.'}
                                </div>
                            </div>
                            <div class="mb-3" id="editNodeVariableContainer" style="display: ${node.type === 'question' ? 'block' : 'none'};">
                                <label class="form-label text-white">
                                    <i class="fas fa-tag"></i> Save Answer to Variable:
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control bg-dark text-white border-secondary" 
                                    id="editNodeVariable" 
                                    placeholder="Variable name (e.g., user_name, email)"
                                >
                                <small class="form-text text-muted">Save user's answer to a variable for later use. Use in content with {variable_name}</small>
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" id="cancelEditNodeBtn">Cancel</button>
                            <button type="button" class="btn btn-primary" id="saveEditNodeBtn">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(editModal);
            
            // Set textarea value after modal is created to avoid template literal escaping issues
            const contentTextarea = editModal.querySelector('#editNodeContent');
            if (contentTextarea && node.content) {
                contentTextarea.value = node.content;
            }
            
            // Set variable input value
            const variableInput = editModal.querySelector('#editNodeVariable');
            if (variableInput && variableName) {
                variableInput.value = variableName;
            }
            
            // Show/hide variable field based on type selection
            const typeSelect = editModal.querySelector('#editNodeType');
            const variableContainer = editModal.querySelector('#editNodeVariableContainer');
            
            // Disable type selection for start nodes
            if (isStartNode) {
                typeSelect.disabled = true;
                typeSelect.style.cursor = 'not-allowed';
                typeSelect.style.opacity = '0.6';
            } else {
                const contentContainer = editModal.querySelector('#editNodeContentContainer');
                const apiConfigMessage = editModal.querySelector('#editNodeApiConfigMessage');
                
                typeSelect.addEventListener('change', function() {
                    if (this.value === 'question') {
                        variableContainer.style.display = 'block';
                        if (contentContainer) contentContainer.style.display = 'block';
                        if (apiConfigMessage) apiConfigMessage.style.display = 'none';
                    } else if (this.value === 'api_call' || this.value === 'webhook') {
                        variableContainer.style.display = 'none';
                        if (contentContainer) contentContainer.style.display = 'none';
                        if (apiConfigMessage) {
                            apiConfigMessage.style.display = 'block';
                            const messageText = apiConfigMessage.querySelector('.alert');
                            if (messageText) {
                                messageText.innerHTML = `<i class="fas fa-info-circle"></i> ${this.value === 'api_call' ? 'API Call' : 'Webhook'} configuration can be edited in Form View. Switch to Form View to configure ${this.value === 'api_call' ? 'API' : 'webhook'} settings.`;
                            }
                        }
                    } else {
                        variableContainer.style.display = 'none';
                        if (contentContainer) contentContainer.style.display = 'block';
                        if (apiConfigMessage) apiConfigMessage.style.display = 'none';
                    }
                    // Update content placeholder based on type
                    const contentTextarea = editModal.querySelector('#editNodeContent');
                    if (contentTextarea) {
                        if (this.value === 'question') {
                            contentTextarea.placeholder = 'Enter the question that your bot will ask users';
                        } else if (this.value === 'message') {
                            contentTextarea.placeholder = 'Enter the message content that your bot will send to users';
                        } else {
                            contentTextarea.placeholder = '';
                        }
                    }
                });
            }
            
            // Handle close button
            editModal.querySelector('#closeEditNodeModal').addEventListener('click', function() {
                editModal.remove();
            });
            
            // Handle cancel button
            editModal.querySelector('#cancelEditNodeBtn').addEventListener('click', function() {
                editModal.remove();
            });
            
            // Handle save button click
            const saveBtn = editModal.querySelector('#saveEditNodeBtn');
            saveBtn.addEventListener('click', function() {
                const type = document.getElementById('editNodeType').value;
                const content = document.getElementById('editNodeContent').value.trim();
                const variable = document.getElementById('editNodeVariable').value.trim();
                
                // Don't allow changing type for start nodes
                if (isStartNode) {
                    // Keep start type, only update content
                    node.type = 'start';
                } else if (['message', 'question', 'api_call', 'webhook'].includes(type)) {
                    node.type = type;
                }
                node.content = content;
                
                // Initialize node.data if it doesn't exist
                if (!node.data) {
                    node.data = {};
                }
                
                // Save variable information for question steps
                if (type === 'question' && variable) {
                    node.data.variable_name = variable;
                    node.data.variables = { [variable]: '{answer}' };
                    node.data.actions = [{
                        type: 'save_answer',
                        variable: variable
                    }];
                } else {
                    // Clear variable data if not a question or variable is empty
                    delete node.data.variable_name;
                    delete node.data.variables;
                    delete node.data.actions;
                }
                
                // Re-render node
                const nodeElement = document.getElementById(nodeId);
                if (nodeElement) {
                    nodeElement.remove();
                }
                renderFlowNode(node);
                drawFlowConnections();
                
                editModal.remove();
            });
        }
        
        /**
         * Delete flow node
         */
        function deleteFlowNode(nodeId) {
            if (confirm('Are you sure you want to delete this step?')) {
                flowNodes = flowNodes.filter(n => n.id !== nodeId);
                const nodeElement = document.getElementById(nodeId);
                if (nodeElement) {
                    nodeElement.remove();
                }
                drawFlowConnections();
            }
        }
        
        /**
         * Draw connections between nodes
         */
        function drawFlowConnections() {
            const svg = document.getElementById('flowConnections');
            svg.innerHTML = '<defs><marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto"><polygon points="0 0, 10 3, 0 6" fill="rgba(99, 199, 255, 0.6)" /></marker></defs>';
            
            // Draw line from start to first node
            const startNode = document.getElementById('flow-node-start');
            if (startNode && flowNodes.length > 0) {
                const startRect = startNode.getBoundingClientRect();
                const canvasRect = document.getElementById('flowCanvas').getBoundingClientRect();
                const firstNode = flowNodes[0];
                const firstNodeElement = document.getElementById(firstNode.id);
                
                if (firstNodeElement) {
                    const firstRect = firstNodeElement.getBoundingClientRect();
                    const x1 = startRect.left - canvasRect.left + startRect.width / 2;
                    const y1 = startRect.bottom - canvasRect.top;
                    const x2 = firstRect.left - canvasRect.left + firstRect.width / 2;
                    const y2 = firstRect.top - canvasRect.top;
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('class', 'flow-connection-line');
                    svg.appendChild(line);
                }
            }
            
            // Draw lines between flow nodes
            for (let i = 0; i < flowNodes.length - 1; i++) {
                const node1 = flowNodes[i];
                const node2 = flowNodes[i + 1];
                const node1Element = document.getElementById(node1.id);
                const node2Element = document.getElementById(node2.id);
                
                if (node1Element && node2Element) {
                    const canvasRect = document.getElementById('flowCanvas').getBoundingClientRect();
                    const rect1 = node1Element.getBoundingClientRect();
                    const rect2 = node2Element.getBoundingClientRect();
                    
                    const x1 = rect1.left - canvasRect.left + rect1.width / 2;
                    const y1 = rect1.bottom - canvasRect.top;
                    const x2 = rect2.left - canvasRect.left + rect2.width / 2;
                    const y2 = rect2.top - canvasRect.top;
                    
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('class', 'flow-connection-line');
                    svg.appendChild(line);
                }
            }
        }
        
        /**
         * Auto layout flow nodes
         */
        function autoLayoutFlow() {
            const canvas = document.getElementById('flowCanvas');
            const width = canvas.offsetWidth;
            const centerX = width / 2;
            
            flowNodes.forEach((node, index) => {
                node.x = centerX - 75;
                node.y = 150 + (index * 150);
                
                const nodeElement = document.getElementById(node.id);
                if (nodeElement) {
                    nodeElement.style.left = node.x + 'px';
                    nodeElement.style.top = node.y + 'px';
                }
            });
            
            drawFlowConnections();
        }
        
        /**
         * Sync flow to form view
         */
        function syncFlowToForm() {
            // Clear existing steps
            document.getElementById('stepsContainer').innerHTML = '';
            stepCount = 0;
            
            // Add steps from flow
            flowNodes.forEach((node, index) => {
                stepCount++;
                const stepId = 'step-' + stepCount;
                const stepsContainer = document.getElementById('stepsContainer');
                
                const stepCard = document.createElement('div');
                stepCard.className = 'card mb-3 step-card';
                stepCard.id = stepId;
                
                const typeSelectId = 'stepType-' + stepCount;
                const contentInputId = 'stepContent-' + stepCount;
                
                // Build HTML string with proper escaping
                const messageSelected = node.type === 'message' ? 'selected' : '';
                const questionSelected = node.type === 'question' ? 'selected' : '';
                
                // Enhanced escaping for template literal safety
                let nodeContent = '';
                try {
                    nodeContent = (node.content || '')
                        .replace(/\\/g, '\\\\')  // Escape backslashes first
                        .replace(/`/g, '\\`')    // Escape backticks
                        .replace(/\$/g, '\\$')   // Escape dollar signs
                        .replace(/\n/g, '\\n')   // Escape newlines
                        .replace(/\r/g, '\\r')   // Escape carriage returns
                        .replace(/"/g, '&quot;') // Escape double quotes for HTML
                        .replace(/'/g, '&#39;'); // Escape single quotes for HTML
                } catch (e) {
                    nodeContent = '';
                }
                
                // Get variable name from node data
                let variableValue = '';
                if (node.data && node.data.variable_name) {
                    variableValue = node.data.variable_name;
                } else if (node.data && node.data.actions && node.data.actions.length > 0) {
                    const saveAction = node.data.actions.find(a => a.type === 'save_answer');
                    if (saveAction) {
                        variableValue = saveAction.variable || '';
                    }
                } else if (node.data && node.data.variables) {
                    const varKeys = Object.keys(node.data.variables);
                    if (varKeys.length > 0) {
                        variableValue = varKeys[0];
                    }
                }
                
                // Escape variable value for HTML
                let escapedVariable = '';
                try {
                    escapedVariable = (variableValue || '')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                } catch (e) {
                    escapedVariable = '';
                }
                
                const variableFieldId = 'stepVariable-' + stepCount;
                const variableFieldHtml = node.type === 'question' ? `
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-tag"></i> Save Answer to Variable
                            </label>
                            <input 
                                type="text" 
                                class="form-control form-control-sm" 
                                id="${variableFieldId}"
                                placeholder="Variable name (e.g., user_name, email)"
                                value="${escapedVariable}"
                            >
                            <small class="form-text text-muted">Save user's answer to a variable for later use. Use in content with {variable_name}</small>
                        </div>
                ` : '';
                
                try {
                    stepCard.innerHTML = `
                    <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ol text-primary"></i> Step ${stepCount}
                        </h5>
                        <button type="button" class="btn btn-sm btn-outline-danger remove-step" onclick="removeStep('${stepId}')">
                            <i class="fas fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-tag"></i> Step Type
                            </label>
                            <select class="form-select step-type-select" id="${typeSelectId}" name="stepType[]" onchange="updateContentInput('${stepId}', '${typeSelectId}', '${contentInputId}')" required>
                                <option value="">-- Select Type --</option>
                                <option value="message" ${messageSelected}>Message</option>
                                <option value="question" ${questionSelected}>Question</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" for="${contentInputId}">
                                <i class="fas fa-comment"></i> Content
                            </label>
                            <textarea class="form-control step-content-input" id="${contentInputId}" name="stepContent[]" rows="3" required>${nodeContent}</textarea>
                        </div>
                        ${variableFieldHtml}
                    </div>
                `;
                } catch (e) {
                    console.error('Error setting stepCard innerHTML:', e);
                    throw e;
                }
                
                stepsContainer.appendChild(stepCard);
            });
            
            window.showAlertMessage('Flow synced to form view!', 'success');
            if (typeof window.switchToFormView === 'function') {
                window.switchToFormView();
            }
        }
        
        /**
         * Sync form to flow view
         */
        function syncFormToFlow() {
            flowNodes = [];
            flowNodeCounter = 0;
            
            const stepCards = document.querySelectorAll('.step-card');
            stepCards.forEach((card) => {
                const typeSelect = card.querySelector('.step-type-select');
                const contentInput = card.querySelector('.step-content-input');
                
                if (typeSelect && contentInput && typeSelect.value) {
                    flowNodeCounter++;
                    const nodeId = 'flow-node-' + flowNodeCounter;
                    
                    const node = {
                        id: nodeId,
                        type: typeSelect.value,
                        content: contentInput.value.trim(),
                        x: 200 + (flowNodes.length * 250),
                        y: 150 + (Math.floor(flowNodes.length / 3) * 200),
                        data: {}
                    };
                    
                    // Extract variable data for question steps
                    if (typeSelect.value === 'question') {
                        const stepIndex = card.getAttribute('data-step-index');
                        if (stepIndex !== null) {
                            const variableInput = document.getElementById(`stepVariable-${stepIndex}`);
                            if (variableInput && variableInput.value.trim()) {
                                const variableName = variableInput.value.trim();
                                node.data.variable_name = variableName;
                                node.data.variables = { [variableName]: '{answer}' };
                                node.data.actions = [{
                                    type: 'save_answer',
                                    variable: variableName
                                }];
                            }
                        }
                    }
                    
                    flowNodes.push(node);
                    renderFlowNode(node);
                }
            });
            
            drawFlowConnections();
        }
        
        /**
         * Load and display bot templates
         */
        window.loadTemplates = async function(platform = null) {
            const templateCards = document.getElementById('templateCards');
            if (!templateCards) return;
            
            try {
                let url = '/api/templates';
                if (platform && platform !== 'all') {
                    url += `?platform=${platform}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success && data.templates) {
                    templateCards.innerHTML = '';
                    
                    if (data.templates.length === 0) {
                        templateCards.innerHTML = '<div class="col-12"><p class="text-muted text-center">No templates found for this platform.</p></div>';
                        return;
                    }
                    
                    data.templates.forEach((template, index) => {
                        const col = document.createElement('div');
                        col.className = 'col-md-6 col-lg-4 mb-3 template-card';
                        col.setAttribute('data-platform', template.platform || 'general');
                        
                        // Platform badge
                        let platformBadge = '';
                        if (template.platform === 'telegram') {
                            platformBadge = '<span class="badge bg-secondary small"><i class="fab fa-telegram"></i> Telegram</span>';
                        } else if (template.platform === 'facebook') {
                            platformBadge = '<span class="badge bg-secondary small"><i class="fab fa-facebook"></i> Facebook</span>';
                        } else if (template.platform === 'youtube') {
                            platformBadge = '<span class="badge bg-secondary small"><i class="fab fa-youtube"></i> YouTube</span>';
                        } else if (template.platform === 'tiktok') {
                            platformBadge = '<span class="badge bg-secondary small"><i class="fab fa-tiktok"></i> TikTok</span>';
                        } else {
                            platformBadge = '<span class="badge bg-secondary small">General</span>';
                        }
                        
                        // Integration guide
                        let integrationGuide = '';
                        if (template.integration_guide) {
                            const guideId = `integrationGuide${template.id}${index}`;
                            integrationGuide = `
                                <div class="mb-2">
                                    <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="collapse" data-bs-target="#${guideId}" aria-expanded="false">
                                        <i class="fas fa-info-circle"></i> Integration Guide
                                    </button>
                                    <div class="collapse mt-2" id="${guideId}">
                                        <div class="card card-body bg-secondary text-white small" style="font-size: 0.85rem; white-space: pre-line;">${escapeHtml(template.integration_guide)}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Platform colors
                        let platformColor = '#63C7FF';
                        let platformGradient = 'linear-gradient(135deg, #63C7FF 0%, #A855F7 100%)';
                        let badgeStyle = 'background: rgba(99, 199, 255, 0.2); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.4);';
                        
                        if (template.platform === 'telegram') {
                            platformColor = '#0088cc';
                            platformGradient = 'linear-gradient(135deg, #0088cc 0%, #229ED9 100%)';
                            badgeStyle = 'background: rgba(0, 136, 204, 0.2); color: #0088cc; border: 1px solid rgba(0, 136, 204, 0.4);';
                        } else if (template.platform === 'facebook') {
                            platformColor = '#0078FF';
                            platformGradient = 'linear-gradient(135deg, #0078FF 0%, #1877F2 100%)';
                            badgeStyle = 'background: rgba(0, 120, 255, 0.2); color: #0078FF; border: 1px solid rgba(0, 120, 255, 0.4);';
                        } else if (template.platform === 'youtube') {
                            platformColor = '#FF0000';
                            platformGradient = 'linear-gradient(135deg, #FF0000 0%, #FF4444 100%)';
                            badgeStyle = 'background: rgba(255, 0, 0, 0.2); color: #FF0000; border: 1px solid rgba(255, 0, 0, 0.4);';
                        } else if (template.platform === 'tiktok') {
                            platformColor = '#000000';
                            platformGradient = 'linear-gradient(135deg, #000000 0%, #333333 100%)';
                            badgeStyle = 'background: rgba(0, 0, 0, 0.3); color: #FFFFFF; border: 1px solid rgba(255, 255, 255, 0.2);';
                        }
                        
                        // Platform accent color
                        let accentGradient = platformGradient;
                        if (template.platform === 'telegram') accentGradient = 'linear-gradient(90deg, #0088cc 0%, #229ED9 100%)';
                        else if (template.platform === 'facebook') accentGradient = 'linear-gradient(90deg, #0078FF 0%, #1877F2 100%)';
                        else if (template.platform === 'youtube') accentGradient = 'linear-gradient(90deg, #FF0000 0%, #FF4444 100%)';
                        else if (template.platform === 'tiktok') accentGradient = 'linear-gradient(90deg, #000000 0%, #333333 100%)';
                        else accentGradient = 'linear-gradient(90deg, #63C7FF 0%, #A855F7 100%)';
                        
                        // Image section background gradient
                        let imageBgGradient = 'linear-gradient(135deg, rgba(99, 199, 255, 0.2) 0%, rgba(168, 85, 247, 0.1) 100%)';
                        let iconGradient = 'linear-gradient(135deg, #63C7FF 0%, #A855F7 100%)';
                        let badgeBg = 'rgba(99, 199, 255, 0.9)';
                        let badgeColor = 'white';
                        let badgeBorder = 'rgba(99, 199, 255, 1)';
                        let iconClass = 'fas fa-robot';
                        
                        if (template.platform === 'telegram') {
                            imageBgGradient = 'linear-gradient(135deg, rgba(0, 136, 204, 0.2) 0%, rgba(34, 158, 217, 0.1) 100%)';
                            iconGradient = 'linear-gradient(135deg, #0088cc 0%, #229ED9 100%)';
                            badgeBg = 'rgba(0, 136, 204, 0.9)';
                            badgeColor = 'white';
                            badgeBorder = 'rgba(0, 136, 204, 1)';
                            iconClass = 'fab fa-telegram';
                        } else if (template.platform === 'facebook') {
                            imageBgGradient = 'linear-gradient(135deg, rgba(0, 120, 255, 0.2) 0%, rgba(24, 119, 242, 0.1) 100%)';
                            iconGradient = 'linear-gradient(135deg, #0078FF 0%, #1877F2 100%)';
                            badgeBg = 'rgba(0, 120, 255, 0.9)';
                            badgeColor = 'white';
                            badgeBorder = 'rgba(0, 120, 255, 1)';
                            iconClass = 'fab fa-facebook';
                        } else if (template.platform === 'youtube') {
                            imageBgGradient = 'linear-gradient(135deg, rgba(255, 0, 0, 0.2) 0%, rgba(255, 68, 68, 0.1) 100%)';
                            iconGradient = 'linear-gradient(135deg, #FF0000 0%, #FF4444 100%)';
                            badgeBg = 'rgba(255, 0, 0, 0.9)';
                            badgeColor = 'white';
                            badgeBorder = 'rgba(255, 0, 0, 1)';
                            iconClass = 'fab fa-youtube';
                        } else if (template.platform === 'tiktok') {
                            imageBgGradient = 'linear-gradient(135deg, rgba(0, 0, 0, 0.3) 0%, rgba(51, 51, 51, 0.2) 100%)';
                            iconGradient = 'linear-gradient(135deg, #000000 0%, #333333 100%)';
                            badgeBg = 'rgba(0, 0, 0, 0.9)';
                            badgeColor = 'white';
                            badgeBorder = 'rgba(255, 255, 255, 0.3)';
                            iconClass = 'fab fa-tiktok';
                        }
                        
                        col.innerHTML = `
                            <div class="card template-card-modern h-100" style="background: linear-gradient(135deg, rgba(14, 18, 31, 0.95) 0%, rgba(26, 31, 53, 0.95) 100%); border: 1px solid rgba(99, 199, 255, 0.2); border-radius: 15px; transition: all 0.3s ease; overflow: hidden; position: relative;">
                                <div class="template-platform-accent" style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: ${accentGradient};"></div>
                                
                                <!-- Template Image/Icon Section -->
                                <div class="template-image-section" style="height: 180px; background: ${imageBgGradient}; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;">
                                    <div style="width: 100px; height: 100px; border-radius: 20px; background: ${iconGradient}; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                        <i class="${iconClass}" style="font-size: 50px; color: white;"></i>
                                    </div>
                                    <span class="badge" style="position: absolute; top: 10px; right: 10px; background: ${badgeBg}; color: ${badgeColor}; border: 1px solid ${badgeBorder}; font-size: 0.7rem; padding: 4px 8px; border-radius: 6px; font-weight: 600; backdrop-filter: blur(10px);">
                                        ${template.platform === 'telegram' ? '<i class="fab fa-telegram"></i> Telegram' : 
                                          template.platform === 'facebook' ? '<i class="fab fa-facebook"></i> Facebook' :
                                          template.platform === 'youtube' ? '<i class="fab fa-youtube"></i> YouTube' :
                                          template.platform === 'tiktok' ? '<i class="fab fa-tiktok"></i> TikTok' :
                                          '<i class="fas fa-robot"></i> General'}
                                    </span>
                                </div>
                                
                                <div class="card-body" style="padding: 20px;">
                                    <div class="mb-3">
                                        <h6 class="card-title mb-1" style="color: #F0F4F8; font-weight: 600; font-size: 1.1rem; line-height: 1.3;">
                                            ${escapeHtml(template.name)}
                                        </h6>
                                    </div>
                                    <p class="card-text mb-3" style="color: rgba(240, 244, 248, 0.7); font-size: 0.875rem; line-height: 1.5; min-height: 50px;">${escapeHtml(template.description)}</p>
                                    ${integrationGuide}
                                    <div class="d-flex gap-2 mt-auto">
                                        <button type="button" class="btn btn-sm flex-fill" onclick="window.loadTemplate('${template.id}')" ${!canEditBots ? 'disabled title="Viewer role များအတွက် Template load လုပ်ခွင့်မရှိပါ"' : ''} style="background: rgba(99, 199, 255, 0.1); color: #63C7FF; border: 1px solid rgba(99, 199, 255, 0.3); border-radius: 8px; padding: 8px 12px; font-weight: 500; transition: all 0.3s ease;" onmouseover="this.style.background='rgba(99, 199, 255, 0.2)'; this.style.borderColor='rgba(99, 199, 255, 0.5)';" onmouseout="this.style.background='rgba(99, 199, 255, 0.1)'; this.style.borderColor='rgba(99, 199, 255, 0.3)';">
                                            <i class="fas fa-download"></i> Load
                                        </button>
                                        <button type="button" class="btn btn-sm flex-fill" onclick="window.useTemplate('${template.id}')" ${!canEditBots ? 'disabled title="Viewer role များအတွက် Template သုံးခွင့်မရှိပါ"' : ''} style="background: ${platformGradient}; color: white; border: none; border-radius: 8px; padding: 8px 12px; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,0,0,0.2)';">
                                            <i class="fas fa-magic"></i> Create
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        templateCards.appendChild(col);
                    });
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                if (templateCards) {
                    templateCards.innerHTML = '<div class="col-12"><p class="text-danger text-center">Error loading templates. Please try again.</p></div>';
                }
            }
        };
        
        /**
         * Filter templates by platform
         */
        window.filterTemplatesByPlatform = function(platform) {
            // Update button states
            const filterButtons = document.querySelectorAll('#platformFilter button');
            filterButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-platform') === platform) {
                    btn.classList.add('active');
                }
            });
            
            // Filter template cards
            const templateCards = document.querySelectorAll('.template-card');
            templateCards.forEach(card => {
                const cardPlatform = card.getAttribute('data-platform');
                if (platform === 'all' || cardPlatform === platform) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Also reload from API if needed (for dynamic loading)
            if (platform !== 'all') {
                window.loadTemplates(platform);
            } else {
                window.loadTemplates();
            }
        };
        
        // useTemplate is already defined in the head section
        
        // ========== Bot Versioning Functions ==========
        
        /**
         * Shared function to collect all step data from form or flow view
         */
        function collectAllSteps() {
            const steps = [];
            const stepCards = document.querySelectorAll('.step-card');
            
            // If no step cards found, try collecting from flow nodes
            if (stepCards.length === 0 && typeof flowNodes !== 'undefined' && flowNodes.length > 0) {
                flowNodes.forEach((node) => {
                    if (node.type && node.content) {
                        const stepData = {
                            type: node.type,
                            content: node.content
                        };
                        
                        // Add variable data if it exists
                        if (node.data && node.data.variable_name) {
                            stepData.variables = { [node.data.variable_name]: '{answer}' };
                            stepData.actions = [{
                                type: 'save_answer',
                                variable: node.data.variable_name
                            }];
                        } else if (node.data && node.data.actions && node.data.actions.length > 0) {
                            const saveAction = node.data.actions.find(a => a.type === 'save_answer');
                            if (saveAction) {
                                stepData.variables = { [saveAction.variable]: '{answer}' };
                                stepData.actions = [{
                                    type: 'save_answer',
                                    variable: saveAction.variable
                                }];
                            }
                        } else if (node.data && node.data.variables) {
                            stepData.variables = node.data.variables;
                            const varKeys = Object.keys(node.data.variables);
                            if (varKeys.length > 0) {
                                stepData.actions = [{
                                    type: 'save_answer',
                                    variable: varKeys[0]
                                }];
                            }
                        }
                        
                        steps.push(stepData);
                    }
                });
                
                return steps;
            }
            
            stepCards.forEach((card) => {
                const stepId = card.id;
                const stepNumber = stepId.replace('step-', '');
                const typeSelect = card.querySelector('.step-type-select');
                const contentInput = card.querySelector('.step-content-input');
                const triggersInput = document.getElementById(`stepTriggers-${stepNumber}`);
                const variableInput = document.getElementById(`stepVariable-${stepNumber}`);
                const conditionSelect = document.getElementById(`stepCondition-${stepNumber}`);
                const conditionValue = document.getElementById(`stepConditionValue-${stepNumber}`);
                
                // API configuration fields
                const apiUrlInput = document.getElementById(`apiUrl-${stepNumber}`);
                const apiMethodSelect = document.getElementById(`apiMethod-${stepNumber}`);
                const apiHeadersInput = document.getElementById(`apiHeaders-${stepNumber}`);
                const apiBodyInput = document.getElementById(`apiBody-${stepNumber}`);
                const apiResponseTemplateInput = document.getElementById(`apiResponseTemplate-${stepNumber}`);
                
                const stepType = typeSelect ? typeSelect.value : '';
                
                // Validate based on step type
                let isValid = false;
                if (stepType === 'api_call' || stepType === 'webhook') {
                    isValid = apiUrlInput && apiUrlInput.value.trim();
                } else {
                    isValid = contentInput && contentInput.value.trim();
                }
                
                if (typeSelect && stepType && isValid) {
                    const stepData = { type: stepType };
                    
                    // Add content for message/question types
                    if (stepType === 'message' || stepType === 'question') {
                        stepData.content = contentInput.value.trim();
                    }
                    
                    // Add API configuration for API call type
                    if (stepType === 'api_call') {
                        stepData.api_config = {
                            url: apiUrlInput ? apiUrlInput.value.trim() : '',
                            method: apiMethodSelect ? apiMethodSelect.value : 'POST',
                            headers: apiHeadersInput ? apiHeadersInput.value.trim() : '{}',
                            body: apiBodyInput ? apiBodyInput.value.trim() : '{}',
                            response_template: apiResponseTemplateInput ? apiResponseTemplateInput.value.trim() : 'API call completed successfully.'
                        };
                    }
                    
                    // Add webhook configuration for webhook type
                    if (stepType === 'webhook') {
                        stepData.webhook_config = {
                            url: apiUrlInput ? apiUrlInput.value.trim() : '',
                            method: apiMethodSelect ? apiMethodSelect.value : 'POST',
                            headers: apiHeadersInput ? apiHeadersInput.value.trim() : '{}',
                            body: apiBodyInput ? apiBodyInput.value.trim() : '{}',
                            response_template: apiResponseTemplateInput ? apiResponseTemplateInput.value.trim() : 'Webhook triggered successfully.'
                        };
                    }
                    
                    // Add triggers if provided
                    if (triggersInput && triggersInput.value.trim()) {
                        const triggers = triggersInput.value.split(',').map(t => t.trim()).filter(t => t);
                        if (triggers.length > 0) {
                            stepData.triggers = triggers;
                        }
                    }
                    
                    // Add variable if provided (for questions)
                    if (variableInput && variableInput.value.trim()) {
                        stepData.variables = { [variableInput.value.trim()]: '{answer}' };
                        stepData.actions = [{
                            type: 'save_answer',
                            variable: variableInput.value.trim()
                        }];
                    }
                    
                    // Add condition if provided
                    if (conditionSelect && conditionSelect.value) {
                        const conditionType = conditionSelect.value;
                        if (conditionValue && conditionValue.value.trim()) {
                            if (conditionType === 'variable_equals') {
                                const parts = conditionValue.value.split('=');
                                if (parts.length === 2) {
                                    stepData.condition = {
                                        type: conditionType,
                                        variable: parts[0].trim(),
                                        value: parts[1].trim()
                                    };
                                }
                            } else if (conditionType === 'step_completed') {
                                const stepIndex = parseInt(conditionValue.value);
                                if (!isNaN(stepIndex)) {
                                    stepData.condition = {
                                        type: conditionType,
                                        step_index: stepIndex
                                    };
                                }
                            } else if (conditionType === 'contains_keyword') {
                                const keywords = conditionValue.value.split(',').map(k => k.trim()).filter(k => k);
                                if (keywords.length > 0) {
                                    stepData.condition = {
                                        type: conditionType,
                                        keywords: keywords
                                    };
                                }
                            }
                        } else {
                            stepData.condition = { type: 'always' };
                        }
                    }
                    
                    steps.push(stepData);
                }
            });
            
            return steps;
        }
        
        /**
         * Save and publish bot
         */
        window.saveAndPublish = function() {
            const botName = document.getElementById('botName')?.value.trim() || '';
            const initialGreeting = document.getElementById('initialGreeting')?.value.trim() || '';
            
            if (!botName || !initialGreeting) {
                alert('Please fill in bot name and initial greeting first');
                return;
            }
            
            // Collect all steps using shared function
            const steps = collectAllSteps();
            
            const requestData = {
                botName: botName,
                initialGreeting: initialGreeting,
                stepsJson: JSON.stringify(steps),
                publish: true
            };
            
            // Show loading state
            const saveBtn = document.querySelector('button[onclick*="saveAndPublish"]');
            const originalBtnText = saveBtn ? saveBtn.innerHTML : '';
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
            }
            
            fetch('{{ url_for("save_bot") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalBtnText;
                }
                
                if (data.success) {
                    window.showAlertMessage(data.message || 'Bot saved and published successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    window.showAlertMessage(data.error || 'Failed to publish bot', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalBtnText;
                }
                window.showAlertMessage('Error publishing bot: ' + error.message, 'error');
            });
        };
        
        /**
         * Publish bot (from Bot Builder)
         */
        window.publishBot = async function() {
            const botNameInput = document.getElementById('botName');
            if (!botNameInput || !botNameInput.value.trim()) {
                window.showAlertMessage('Please enter a bot name first', 'error');
                return;
            }
            
            const botName = botNameInput.value.trim();
            if (!confirm(`Publish "${botName}"? This will make it live.`)) {
                return;
            }
            
            try {
                const publishBtn = document.getElementById('publishBotBtn');
                const originalBtnText = publishBtn.innerHTML;
                publishBtn.disabled = true;
                publishBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
                
                // First save as draft, then publish
                const steps = collectAllSteps();
                const formData = {
                    botName: botName,
                    initialGreeting: document.getElementById('initialGreeting').value,
                    stepsJson: JSON.stringify(steps),
                    publish: true
                };
                
                const response = await fetch('{{ url_for("save_bot") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                publishBtn.disabled = false;
                publishBtn.innerHTML = originalBtnText;
                
                if (data.success) {
                    window.showAlertMessage(data.message || `Bot "${botName}" published successfully!`, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    window.showAlertMessage(data.error || 'Failed to publish bot', 'error');
                }
            } catch (error) {
                console.error('Error publishing bot:', error);
                const publishBtn = document.getElementById('publishBotBtn');
                if (publishBtn) {
                    publishBtn.disabled = false;
                    publishBtn.innerHTML = '<i class="fas fa-rocket"></i> Publish';
                }
                window.showAlertMessage('Error publishing bot: ' + error.message, 'error');
            }
        };
        
        /**
         * Publish draft version
         */
        window.publishDraft = async function(botName) {
            if (!confirm(`Publish draft version of "${botName}"? This will make it live.`)) {
                return;
            }
            
            try {
                const encodedBotName = encodeURIComponent(botName);
                const response = await fetch(`/api/bot/${encodedBotName}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success) {
                    window.showAlertMessage(data.message || 'Draft published successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    window.showAlertMessage(data.error || 'Failed to publish draft', 'error');
                }
            } catch (error) {
                console.error('Error publishing draft:', error);
                window.showAlertMessage('Error publishing draft: ' + error.message, 'error');
            }
        };
        
        /**
         * Test draft version
         */
        window.testDraft = function(botName) {
            const testWindow = window.open('', 'testDraft', 'width=600,height=700');
            if (!testWindow) {
                alert('Please allow popups to test the draft');
                return;
            }
            
            testWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Test Draft: ${botName}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; background: #1A233A; color: #F0F4F8; }
                        .chat-container { max-width: 500px; margin: 0 auto; }
                        .chat-messages { height: 400px; overflow-y: auto; border: 1px solid #3B5D9A; padding: 15px; margin-bottom: 15px; background: #0E121F; border-radius: 10px; }
                        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
                        .user { background: #3B5D9A; text-align: right; }
                        .bot { background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%); }
                        .input-group { display: flex; gap: 10px; }
                        input { flex: 1; padding: 10px; border: 1px solid rgba(99, 199, 255, 0.3); background: #0E121F; color: #F0F4F8; border-radius: 5px; }
                        button { padding: 10px 20px; background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%); color: white; border: none; border-radius: 5px; cursor: pointer; box-shadow: 0 4px 15px rgba(99, 199, 255, 0.4); }
                        button:hover { background: linear-gradient(135deg, #A855F7 0%, #63C7FF 100%); box-shadow: 0 6px 25px rgba(99, 199, 255, 0.6); }
                    </style>
                </head>
                <body>
                    <div class="chat-container">
                        <h2>Testing Draft: ${botName}</h2>
                        <div class="chat-messages" id="messages"></div>
                        <div class="input-group">
                            <input type="text" id="userInput" placeholder="Type your message...">
                            <button onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                    <scr' + 'ipt>
                        let sessionData = {};
                        let sessionId = 'test_' + Date.now();
                        
                        function addMessage(text, type) {
                            const messages = document.getElementById('messages');
                            const div = document.createElement('div');
                            div.className = 'message ' + type;
                            div.textContent = text;
                            messages.appendChild(div);
                            messages.scrollTop = messages.scrollHeight;
                        }
                        
                        async function sendMessage() {
                            const input = document.getElementById('userInput');
                            const message = input.value.trim();
                            if (!message) return;
                            
                            addMessage(message, 'user');
                            input.value = '';
                            
                            try {
                                const response = await fetch('/api/bot/${encodeURIComponent(botName)}/test-draft', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        user_message: message,
                                        session_data: sessionData,
                                        session_id: sessionId
                                    })
                                });
                                
                                const data = await response.json();
                                if (data.success) {
                                    sessionData = data.session_data || {};
                                    addMessage(data.bot_response, 'bot');
                                } else {
                                    addMessage('Error: ' + (data.error || 'Unknown error'), 'bot');
                                }
                            } catch (error) {
                                addMessage('Error: ' + error.message, 'bot');
                            }
                        }
                        
                        document.getElementById('userInput').addEventListener('keypress', function(e) {
                            if (e.key === 'Enter') sendMessage();
                        });
                    </scr' + 'ipt>
                </body>
                </html>
            `);
        };
        
        /**
         * Show version history
         */
        window.showVersionHistory = async function(botName) {
            try {
                const encodedBotName = encodeURIComponent(botName);
                const response = await fetch(`/api/bot/${encodedBotName}/versions`);
                const data = await response.json();
                
                if (!data.success) {
                    window.showAlertMessage(data.error || 'Failed to load version history', 'error');
                    return;
                }
                
                const versions = data.versions || [];
                const liveVersion = data.live_version;
                const draftVersion = data.draft_version;
                
                let html = '<div class="version-history"><h5>Version History: ' + botName + '</h5>';
                html += '<table class="table table-dark"><thead><tr><th>Version</th><th>Status</th><th>Updated</th><th>Actions</th></tr></thead><tbody>';
                
                versions.forEach(v => {
                    const isLive = v.version_number === liveVersion;
                    const isDraft = v.version_number === draftVersion;
                    html += '<tr>';
                    html += '<td>v' + v.version_number + '</td>';
                    html += '<td>';
                    if (isLive) html += '<span class="badge bg-success">Live</span> ';
                    if (isDraft) html += '<span class="badge bg-warning">Draft</span>';
                    if (!isLive && !isDraft) html += '<span class="badge bg-secondary">Archived</span>';
                    html += '</td>';
                    html += '<td>' + (v.updated_at || v.created_at || 'N/A') + '</td>';
                    html += '<td>';
                    if (!isLive && (window.canEditBots || false)) {
                        html += '<button class="btn btn-sm btn-primary" onclick="window.switchToVersion(\'' + botName.replace(/'/g, "\\'") + '\', ' + v.version_number + ')">Switch to This</button>';
                    }
                    html += '</td>';
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content" style="background-color: #1A233A; color: #F0F4F8;">
                            <div class="modal-header">
                                <h5 class="modal-title">Version History</h5>
                                <button type="button" class="btn-close btn-close-white" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body">${html}</div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading version history:', error);
                window.showAlertMessage('Error loading version history: ' + error.message, 'error');
            }
        };
        
        /**
         * Switch to a specific version
         */
        window.switchToVersion = async function(botName, versionNumber) {
            if (!confirm(`Switch to version ${versionNumber}? This will make it the live version.`)) {
                return;
            }
            
            try {
                const encodedBotName = encodeURIComponent(botName);
                const response = await fetch(`/api/bot/${encodedBotName}/switch-version/${versionNumber}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                if (data.success) {
                    window.showAlertMessage(data.message || 'Version switched successfully!', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    window.showAlertMessage(data.error || 'Failed to switch version', 'error');
                }
            } catch (error) {
                console.error('Error switching version:', error);
                window.showAlertMessage('Error switching version: ' + error.message, 'error');
            }
        };
        
        // Gemini Chat Functions
        let geminiConversationHistory = [];
        
        window.sendGeminiMessage = async function() {
            const input = document.getElementById('geminiChatInput');
            const sendBtn = document.getElementById('geminiSendBtn');
            const messagesDiv = document.getElementById('geminiChatMessages');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input and button
            input.disabled = true;
            sendBtn.disabled = true;
            
            // Add user message to chat
            addGeminiMessage(message, 'user');
            input.value = '';
            
            // Show loading indicator
            const loadingId = 'loading-' + Date.now();
            addGeminiMessage('Thinking...', 'assistant', loadingId);
            
            try {
                const response = await fetch('/api/gemini/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: geminiConversationHistory,
                        stream: false
                    })
                });
                
                const data = await response.json();
                
                // Remove loading message
                const loadingMsg = document.getElementById(loadingId);
                if (loadingMsg) loadingMsg.remove();
                
                if (data.success) {
                    addGeminiMessage(data.response, 'assistant');
                    // Update conversation history
                    geminiConversationHistory.push(
                        {role: 'user', content: message},
                        {role: 'assistant', content: data.response}
                    );
                } else {
                    addGeminiMessage('Error: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                const loadingMsg = document.getElementById(loadingId);
                if (loadingMsg) loadingMsg.remove();
                addGeminiMessage('Error: ' + error.message, 'error');
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        };
        
        function addGeminiMessage(text, type, id) {
            const messagesDiv = document.getElementById('geminiChatMessages');
            if (!messagesDiv) return;
            
            // Remove empty state if exists
            const emptyState = messagesDiv.querySelector('.text-center.text-muted');
            if (emptyState) emptyState.remove();
            
            const messageDiv = document.createElement('div');
            if (id) messageDiv.id = id;
            messageDiv.style.cssText = `
                margin-bottom: 15px;
                padding: 12px 15px;
                border-radius: 12px;
                max-width: 80%;
                word-wrap: break-word;
                ${type === 'user' 
                    ? 'background: linear-gradient(135deg, #63C7FF 0%, #A855F7 100%); color: white; margin-left: auto; text-align: right;' 
                    : type === 'error'
                    ? 'background: rgba(239, 68, 68, 0.2); color: #ff6b6b; border: 1px solid rgba(239, 68, 68, 0.5);'
                    : 'background: rgba(99, 199, 255, 0.15); color: #F0F4F8; border: 1px solid rgba(99, 199, 255, 0.3);'
                }
            `;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        window.clearGeminiChat = function() {
            if (confirm('Clear chat history?')) {
                geminiConversationHistory = [];
                const messagesDiv = document.getElementById('geminiChatMessages');
                if (messagesDiv) {
                    messagesDiv.innerHTML = `
                        <div class="text-center text-muted">
                            <i class="fas fa-robot" style="font-size: 3rem; opacity: 0.3; margin-bottom: 15px;"></i>
                            <p>Start a conversation with Gemini AI!</p>
                            <small>Ask questions, get advice, or discuss any topic.</small>
                        </div>
                    `;
                }
            }
        };
        
        // Update chat empty state message based on bot name
        function updateChatEmptyStateMessage() {
            const chatEmptyStateMessage = document.getElementById('chatEmptyStateMessage');
            if (!chatEmptyStateMessage) return;
            
            const botNameInput = document.getElementById('botName');
            const botNameFlowViewInput = document.getElementById('botNameFlowView');
            const botName = (botNameInput && botNameInput.value.trim()) || 
                          (botNameFlowViewInput && botNameFlowViewInput.value.trim()) || '';
            
            if (botName) {
                chatEmptyStateMessage.textContent = 'Ready to test! Type a message below.';
            } else {
                chatEmptyStateMessage.textContent = 'Enter your bot name above first';
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load templates if template section exists
            if (document.getElementById('templateCards')) {
                window.loadTemplates();
            }
            
            // Monitor bot name inputs for changes
            const botNameInput = document.getElementById('botName');
            const botNameFlowViewInput = document.getElementById('botNameFlowView');
            
            if (botNameInput) {
                botNameInput.addEventListener('input', updateChatEmptyStateMessage);
                botNameInput.addEventListener('change', updateChatEmptyStateMessage);
            }
            if (botNameFlowViewInput) {
                botNameFlowViewInput.addEventListener('input', updateChatEmptyStateMessage);
                botNameFlowViewInput.addEventListener('change', updateChatEmptyStateMessage);
            }
            
            // Initial update
            updateChatEmptyStateMessage();
            
            // Initialize chat widget
            const chatInput = document.getElementById('chatInput');
            const chatWidget = document.getElementById('chatWidget');
            const showBtn = document.getElementById('chatWidgetShowBtn');
            
            // Hide show button if chat widget is visible
            if (chatWidget && showBtn) {
                if (chatWidget.classList.contains('hidden')) {
                    showBtn.style.display = 'flex';
                } else {
                    showBtn.style.display = 'none';
                }
            }
            
            if (chatInput && chatWidget && !chatWidget.classList.contains('minimized') && !chatWidget.classList.contains('hidden')) {
                chatInput.focus();
            }
            
            // Initialize flow canvas event listeners
            const flowCanvas = document.getElementById('flowCanvas');
            if (flowCanvas) {
                // Prevent default drag behavior on canvas
                flowCanvas.addEventListener('dragover', function(e) {
                    e.preventDefault();
                });
                
                // Handle canvas click to deselect nodes
                flowCanvas.addEventListener('click', function(e) {
                    if (e.target === flowCanvas || e.target.id === 'flowConnections') {
                        if (selectedNode) {
                            const nodeElement = document.getElementById(selectedNode.id);
                            if (nodeElement) {
                                nodeElement.classList.remove('selected');
                            }
                            selectedNode = null;
                        }
                    }
                });
            }
            
            // Load existing bot data if editing
            {% if bot_data %}
            loadExistingBotData();
            {% endif %}
        });
    </script>
</body>
</html>
